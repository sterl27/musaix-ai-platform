(()=>{(function(){"use strict";function c(){typeof window.markdownit=="function"?(window.aipkit_md=window.markdownit({html:!1,xhtmlOut:!1,breaks:!0,langPrefix:"language-",linkify:!0,typographer:!0,quotes:"\u201C\u201D\u2018\u2019"}),window.hljs&&typeof window.markdownitHighlight=="function"&&window.aipkit_md.use(window.markdownitHighlight,{hljs:window.hljs})):(console.error("AIPKit Chat Markdown: markdown-it library not found. Markdown parsing will be basic."),window.aipkit_md={render:function(n){return console.warn("AIPKit Chat Markdown: Using fallback markdown renderer."),(window.aipkit_escapeHtml||function(i){return typeof i!="string"?"":i.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")})(n).replace(/\n/g,"<br>")}})}window.aipkit_initializeMarkdownParser=c})();(function(){"use strict";function c(e){return e===null||typeof e>"u"?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function n(e){return c(e)}window.aipkit_escapeHtml=c,window.aipkit_escapeAttribute=n})();(function(){"use strict";function c(n){let e=Number(n);if(!e||isNaN(e))return"";try{let i=new Date(e*1e3);if(isNaN(i.getTime()))return"";let o=String(i.getHours()).padStart(2,"0"),t=String(i.getMinutes()).padStart(2,"0"),r=String(i.getSeconds()).padStart(2,"0");return`${o}:${t}:${r}`}catch(i){return console.error("Error formatting timestamp:",n,i),""}}window.aipkit_formatTimestamp=c})();(function(){"use strict";function c(n,e={},i={}){return new Promise((o,t)=>{if(!i.ajaxUrl)return t(new Error("AIPKit Frontend AJAX: ajaxUrl missing in config."));let r=new FormData;r.append("action",n),i.nonce?r.append("_ajax_nonce",i.nonce):console.warn(`AIPKit Frontend AJAX: Nonce not found in config for action "${n}".`),i.botId&&r.append("bot_id",i.botId),window.aipkit_guest_uuid&&r.append("session_id",window.aipkit_guest_uuid),window.aipkit_current_conversation_uuid&&r.append("conversation_uuid",window.aipkit_current_conversation_uuid),window.aipkit_current_post_id&&r.append("post_id",window.aipkit_current_post_id),i.provider==="OpenAI"&&i.enableOpenAIConversationState&&window.aipkit_current_openai_response_id&&r.append("previous_openai_response_id",window.aipkit_current_openai_response_id),e.frontend_web_search_active===!0&&r.append("frontend_web_search_active","true"),e.frontend_google_search_grounding_active===!0&&r.append("frontend_google_search_grounding_active","true"),i.activeFileContext?(i.activeFileContext.provider==="OpenAI"&&i.activeFileContext.vector_store_id&&r.append("active_openai_vs_id",i.activeFileContext.vector_store_id),i.activeFileContext.provider==="Pinecone"&&i.activeFileContext.index_name&&i.activeFileContext.namespace&&(r.append("active_pinecone_index_name",i.activeFileContext.index_name),r.append("active_pinecone_namespace",i.activeFileContext.namespace)),i.activeFileContext.provider==="Qdrant"&&i.activeFileContext.collection_name&&i.activeFileContext.file_upload_context_id&&(r.append("active_qdrant_collection_name",i.activeFileContext.collection_name),r.append("active_qdrant_file_upload_context_id",i.activeFileContext.file_upload_context_id))):e.active_openai_vs_id?console.log(`AIPKit frontendApiRequest: Sending active_openai_vs_id from data object: ${e.active_openai_vs_id}`):e.active_pinecone_index_name&&e.active_pinecone_namespace?console.log(`AIPKit frontendApiRequest: Sending Pinecone context from data object: Index: ${e.active_pinecone_index_name}, Namespace: ${e.active_pinecone_namespace}`):e.active_qdrant_collection_name&&e.active_qdrant_file_upload_context_id&&console.log(`AIPKit frontendApiRequest: Sending Qdrant context from data object: Collection: ${e.active_qdrant_collection_name}, File Context ID: ${e.active_qdrant_file_upload_context_id}`);for(let a in e)Object.prototype.hasOwnProperty.call(e,a)&&a!=="frontend_web_search_active"&&a!=="frontend_google_search_grounding_active"&&a!=="active_openai_vs_id"&&a!=="active_pinecone_index_name"&&a!=="active_pinecone_namespace"&&a!=="active_qdrant_collection_name"&&a!=="active_qdrant_file_upload_context_id"&&(a==="audio_file"&&e[a]instanceof Blob?r.append(a,e[a],"speech."+(e.audio_format||"webm")):r.append(a,e[a]));fetch(i.ajaxUrl,{method:"POST",body:r,credentials:"same-origin"}).then(a=>a.json()).then(a=>{if(a.success)o(a.data);else{let s=a.data&&typeof a.data=="object"&&a.data.message?a.data.message:"Unknown frontend API error (data or data.message missing/invalid)";t(new Error(s))}}).catch(a=>{console.error(`AIPKit Frontend AJAX Error (Action: ${n}):`,a),t(a)})})}window.aipkit_frontendApiRequest=c})();(function(){"use strict";function c(n){return`aipkit-client-msg-${String(n||"default").replace(/[^a-zA-Z0-9_-]/g,"")}-${Date.now()}-${Math.random().toString(36).substring(2,7)}`}window.aipkit_generateClientMessageId=c})();(function(){"use strict";function c(n){if(!n||typeof n.style>"u")return;n.style.height="auto";let e=n.scrollHeight,i=window.getComputedStyle(n),o=parseInt(i.minHeight,10)||0,t=parseInt(i.maxHeight,10)||1/0,r=Math.max(o,e);r=Math.min(r,t),n.style.height=`${r}px`,r>=t?(n.style.overflowY="auto",n.classList.add("aipkit-textarea-scrollable")):(n.style.overflowY="hidden",n.classList.remove("aipkit-textarea-scrollable"))}window.aipkit_autoResizeTextarea=c})();(function(){"use strict";function c(n,e,i){let{webSearchToggleButton:o}=n,t=e.allowWebSearchTool&&e.provider==="OpenAI";!o||!t||(i.webSearchToolActive=!i.webSearchToolActive,o.classList.toggle("aipkit_active",i.webSearchToolActive),o.title=i.webSearchToolActive?e.text?.webSearchActive||"Web Search Active":e.text?.webSearchInactive||"Web Search Inactive",o.setAttribute("aria-pressed",i.webSearchToolActive.toString()))}window.aipkit_toggleWebSearchAction=c})();(function(){"use strict";function c(n,e,i){let{googleSearchGroundingToggleButton:o}=n,t=e.allowGoogleSearchGrounding&&e.provider==="Google";!o||!t||(i.googleSearchGroundingActive=!i.googleSearchGroundingActive,o.classList.toggle("aipkit_active",i.googleSearchGroundingActive),o.title=i.googleSearchGroundingActive?e.text?.googleSearchGroundingActive||"Google Search Grounding Active":e.text?.googleSearchGroundingInactive||"Google Search Grounding Inactive",o.setAttribute("aria-pressed",i.googleSearchGroundingActive.toString()))}window.aipkit_toggleGoogleSearchGroundingAction=c})();(function(){"use strict";function c(n,e){let i=e.botId||"unknown",o=n.querySelector(".aipkit_chat_header"),t=n.querySelector(".aipkit_chat_main"),r=t?t.querySelector(".aipkit_chat_messages"):null,a=t?t.querySelector(".aipkit_chat_footer"):null,s=t?t.querySelector(".aipkit_chat_input"):null,l=s?s.querySelector(".aipkit_chat_input_field"):null,p=s?s.querySelector(".aipkit_chat_input_wrapper"):null,d=p?p.querySelector(".aipkit_chat_input_actions_bar"):null,u=n.querySelector(".aipkit_chat_image_preview_container"),_=n.querySelector(".aipkit_chat_image_upload_input");if(e.imageUploadEnabledUI&&s&&p){if(u||(u=document.createElement("div"),u.className="aipkit_chat_image_preview_container"),!p.contains(u)){let x=p.querySelector(".aipkit_chat_input_field");x?p.insertBefore(u,x):p.appendChild(u)}_||(_=document.createElement("input"),_.type="file",_.className="aipkit_chat_image_upload_input",_.style.display="none",_.setAttribute("aria-hidden","true"),s.appendChild(_))}let f=s?s.querySelector(".aipkit_chat_file_upload_input"):null;e.fileUploadEnabledUI&&s&&(f||(f=document.createElement("input"),f.type="file",f.className="aipkit_chat_file_upload_input",f.style.display="none",f.setAttribute("aria-hidden","true"),s.appendChild(f)));let w=d?d.querySelector(".aipkit_input_action_btn.aipkit_input_action_toggle"):null,m=s?s.querySelector(".aipkit_input_action_menu"):null,h=d?d.querySelector(".aipkit_voice_input_btn"):null,g=d?d.querySelector(".aipkit_web_search_toggle"):null,y=d?d.querySelector(".aipkit_google_search_grounding_toggle"):null,b=d?d.querySelector(".aipkit_chat_action_btn.aipkit_send_btn"):null,I=b?b.querySelector(".aipkit_send_icon"):null,k=b?b.querySelector(".aipkit_clear_icon"):null,S=b?b.querySelector(".aipkit_spinner"):null,A=t?t.querySelector(".aipkit_conversation_starters"):null,v=o?o.querySelector(".aipkit_sidebar_toggle_btn"):null,L=o?o.querySelector(".aipkit_fullscreen_btn"):null,H=o?o.querySelector(".aipkit_download_btn"):null,F=o?o.querySelector(".aipkit_close_btn"):null,M=n.querySelector(".aipkit_chat_sidebar"),C=M?M.querySelector(".aipkit_sidebar_new_chat_btn"):null;return!t||!r||!l||!b||!I||!k||!S?(console.error(`AIPKit Chat FindElements (${i}): Essential chat UI elements not found within container.`),null):(e.enableStarters&&!A&&console.warn(`AIPKit Chat FindElements (${i}): Starters enabled but container not found.`),e.enableSidebar&&(!M||!v)&&console.warn(`AIPKit Chat FindElements (${i}): Sidebar enabled but container or toggle button not found.`),e.inputActionButtonEnabled&&!w&&console.warn(`AIPKit Chat FindElements (${i}): Input Action Button features enabled but button element missing.`),e.allowWebSearchTool&&e.provider==="OpenAI"&&!g&&console.warn(`AIPKit Chat FindElements (${i}): OpenAI Web Search allowed but toggle button missing.`),e.allowGoogleSearchGrounding&&e.provider==="Google"&&!y&&console.warn(`AIPKit Chat FindElements (${i}): Google Search Grounding allowed but toggle button missing.`),{container:n,headerEl:o,mainContentEl:t,messagesEl:r,footerEl:a,inputArea:s,inputField:l,inputWrapper:p,actionsBar:d,imageUploadInput:_,imagePreviewContainer:u,fileUploadInput:f,inputActionButton:w,inputActionMenu:m,voiceInputButton:h,webSearchToggleButton:g,googleSearchGroundingToggleButton:y,actionButton:b,sendIcon:I,clearIcon:k,spinner:S,startersContainer:A,sidebarToggleBtn:v,fullscreenButton:L,downloadButton:H,closeButton:F,sidebarEl:M,newChatBtn:C})}window.aipkit_chatUI_findElements=c})();(function(){"use strict";function c(n,e=!1){n&&requestAnimationFrame(()=>{let i=n.scrollHeight-n.scrollTop-n.clientHeight<100;(e||i)&&(n.scrollTop=n.scrollHeight,setTimeout(()=>{n&&(n.scrollTop=n.scrollHeight)},50))})}window.aipkit_chatUI_scrollToBottom=c})();(function(){"use strict";function c(n,e=null){if(!n)return;if(e&&e.parentNode===n){try{n.removeChild(e)}catch(a){a.name!=="NotFoundError"&&console.warn("AIPKit removeTypingIndicator: Error removing provided indicator:",a)}return}let o=`aipkit-typing-indicator-${n.closest(".aipkit_chat_container")?.dataset.botId||n.closest(".aipkit_popup_wrapper")?.dataset.botId||"default"}`,t=n.querySelector(`#${CSS.escape(o)}`);if(t)try{n.removeChild(t)}catch(a){a.name!=="NotFoundError"&&console.warn("AIPKit removeTypingIndicator: Error removing indicator by ID:",a)}let r=n.querySelector(".aipkit_typing-indicator");if(r)try{n.removeChild(r)}catch(a){a.name!=="NotFoundError"&&console.warn("AIPKit removeTypingIndicator: Error removing indicator by class:",a)}}window.aipkit_chatUI_removeTypingIndicator=c})();(function(){"use strict";function c(n,e=null){if(!n)return;if(e&&e.parentNode===n){try{n.removeChild(e)}catch(a){a.name!=="NotFoundError"&&console.warn("AIPKit removeImageLoadingIndicator: Error removing provided indicator:",a)}return}let o=`aipkit-image-loading-indicator-${n.closest(".aipkit_chat_container")?.dataset.botId||n.closest(".aipkit_popup_wrapper")?.dataset.botId||"default"}`,t=n.querySelector(`#${CSS.escape(o)}`);if(t)try{n.removeChild(t)}catch(a){a.name!=="NotFoundError"&&console.warn("AIPKit removeImageLoadingIndicator: Error removing indicator by ID:",a)}let r=n.querySelector(".aipkit_image_loading_indicator");if(r)try{n.removeChild(r)}catch(a){a.name!=="NotFoundError"&&console.warn("AIPKit removeImageLoadingIndicator: Error removing indicator by class:",a)}}window.aipkit_chatUI_removeImageLoadingIndicator=c})();(function(){"use strict";function c(n,e){if(!n||!e||!e.text)return null;typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(n),typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"&&window.aipkit_chatUI_removeImageLoadingIndicator(n);let o=`aipkit-typing-indicator-${e.botId||"default"}`,t=document.createElement("div");t.className="aipkit_chat_message aipkit_chat_message-bot aipkit_typing-indicator",t.id=o;let r=(e.customTypingText||"").trim();if(r!==""){let a=(window.aipkit_escapeHtml||(s=>String(s)))(r);t.innerHTML=`
              <div class="aipkit_chat_bubble">
                  <span class="aipkit_typing-text">${a}</span>
                  <span class="aipkit_typing-ellipsis-text" aria-hidden="true"><span>.</span><span>.</span><span>.</span></span>
              </div>`}else t.innerHTML=`
              <div class="aipkit_chat_bubble">
                  <span class="aipkit_typing-dot"></span>
                  <span class="aipkit_typing-dot"></span>
                  <span class="aipkit_typing-dot"></span>
              </div>`;return n.appendChild(t),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,!0),t}window.aipkit_chatUI_showTypingIndicator=c})();(function(){"use strict";function c(n,e){if(!n||!e)return null;typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(n),typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"&&window.aipkit_chatUI_removeImageLoadingIndicator(n);let o=`aipkit-image-loading-indicator-${e.botId||"default"}`,t=document.createElement("div");return t.className="aipkit_chat_message aipkit_chat_message-bot aipkit_image_loading_indicator",t.id=o,t.innerHTML=`
        <div class="aipkit_chat_bubble aipkit_image_loader_bubble_thumbnail">
            <span class="dashicons dashicons-format-image"></span>
        </div>`,n.appendChild(t),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,!0),t}window.aipkit_chatUI_showImageLoadingIndicator=c})();(function(){"use strict";function c(n,e,i,o,t=!1,r=!1,a=null,s=!1,l=null){if(!n||!o)return;let p=window.aipkit_escapeHtml||function(w){return w},d=document.createElement("div"),u=i==="user"?"user":"bot";d.className=`aipkit_chat_message aipkit_chat_message-${u}`,t&&d.classList.add("aipkit_chat_message-error"),r&&d.classList.add("aipkit_initial_greeting"),a&&(d.id=a,d.setAttribute("data-message-id",a));let _=document.createElement("div");_.className="aipkit_chat_bubble";let f="";if(u==="user"&&typeof e=="object"&&e!==null&&e.user_image){if(e.user_image.base64_data&&e.user_image.mime_type){let w=document.createElement("img");w.src=`data:${e.user_image.mime_type};base64,${e.user_image.base64_data}`,w.alt=e.text||"User uploaded image",w.className="aipkit_user_sent_image_thumbnail",_.appendChild(w)}if(e.text&&e.text.trim()!==""){let w=document.createElement("div");w.className="aipkit_user_message_text_content",w.textContent=e.text,_.appendChild(w),f=e.text}else!e.text&&e.user_image&&(f="Image sent by user.")}else if(typeof e=="object"&&e?.type==="image"&&e.images?.length>0){let w=e.images[0],m=e.prompt||"Generated image",h=w.revised_prompt,g="";if(w.media_library_url?g=`<a href="${p(w.media_library_url)}" target="_blank" rel="noopener noreferrer"><img src="${p(w.media_library_url)}" alt="${p(m)}" style="max-width: 100%; height: auto; border-radius: 4px; display: block;"></a>`:w.url?g=`<a href="${p(w.url)}" target="_blank" rel="noopener noreferrer"><img src="${p(w.url)}" alt="${p(m)}" style="max-width: 100%; height: auto; border-radius: 4px; display: block;"></a>`:w.b64_json?g=`<img src="data:image/png;base64,${w.b64_json}" alt="${p(m)}" style="max-width: 100%; height: auto; border-radius: 4px; display: block;">`:g=`<p style="font-style: italic;">${p(e.content||o.text?.noImageData||"Image data unavailable.")}</p>`,_.innerHTML=g,_.style.padding="5px",_.style.maxWidth="60%",_.title=`Prompt: ${p(m)}`,f=`Image generated for prompt: ${p(m)}`,h){let y=document.createElement("p");y.style.fontSize="11px",y.style.fontStyle="italic",y.style.marginTop="5px",y.style.textAlign="center",y.style.color="inherit",y.textContent=`Revised: ${p(h)}`,_.appendChild(y),f+=`. Revised prompt: ${p(h)}`}}else if(typeof e=="string")if(f=e,(u==="bot"||r)&&!t&&window.aipkit_md)_.innerHTML=window.aipkit_md.render(e);else{let w=e.split(`
`);w.forEach((m,h)=>{_.appendChild(document.createTextNode(m)),h<w.length-1&&_.appendChild(document.createElement("br"))})}else console.error("AIPKit appendMessage: Invalid content type provided.",e),_.textContent=p("[Invalid Content]"),f="Invalid Content";if(_.setAttribute("data-raw-text",f),d.appendChild(_),u==="bot"&&!r&&!t)if(d.classList.add("aipkit_message_complete"),typeof window.aipkit_chatUI_createActionsContainerHTML=="function"){let w=window.aipkit_chatUI_createActionsContainerHTML(o);w&&d.insertAdjacentHTML("beforeend",w)}else console.error("AIPKit DOM: aipkit_chatUI_createActionsContainerHTML function not found globally.");if(u==="bot"&&!t&&l&&l.searchEntryPoint&&l.searchEntryPoint.renderedContent){let w=document.createElement("div");w.className="aipkit_grounding_widget",w.innerHTML=l.searchEntryPoint.renderedContent,d.appendChild(w)}n.appendChild(d),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,s)}window.aipkit_chatUI_appendMessage=c})();(function(){"use strict";function c(n,e){let i=n.querySelector(`.${e}`);i?i.parentNode&&i.parentNode.removeChild(i):(i=document.createElement("span"),i.className=e);let o=r=>{let a=Array.from(r.childNodes);for(let s=a.length-1;s>=0;s--){let l=a[s];if(l.nodeType===Node.TEXT_NODE&&l.textContent.trim()!==""){let p=document.createElement("span"),d=document.createTextNode(l.textContent);return p.appendChild(d),r.replaceChild(p,l),p.appendChild(i),!0}if(l.nodeType===Node.ELEMENT_NODE&&l.offsetParent!==null&&!l.classList.contains(e)&&["P","DIV","SPAN","LI","H1","H2","H3","H4","H5","H6","CODE","STRONG","EM","A","BR"].includes(l.tagName))return l.childNodes.length>0&&o(l)||(l.nextSibling?r.insertBefore(i,l.nextSibling):r.appendChild(i)),!0}return!1};o(n)||n.appendChild(i)}window.positionStreamingIndicator=c})();(function(){"use strict";function c(n,e,i,o,t,r=!1,a=!1,s=null){if(!n||!t||!e){console.error("AIPKit appendOrUpdateMessage: Missing messagesEl, config, or messageId.",{messagesEl:n,messageId:e,config:t});return}let l=window.aipkit_escapeHtml||function(w){return w},p=n.querySelector(`#${CSS.escape(e)}`),d,u="",_="aipkit_stream_indicator",f=o==="user"?"user":"bot";if(!p)p=document.createElement("div"),p.id=e,p.setAttribute("data-message-id",e),p.className=`aipkit_chat_message aipkit_chat_message-${f}`,a&&p.classList.add("aipkit_chat_message-error"),d=document.createElement("div"),d.className="aipkit_chat_bubble",d.dataset.aipkitFullContent="",d.setAttribute("data-raw-text",""),p.appendChild(d),n.appendChild(p);else{if(d=p.querySelector(".aipkit_chat_bubble"),!d)return;a&&!p.classList.contains("aipkit_chat_message-error")&&p.classList.add("aipkit_chat_message-error")}if(d.dataset.aipkitFullContent===void 0&&(d.dataset.aipkitFullContent=""),d.getAttribute("data-raw-text")===null&&d.setAttribute("data-raw-text",""),d.dataset.aipkitFullContent+=i,d.setAttribute("data-raw-text",d.getAttribute("data-raw-text")+i),u=d.dataset.aipkitFullContent,a?d.textContent=u:d.innerHTML=window.aipkit_md?window.aipkit_md.render(u):u.replace(/\n/g,"<br>"),p.classList.remove("aipkit_message_streaming"),!r&&!a){if(typeof window.positionStreamingIndicator=="function")window.positionStreamingIndicator(d,_);else{console.error("AIPKit appendOrUpdateMessage: positionStreamingIndicator function not found.");let w=d.querySelector(`.${_}`);w||(w=document.createElement("span"),w.className=_,d.appendChild(w))}p.classList.add("aipkit_message_streaming")}else{let w=d.querySelector(`.${_}`);if(w&&w.parentNode&&w.parentNode.removeChild(w),r&&!a&&f==="bot"&&!p.querySelector(".aipkit_message_actions")){if(p.classList.remove("aipkit_message_streaming"),p.classList.add("aipkit_message_complete"),typeof window.aipkit_chatUI_createActionsContainerHTML=="function"){let m=window.aipkit_chatUI_createActionsContainerHTML(t);m&&p.insertAdjacentHTML("beforeend",m)}else console.error("AIPKit DOM: aipkit_chatUI_createActionsContainerHTML function not found globally.");if(s&&s.searchEntryPoint&&s.searchEntryPoint.renderedContent){let m=document.createElement("div");m.className="aipkit_grounding_widget",m.innerHTML=s.searchEntryPoint.renderedContent,p.appendChild(m)}}}typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,r||a)}window.aipkit_chatUI_appendOrUpdateMessage=c})();(function(){"use strict";function c(n,e,i,o=null){if(!n||!e||!e.form_id||!Array.isArray(e.elements)){console.error("AIPKit RenderChatForm: Invalid arguments. Missing messagesEl, formDefinition, form_id, or elements array.");return}let t=window.aipkit_escapeHtml||function(u){return u},r=i.botId||"default",a=document.createElement("div");if(a.className="aipkit_chat_message aipkit_chat_message-bot aipkit_chat_form_message",o)a.id=o,a.setAttribute("data-message-id",o);else{let u=window.aipkit_generateClientMessageId?window.aipkit_generateClientMessageId(r):`form-msg-${Date.now()}`;a.id=u,a.setAttribute("data-message-id",u)}let s=document.createElement("div");s.className="aipkit_chat_bubble";let l=document.createElement("div");if(l.className="aipkit_chat_form_wrapper",l.dataset.formId=e.form_id,e.title){let u=document.createElement("h5");u.className="aipkit_chat_form_title",u.textContent=t(e.title),l.appendChild(u)}let p=document.createElement("form");p.className="aipkit_chat_form",p.dataset.formId=e.form_id,e.elements.forEach(u=>{let _=document.createElement("div");_.className="aipkit_chat_form_element";let f;switch(u.type){case"text_input":case"textarea":if(u.label){let m=document.createElement("label");m.setAttribute("for",`form-${t(e.form_id)}-${t(u.id)}`),m.textContent=t(u.label),m.className="aipkit_chat_form_label_text",_.appendChild(m)}f=u.type==="textarea"?document.createElement("textarea"):document.createElement("input"),u.type==="text_input"&&(f.type="text"),u.type==="textarea"&&(f.rows=u.rows||3),f.id=`form-${t(e.form_id)}-${t(u.id)}`,f.name=t(u.id),f.className="aipkit_form-input",u.placeholder&&(f.placeholder=t(u.placeholder)),u.required&&(f.required=!0),u.default_value!==void 0&&(f.value=t(String(u.default_value))),_.appendChild(f);break;case"dropdown":if(u.label){let m=document.createElement("label");m.setAttribute("for",`form-${t(e.form_id)}-${t(u.id)}`),m.textContent=t(u.label),m.className="aipkit_chat_form_label_text",_.appendChild(m)}f=document.createElement("select"),f.id=`form-${t(e.form_id)}-${t(u.id)}`,f.name=t(u.id),f.className="aipkit_form-input",u.required&&(f.required=!0),Array.isArray(u.options)&&u.options.forEach(m=>{let h=document.createElement("option");h.value=t(m.value),h.textContent=t(m.text),u.default_value===m.value&&(h.selected=!0),f.appendChild(h)}),_.appendChild(f);break;case"checkbox_group":case"radio_group":let w=document.createElement("fieldset");if(u.label){let m=document.createElement("legend");m.textContent=t(u.label),m.className="aipkit_chat_form_label_text",w.appendChild(m)}Array.isArray(u.options)&&u.options.forEach(m=>{let h=document.createElement("div");h.className=u.type==="checkbox_group"?"aipkit_form_checkbox_group_item":"aipkit_form_radio_group_item";let g=document.createElement("input");g.type=u.type==="checkbox_group"?"checkbox":"radio",g.id=`form-${t(e.form_id)}-${t(u.id)}-${t(m.value)}`,g.name=t(u.id)+(u.type==="checkbox_group"?"[]":""),g.value=t(m.value),(u.type==="checkbox_group"&&Array.isArray(u.default_value)&&u.default_value.includes(m.value)||u.type==="radio_group"&&u.default_value===m.value)&&(g.checked=!0);let y=document.createElement("label");y.setAttribute("for",g.id),y.textContent=t(m.text),h.appendChild(g),h.appendChild(y),w.appendChild(h)}),_.appendChild(w);break;case"heading":f=document.createElement(u.level||"h5"),f.className="aipkit_chat_form_element_heading",f.textContent=t(u.label||""),_.appendChild(f);break;case"label":f=document.createElement("p"),f.className="aipkit_chat_form_element_label_only",f.textContent=t(u.label||""),_.appendChild(f);break}if(u.help_text){let w=document.createElement("p");w.className="aipkit_form_help_text",w.textContent=t(u.help_text),_.appendChild(w)}p.appendChild(_)});let d=document.createElement("button");d.type="submit",d.className="aipkit_btn aipkit_chat_form_submit_btn",d.textContent=t(e.submit_button_text||"Submit"),p.appendChild(d),p.addEventListener("submit",u=>{if(typeof window.aipkit_chatUI_handleChatFormSubmission=="function"){let _=n.closest(".aipkit_chat_container")||n.closest(".aipkit_popup_wrapper"),f=null,w=null;_&&window.aipkitChatInstances&&window.aipkitChatInstances[_.id]?(f=window.aipkitChatInstances[_.id].elements,w=window.aipkitChatInstances[_.id].actions):window.aipkit_chat_ui_elements&&window.aipkit_chat_ui_actions&&(f=window.aipkit_chat_ui_elements,w=window.aipkit_chat_ui_actions),f&&w?window.aipkit_chatUI_handleChatFormSubmission(u,i,f,w):(console.error("AIPKit RenderChatForm: Could not find chat instance elements/actions for form submission. Form ID:",e.form_id),alert("Error submitting form: Chat context not found."))}else console.error("AIPKit RenderChatForm: aipkit_chatUI_handleChatFormSubmission function not found."),alert("Error submitting form: Submission handler missing.")}),l.appendChild(p),s.appendChild(l),a.appendChild(s),n.appendChild(a),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,!0)}window.aipkit_chatUI_renderChatForm=c})();(function(){"use strict";window.aipkitSttState={mediaRecorder:null,audioChunks:[],audioStream:null,currentMimeType:"",onRecordingStartCallback:()=>{},onRecordingStopCallback:(c,n)=>{},onRecordingErrorCallback:c=>{}}})();(function(){"use strict";function c(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&window.MediaRecorder)}window.aipkit_isMediaRecorderSupported=c})();(function(){"use strict";function c(n,e,i){if(!window.aipkitSttState){console.error("AIPKit STT Callbacks: State object not initialized.");return}window.aipkitSttState.onRecordingStartCallback=typeof n=="function"?n:()=>{},window.aipkitSttState.onRecordingStopCallback=typeof e=="function"?e:()=>{},window.aipkitSttState.onRecordingErrorCallback=typeof i=="function"?i:()=>{}}window.aipkit_setRecordingCallbacks=c})();(function(){"use strict";async function c(n={}){if(!window.aipkitSttState){console.error("AIPKit STT Start: State object not initialized."),typeof window.aipkit_setRecordingCallbacks=="function"&&window.aipkitSttState.onRecordingErrorCallback&&window.aipkitSttState.onRecordingErrorCallback(new Error("STT system not ready."));return}let e=window.aipkitSttState;if(typeof window.aipkit_isMediaRecorderSupported!="function"||!window.aipkit_isMediaRecorderSupported()){console.error("AIPKit STT Start: MediaRecorder API not supported by this browser."),e.onRecordingErrorCallback&&e.onRecordingErrorCallback(new Error("Recording not supported."));return}if(e.mediaRecorder&&e.mediaRecorder.state==="recording"){console.warn("AIPKit STT Start: Recording is already in progress.");return}if(e.mediaRecorder&&e.mediaRecorder.state==="paused"){e.mediaRecorder.resume(),e.onRecordingStartCallback&&e.onRecordingStartCallback();return}e.audioChunks=[];try{e.audioStream=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1});let i=["audio/webm;codecs=opus","audio/ogg;codecs=opus","audio/webm","audio/mp4","audio/mp3","audio/wav"],o="";for(let r of i)if(MediaRecorder.isTypeSupported(r)){o=r;break}if(!o&&MediaRecorder.isTypeSupported(""))o="";else if(!o)throw console.error("AIPKit STT Start: No suitable audio mimeType supported by MediaRecorder."),new Error("No supported audio format found.");let t=o?{mimeType:o}:{};e.mediaRecorder=new MediaRecorder(e.audioStream,t),e.currentMimeType=e.mediaRecorder.mimeType||o||"application/octet-stream",e.mediaRecorder.ondataavailable=r=>{r.data.size>0&&e.audioChunks.push(r.data)},e.mediaRecorder.onstop=()=>{if(e.audioChunks.length>0){let r=new Blob(e.audioChunks,{type:e.currentMimeType});e.onRecordingStopCallback&&e.onRecordingStopCallback(r,e.currentMimeType),e.audioStream&&(e.audioStream.getTracks().forEach(a=>a.stop()),e.audioStream=null)}else console.warn("AIPKit STT Start (onstop): Recording stopped, but no audio chunks received."),e.onRecordingErrorCallback&&e.onRecordingErrorCallback(new Error("No audio data recorded.")),e.audioStream&&(e.audioStream.getTracks().forEach(r=>r.stop()),e.audioStream=null);e.audioChunks=[]},e.mediaRecorder.onerror=r=>{console.error("AIPKit STT Start (onerror): MediaRecorder error:",r.error),e.onRecordingErrorCallback&&e.onRecordingErrorCallback(r.error),e.audioStream&&(e.audioStream.getTracks().forEach(a=>a.stop()),e.audioStream=null),e.audioChunks=[],e.mediaRecorder=null},e.mediaRecorder.start(),e.onRecordingStartCallback&&e.onRecordingStartCallback()}catch(i){console.error("AIPKit STT Start: Error accessing microphone or starting recorder:",i),e.onRecordingErrorCallback&&e.onRecordingErrorCallback(i),e.audioStream&&(e.audioStream.getTracks().forEach(o=>o.stop()),e.audioStream=null)}}window.aipkit_startRecording=c})();(function(){"use strict";function c(){if(!window.aipkitSttState){console.error("AIPKit STT Stop: State object not initialized.");return}let n=window.aipkitSttState;n.mediaRecorder&&(n.mediaRecorder.state==="recording"||n.mediaRecorder.state==="paused")?n.mediaRecorder.stop():(console.warn("AIPKit STT Stop: stopRecording called but no active/paused recording found."),n.audioStream&&(n.audioStream.getTracks().forEach(e=>e.stop()),n.audioStream=null))}window.aipkit_stopRecording=c})();(function(){"use strict";function c(n,e,i){let{elements:o,config:t,state:r,setButtonStateAction:a,sendMessageAction:s}=i,{inputField:l,voiceInputButton:p}=o;if(!n||!e||!o||!t||!r||!a||!s){if(console.error("AIPKit STT UI (Transcribe): Missing required parameters for transcribeAudio.",i),alert("Failed to process audio: Configuration error."),p){p.disabled=t.requireConsentCompliance&&!r.consentGiven,p.classList.remove("aipkit_loading");let _=p.querySelector(".dashicons");_&&(_.style.display="")}return}if(p){p.disabled=!0,p.classList.add("aipkit_loading");let _=p.querySelector(".dashicons");_&&(_.style.display="none")}let d=(e||"").split(";")[0].split("/")[1]||"webm",u={audio_file:n,audio_format:d};window.aipkit_frontendApiRequest("aipkit_transcribe_audio",u,t).then(_=>{if(_&&_.transcription)l.value=_.transcription,typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(l),a("send",!0,r),s(_.transcription);else throw new Error("Invalid transcription response from server.")}).catch(_=>{console.error(`AIPKit STT UI (${t.botId}): Transcription AJAX error:`,_),alert(`Transcription failed: ${_.message||"Unknown error"}`)}).finally(()=>{if(p){p.disabled=t.requireConsentCompliance&&!r.consentGiven,p.classList.remove("aipkit_loading");let _=p.querySelector(".dashicons");_&&(_.style.display="")}})}window.aipkit_chatUI_transcribeAudio=c})();(function(){"use strict";function c(n,e,i,o,t){let{inputField:r,voiceInputButton:a,actionButton:s,inputActionButton:l}=n,p=e.botId;if(o&&typeof o.showConsentBoxIfNeeded=="function"&&o.showConsentBoxIfNeeded()){console.warn(`AIPKit Chat UI Main (${p}): Cannot record, consent required and box shown.`);return}if(e.requireConsentCompliance&&!i.consentGiven){console.warn(`AIPKit Chat UI Main (${p}): Consent required but not given (fallback check).`);return}if(typeof window.aipkit_startRecording!="function"||typeof window.aipkit_stopRecording!="function"||typeof window.aipkit_setRecordingCallbacks!="function"||typeof window.aipkit_isMediaRecorderSupported!="function"){console.error("AIPKit STT (Handle Action): Required recording functions not available from core STT scripts."),alert("Voice input is currently unavailable (script error).");return}if(!window.aipkit_isMediaRecorderSupported()){let d=window.location.protocol==="https:",u=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1";alert(!d&&!u?"Voice recording requires HTTPS connection for security. Please access this site using HTTPS or contact the administrator to enable SSL.":"Voice recording is not supported by your browser. Please try a different browser like Chrome or Firefox.");return}i.isRecording?window.aipkit_stopRecording():(window.aipkit_setRecordingCallbacks(()=>{i.isRecording=!0,a.classList.add("aipkit_recording"),a.setAttribute("aria-label","Stop recording"),a.title="Stop recording",r.disabled=!0,s.disabled=!0,l&&(l.disabled=!0)},(d,u)=>{i.isRecording=!1,a.classList.remove("aipkit_recording"),a.setAttribute("aria-label","Voice input"),a.title="Voice input",r.disabled=e.requireConsentCompliance&&!i.consentGiven,s.disabled=r.value.trim()==="",l&&(l.disabled=!1),typeof window.aipkit_chatUI_transcribeAudio=="function"?window.aipkit_chatUI_transcribeAudio(d,u,{elements:n,config:e,state:i,setButtonStateAction:t.setButtonStateAction,sendMessageAction:t.sendMessageAction}):(console.error("AIPKit STT (Handle Action): transcribeAudio UI function not found."),alert("Error processing recorded audio."))},d=>{i.isRecording=!1,a.classList.remove("aipkit_recording"),a.setAttribute("aria-label","Voice input"),a.title="Voice input",r.disabled=e.requireConsentCompliance&&!i.consentGiven,s.disabled=r.value.trim()==="",l&&(l.disabled=!1),console.error(`AIPKit STT (${p}): Recording error:`,d),alert(`Recording failed: ${d.message||"Unknown error"}`)}),window.aipkit_startRecording())}window.aipkit_chatUI_handleVoiceInputAction=c})();(function(){"use strict"})();(function(){"use strict";window.aipkitImageUploadConstants={MAX_IMAGE_SIZE_MB:20,MAX_IMAGE_SIZE_BYTES:20*1024*1024,ALLOWED_IMAGE_TYPES:["image/jpeg","image/png","image/webp"],ALLOWED_IMAGE_EXTENSIONS:[".jpg",".jpeg",".png",".webp"]}})();(function(){"use strict";window.aipkitImageUploadState={currentImageFile:null,currentImageBase64:null}})();(function(){"use strict";function c(n){let e=window.aipkitImageUploadConstants;return e?n?e.ALLOWED_IMAGE_TYPES.includes(n.type)?n.size>e.MAX_IMAGE_SIZE_BYTES?{isValid:!1,error:`Image is too large. Max size: ${e.MAX_IMAGE_SIZE_MB}MB.`}:{isValid:!0}:{isValid:!1,error:`Invalid file type. Please use ${e.ALLOWED_IMAGE_EXTENSIONS.join(", ")}.`}:{isValid:!1,error:"No file selected."}:(console.error("Image Upload Validate: Constants not loaded."),{isValid:!1,error:"Internal configuration error (constants missing)."})}window.aipkit_validateImage=c})();(function(){"use strict";function c(n){return new Promise((e,i)=>{let o=new FileReader;o.onload=()=>e(o.result),o.onerror=t=>i(t),o.readAsDataURL(n)})}window.aipkit_convertFileToBase64=c})();(function(){"use strict";function c(n){let e;n&&n.parentNode&&(e=n.parentNode.querySelector(".chat-image-upload-error")),e&&e.remove(),document.querySelectorAll(".chat-image-upload-error").forEach(i=>i.remove())}window.aipkit_clearImageUploadError=c})();(function(){"use strict";function c(n,e){typeof window.aipkit_clearImageUploadError=="function"?window.aipkit_clearImageUploadError(e):console.error("Image Upload Display Error: clearImageUploadError function not found.");let i=document.createElement("div");if(i.className="chat-image-upload-error",i.textContent=n,e&&e.parentNode)e.parentNode.insertBefore(i,e.nextSibling);else{let o=document.querySelector(".aipkit_chat_input");o?o.appendChild(i):console.warn("Image Upload Display Error: Could not find a suitable place to display error message.")}}window.aipkit_displayImageUploadError=c})();(function(){"use strict";function c(n,e){let i=window.aipkitImageUploadState;if(!i){console.error("Image Upload Reset: State object not found.");return}i.currentImageFile=null,i.currentImageBase64=null,n&&(n.hasChildNodes()?(n.classList.add("aipkit-image-preview-fade-out"),setTimeout(()=>{n&&(n.innerHTML="",n.style.display="none",n.classList.remove("aipkit-image-preview-fade-out"))},300)):(n.innerHTML="",n.style.display="none")),e&&(e.value=""),typeof window.aipkit_clearImageUploadError=="function"?window.aipkit_clearImageUploadError(n||e):console.error("Image Upload Reset: clearImageUploadError function not found."),document.dispatchEvent(new CustomEvent("chatImageReset"))}window.aipkit_resetImageUpload=c})();(function(){"use strict";function c(n,e){if(!e)return;e.innerHTML="",e.style.display="block",e.classList.remove("aipkit-image-preview-fade-out");let i=document.createElement("div");i.className="chat-image-thumbnail-wrapper";let o=document.createElement("img");o.src=n,o.alt="Image preview",o.className="chat-image-thumbnail";let t=document.createElement("button");t.className="chat-image-remove-button",t.innerHTML="\xD7",t.setAttribute("aria-label","Remove image"),t.type="button",t.onclick=()=>{let r=e.closest(".aipkit_chat_input")?.querySelector(".aipkit_chat_image_upload_input");typeof window.aipkit_resetImageUpload=="function"?window.aipkit_resetImageUpload(e,r):console.error("Image Upload Render Preview: resetImageUpload function not found."),document.dispatchEvent(new CustomEvent("chatImageRemoved"))},i.appendChild(o),i.appendChild(t),e.appendChild(i)}window.aipkit_renderImagePreview=c})();(function(){"use strict";function c(){let n=window.aipkitImageUploadState;return n?n.currentImageFile&&n.currentImageBase64?{mime_type:n.currentImageFile.type,base64_data:n.currentImageBase64.split(",")[1]}:null:(console.error("Image Upload Get Data: State object not found."),null)}window.aipkit_getImageUploadData=c})();(function(){"use strict";function c(){let n=window.aipkitImageUploadConstants;return n?n.ALLOWED_IMAGE_EXTENSIONS:(console.error("Image Upload Get Extensions: Constants not loaded."),[".jpg",".jpeg",".png",".webp"])}window.aipkit_getAllowedImageExtensions=c})();(function(){"use strict";function c(){let n=window.aipkitImageUploadConstants;return n?n.MAX_IMAGE_SIZE_MB:(console.error("Image Upload Get Max Size: Constants not loaded."),20)}window.aipkit_getMaxImageSizeMB=c})();(function(){"use strict";function c(n,e){let i=window.aipkitImageUploadState,o=window.aipkitImageUploadConstants;if(!i||!o){console.error("Chat Image Upload Init: State or Constants not loaded.");return}if(!n||!e){console.error("Chat Image Upload Init: File input or preview container not provided for initialization.");return}if(typeof window.aipkit_validateImage!="function"||typeof window.aipkit_convertFileToBase64!="function"||typeof window.aipkit_displayImageUploadError!="function"||typeof window.aipkit_clearImageUploadError!="function"||typeof window.aipkit_renderImagePreview!="function"||typeof window.aipkit_resetImageUpload!="function"){console.error("Chat Image Upload Init: One or more helper functions are missing.");return}n.setAttribute("accept",o.ALLOWED_IMAGE_EXTENSIONS.join(",")),n.dataset.aipkitUploadListenerAttached!=="true"&&(n.addEventListener("change",async t=>{window.aipkit_clearImageUploadError(e);let r=t.target.files[0];if(!r){window.aipkit_resetImageUpload(e,n);return}let a=window.aipkit_validateImage(r);if(!a.isValid){window.aipkit_displayImageUploadError(a.error,e),window.aipkit_resetImageUpload(e,n),document.dispatchEvent(new CustomEvent("chatImageValidationFailed",{detail:{error:a.error}}));return}try{let s=await window.aipkit_convertFileToBase64(r);i.currentImageBase64=s,i.currentImageFile=r,window.aipkit_renderImagePreview(i.currentImageBase64,e),document.dispatchEvent(new CustomEvent("chatImageReady",{detail:{base64_data:i.currentImageBase64.split(",")[1],mime_type:i.currentImageFile.type}}))}catch(s){console.error("Error processing image:",s),window.aipkit_displayImageUploadError("Could not process image. Please try again.",e),window.aipkit_resetImageUpload(e,n),document.dispatchEvent(new CustomEvent("chatImageProcessingFailed",{detail:{error:"Could not process image."}}))}}),n.dataset.aipkitUploadListenerAttached="true")}window.chatImageUpload={init:c,getImageData:function(){return typeof window.aipkit_getImageUploadData=="function"?window.aipkit_getImageUploadData():(console.error("chatImageUpload: getImageData helper not found."),null)},reset:function(n,e){typeof window.aipkit_resetImageUpload=="function"?window.aipkit_resetImageUpload(n,e):console.error("chatImageUpload: resetUpload helper not found.")},getAllowedImageExtensions:function(){return typeof window.aipkit_getAllowedImageExtensions=="function"?window.aipkit_getAllowedImageExtensions():(console.error("chatImageUpload: getAllowedImageExtensions helper not found."),[])},getMaxImageSizeMB:function(){return typeof window.aipkit_getMaxImageSizeMB=="function"?window.aipkit_getMaxImageSizeMB():(console.error("chatImageUpload: getMaxImageSizeMB helper not found."),20)}}})();(function(){"use strict";window.aipkitFileUploadConstants={MAX_FILE_SIZE_MB:20,MAX_FILE_SIZE_BYTES:20*1024*1024,ALLOWED_FILE_TYPES:["text/plain","application/pdf"],ALLOWED_FILE_EXTENSIONS:[".txt",".pdf"]}})();(function(){"use strict";function c(){window.aipkitFileUploadState={currentFile:null}}window.aipkit_initFileUploadState=c;function n(e,i){window.aipkitFileUploadState&&(window.aipkitFileUploadState.currentFile=null),e&&(e.value=""),typeof window.aipkit_clearChatFileUploadStatus=="function"&&i&&window.aipkit_clearChatFileUploadStatus(i)}window.aipkit_resetChatFileUploadUI=n})();(function(){"use strict";function c(n){let e=window.aipkitFileUploadConstants;return e?n?e.ALLOWED_FILE_TYPES.includes(n.type)?n.size>e.MAX_FILE_SIZE_BYTES?{isValid:!1,error:`File is too large. Max size: ${e.MAX_FILE_SIZE_MB}MB.`}:{isValid:!0}:{isValid:!1,error:`Invalid file type. Please use ${e.ALLOWED_FILE_EXTENSIONS.join(", ")}.`}:{isValid:!1,error:"No file selected."}:(console.error("Chat File Upload Validate: Constants not loaded."),{isValid:!1,error:"Internal configuration error (file constants missing)."})}window.aipkit_validateChatFile=c})();(function(){"use strict";function c(n){if(!n)return;let e=n.querySelector(".aipkit_chat_file_upload_status");e&&(e.textContent="",e.style.display="none",e.className="aipkit_chat_file_upload_status")}window.aipkit_clearChatFileUploadStatus=c})();(function(){"use strict";function c(n,e="info",i){if(!i)return;let o=i.querySelector(".aipkit_chat_file_upload_status");if(!o){o=document.createElement("div"),o.className="aipkit_chat_file_upload_status";let t=i.querySelector(".aipkit_chat_input_wrapper");t?i.insertBefore(o,t):i.appendChild(o)}if(o.textContent=n,o.className="aipkit_chat_file_upload_status",o.classList.add(`aipkit_status-${e}`),o.style.display="block",e==="error")try{let t=i.closest(".aipkit_chat_container");if(!t)return;let r=window.aipkitChatInstances&&t.id?window.aipkitChatInstances[t.id]:null,a=null,s=null;if(r&&r.internalElements&&r.internalElements.messagesEl&&r.internalActions){a=r.internalElements.messagesEl;let f=t.getAttribute("data-config");if(f)try{s=JSON.parse(f)}catch{}}else{a=t.querySelector(".aipkit_chat_messages");let f=t.getAttribute("data-config");if(f)try{s=JSON.parse(f)}catch{}}if(!a)return;s||(s={botId:t.dataset.botId||"default",text:{errorPrefix:"Error:"}});let l=s.text&&s.text.errorPrefix?s.text.errorPrefix:"Error:",p=String(n||"").trim(),u=p.toLowerCase().startsWith(l.toLowerCase())?p:`${l} ${p}`,_=typeof window.aipkit_generateClientMessageId=="function"?window.aipkit_generateClientMessageId(s.botId):null;typeof window.aipkit_chatUI_appendMessage=="function"&&window.aipkit_chatUI_appendMessage(a,u,"bot",s,!0,!1,_,!0)}catch(t){console.error("AIPKit Chat File Upload: Failed to append error to chat window:",t)}}window.aipkit_displayChatFileUploadStatus=c})();(function(){"use strict";function c(){let n=window.aipkitFileUploadConstants;return n?n.ALLOWED_FILE_EXTENSIONS:(console.error("File Upload Get Extensions: Constants not loaded."),[".txt",".pdf"])}window.aipkit_getAllowedFileExtensions=c})();(function(){"use strict";function c(){let n=window.aipkitFileUploadConstants;return n?n.MAX_FILE_SIZE_MB:(console.error("File Upload Get Max Size: Constants not loaded."),2)}window.aipkit_getMaxFileSizeMB=c})();(function(){"use strict";typeof window.aipkit_initFileUploadState=="function"?window.aipkit_initFileUploadState():console.error("File Upload Init: State initializer (aipkit_initFileUploadState) not found.");let c=window.aipkit_escapeHtml||function(e){return e};async function n(e,i,o,t){let r=window.aipkitFileUploadState,a=window.aipkitFileUploadConstants;if(!r||!a)return console.error("Chat File Upload Init Processing: State or Constants not loaded."),typeof window.aipkit_displayChatFileUploadStatus=="function"&&window.aipkit_displayChatFileUploadStatus("File upload system error.","error",o),null;let s=["aipkit_validateChatFile","aipkit_displayChatFileUploadStatus","aipkit_clearChatFileUploadStatus","aipkit_resetChatFileUploadUI"];for(let d of s)if(typeof window[d]!="function")return console.error(`Chat File Upload Init Processing: Missing required helper function: ${d}.`),typeof window.aipkit_displayChatFileUploadStatus=="function"&&window.aipkit_displayChatFileUploadStatus("File upload component error.","error",o),null;window.aipkit_clearChatFileUploadStatus(o);let l=window.aipkit_validateChatFile(e);if(!l.isValid)return window.aipkit_displayChatFileUploadStatus(l.error,"error",o),window.aipkit_resetChatFileUploadUI(i,o),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),null;r.currentFile=e,window.aipkit_displayChatFileUploadStatus(`Uploading "${c(r.currentFile.name)}"...`,"processing",o);let p=new FormData;p.append("action","aipkit_frontend_chat_upload_file"),p.append("file_to_upload",r.currentFile),p.append("bot_id",t.botId),p.append("conversation_uuid",window.aipkit_current_conversation_uuid||""),window.aipkit_guest_uuid&&(!window.aipkit_current_user_id||window.aipkit_current_user_id===0)&&p.append("session_id",window.aipkit_guest_uuid),window.aipkit_current_post_id&&p.append("post_id",window.aipkit_current_post_id),p.append("upload_provider",t.vectorStoreProvider),p.append("_ajax_nonce",t.nonce);try{let d=await fetch(t.ajaxUrl,{method:"POST",body:p,credentials:"same-origin"}),u=await d.json();if(!d.ok||!u.success){let _=u.data?.message||u.message||"File upload failed on server.";throw new Error(_)}if(u.data&&u.data.file_context){let _=u.data.file_context;if(window.aipkit_current_conversation_uuid)try{localStorage.setItem(`aipkit_file_context_${window.aipkit_current_conversation_uuid}`,JSON.stringify(_))}catch(w){console.error("AIPKit File Upload: Error saving file context to localStorage:",w)}window.aipkit_active_file_context_provider=_.provider,window.aipkit_active_file_context_data=_,sessionStorage.setItem("aipkit_active_file_context_provider",window.aipkit_active_file_context_provider),sessionStorage.setItem("aipkit_active_file_context_data",JSON.stringify(window.aipkit_active_file_context_data));let f=(t.text?.fileContextActive||"Chatting with: %s").replace("%s",c(r.currentFile.name));return window.aipkit_displayChatFileUploadStatus(f,"success",o),document.dispatchEvent(new CustomEvent("aipkit:fileContextUpdated",{detail:window.aipkit_active_file_context_data})),window.aipkit_active_file_context_data}else throw new Error("Server did not return file context after upload.")}catch(d){return console.error("File Upload Processing Error:",d),window.aipkit_displayChatFileUploadStatus(`Error: ${d.message||"Upload failed."}`,"error",o),window.aipkit_resetChatFileUploadUI(i,o),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),null}}window.aipkitChatFileUpload={processFile:n,resetUI:function(e,i){typeof window.aipkit_resetChatFileUploadUI=="function"&&window.aipkit_resetChatFileUploadUI(e,i)},getAllowedFileExtensions:function(){return typeof window.aipkit_getAllowedFileExtensions=="function"?window.aipkit_getAllowedFileExtensions():[]},getMaxFileSizeMB:function(){return typeof window.aipkit_getMaxFileSizeMB=="function"?window.aipkit_getMaxFileSizeMB():2}}})();(function(){"use strict";function c(n,e,i,o,t=!1){let{inputField:r,actionButton:a,sendIcon:s,clearIcon:l,spinner:p,voiceInputButton:d,inputActionButton:u,webSearchToggleButton:_,googleSearchGroundingToggleButton:f}=e,w=i.text||{};if(!a||!s||!l||!p||!r)return console.error("AIPKit SetButtonState: Missing required elements."),null;p.style.display="none",s.style.display="none",l.style.display="none",a.disabled=!1,a.classList.remove("aipkit_btn-clear-state");let m=n;switch(n){case"sending":case"streaming":r.disabled=!0,a.disabled=!0,d&&(d.disabled=!0),u&&(u.disabled=!0),_&&(_.disabled=!0),f&&(f.disabled=!0),p.style.display="inline-block";let h=n==="streaming"?w.streaming||"Streaming...":w.sending||"Sending...";a.setAttribute("aria-label",h),a.setAttribute("title",h);break;case"clear":r.disabled=i.requireConsentCompliance&&!o.consentGiven,l.style.display="inline-block",a.classList.add("aipkit_btn-clear-state"),a.setAttribute("aria-label",w.clearChat||"Clear Chat"),a.setAttribute("title",w.clearChat||"Clear Chat"),a.disabled=!1,d&&(d.disabled=i.requireConsentCompliance&&!o.consentGiven),u&&(u.disabled=i.requireConsentCompliance&&!o.consentGiven),_&&(_.disabled=i.requireConsentCompliance&&!o.consentGiven),f&&(f.disabled=i.requireConsentCompliance&&!o.consentGiven);break;case"send":default:m="send",r.disabled=i.requireConsentCompliance&&!o.consentGiven,s.style.display="inline-block",a.setAttribute("aria-label",w.sendMessage||"Send Message"),a.setAttribute("title",w.sendMessage||"Send Message"),a.disabled=!t&&r.value.trim()==="",i.requireConsentCompliance&&!o.consentGiven&&(a.disabled=!0),d&&(d.disabled=i.requireConsentCompliance&&!o.consentGiven),u&&(u.disabled=i.requireConsentCompliance&&!o.consentGiven),_&&(_.disabled=i.requireConsentCompliance&&!o.consentGiven),f&&(f.disabled=i.requireConsentCompliance&&!o.consentGiven);break}return m}window.aipkit_chatUI_setButtonStateAction=c})();(function(){"use strict";function c(n,e,i){if(!n)return;let o=n.closest("#aipkit_admin_chat_preview_container"),t=window.innerWidth<=760;e.requireConsentCompliance&&!i.consentGiven||e.popupEnabled&&!i.isPopupOpen||((o||!t||i.userInitiatedAction)&&setTimeout(()=>{n&&typeof n.focus=="function"&&n.focus()},50),i.userInitiatedAction&&(i.userInitiatedAction=!1))}window.aipkit_chatUI_focusInputAction=c})();(function(){"use strict";function c(n,e,i,o,t,r){let{inputField:a,messagesEl:s,container:l,voiceInputButton:p,inputActionButton:d,webSearchToggleButton:u,googleSearchGroundingToggleButton:_}=i;t.isSending=!1,t.currentStreamId=null,t.currentStreamMessageId=null,a.disabled=o.requireConsentCompliance&&!t.consentGiven,p&&(p.disabled=o.requireConsentCompliance&&!t.consentGiven),d&&(d.disabled=o.requireConsentCompliance&&!t.consentGiven),u&&o.allowWebSearchTool&&o.provider==="OpenAI"&&(u.disabled=o.requireConsentCompliance&&!t.consentGiven),_&&o.allowGoogleSearchGrounding&&o.provider==="Google"&&(_.disabled=o.requireConsentCompliance&&!t.consentGiven);let f=a.value.trim()==="",w=s.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").length>0;t.buttonState=r.setButtonStateAction(f&&w?"clear":"send",!1,t),r.focusInputAction(),l.dispatchEvent(new CustomEvent("aipkit:messageReceived",{detail:{messageId:n,conversationUUID:window.aipkit_current_conversation_uuid,newConversation:e}})),o.ttsEnabled&&o.ttsAutoPlay&&n&&setTimeout(()=>{let h=s.querySelector(`#${CSS.escape(n)}`)?.querySelector(".aipkit_play_btn");h&&typeof window.aipkit_handlePlayAction=="function"?window.aipkit_handlePlayAction(h):o.ttsEnabled&&o.ttsAutoPlay&&console.warn(`AIPKit AutoPlay (${o.botId}): Could not find play button for message ${n} or play action is missing.`)},100)}window.aipkit_chatUI_handleCompletion=c})();(function(){"use strict";function c(n,e,i=!0,o,t,r,a){let{messagesEl:s,inputField:l,container:p,voiceInputButton:d,inputActionButton:u,webSearchToggleButton:_,googleSearchGroundingToggleButton:f}=o,w=t.botId;r.isSending=!1,r.currentStreamId=null,r.currentStreamMessageId=null;let m=window.aipkit_generateClientMessageId(w);window.aipkit_chatUI_appendMessage(s,n,"bot",t,!0,!1,m,i),window.aipkit_chatUI_removeTypingIndicator(s),l.disabled=t.requireConsentCompliance&&!r.consentGiven,d&&(d.disabled=t.requireConsentCompliance&&!r.consentGiven),u&&(u.disabled=t.requireConsentCompliance&&!r.consentGiven),_&&t.allowWebSearchTool&&t.provider==="OpenAI"&&(_.disabled=t.requireConsentCompliance&&!r.consentGiven),f&&t.allowGoogleSearchGrounding&&t.provider==="Google"&&(f.disabled=t.requireConsentCompliance&&!r.consentGiven),r.buttonState=a.setButtonStateAction("send",!1,r),a.focusInputAction(),p.dispatchEvent(new CustomEvent("aipkit:messageError",{detail:{messageId:m,error:n}}))}window.aipkit_chatUI_handleError=c})();(function(){"use strict";function c(n){if(!n)return;n.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").forEach(i=>{try{n.removeChild(i)}catch(o){o.name!=="NotFoundError"&&console.warn("AIPKit clearMessages: Error removing node:",o)}}),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(n,!0)}window.aipkit_chatUI_clearMessages=c})();(function(){"use strict";function c(n,e,i,o){let{messagesEl:t,inputField:r,imagePreviewContainer:a,imageUploadInput:s,fileUploadInput:l,inputArea:p}=n;typeof window.aipkit_chatUI_removeTypingIndicator!="function"?console.error("AIPKit Clear Action: Dependency window.aipkit_chatUI_removeTypingIndicator not found."):window.aipkit_chatUI_removeTypingIndicator(t),typeof window.aipkit_chatUI_clearMessages!="function"?console.error("AIPKit Clear Action: Dependency window.aipkit_chatUI_clearMessages not found."):window.aipkit_chatUI_clearMessages(t);let d=t.querySelector(".aipkit_initial_greeting");if(!d&&typeof window.aipkit_chatUI_appendMessage=="function"){let _=e?.text?.initialGreeting||"Hello!";typeof window.aipkit_generateClientMessageId=="function"?window.aipkit_chatUI_appendMessage(t,_,"bot",e,!1,!0,window.aipkit_generateClientMessageId(e.botId)):console.error("AIPKit Clear Action: window.aipkit_generateClientMessageId is missing, cannot append initial greeting reliably.")}else d||console.error("AIPKit Clear Action: Initial greeting missing after clear, and appendMessage function unavailable.");r&&(r.value="",r.disabled=e.requireConsentCompliance&&!i.consentGiven,typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(r)),e.imageUploadEnabledUI&&window.chatImageUpload&&typeof window.chatImageUpload.reset=="function"?n.imagePreviewContainer&&n.imageUploadInput?window.chatImageUpload.reset(n.imagePreviewContainer,n.imageUploadInput):console.warn("AIPKit Clear Action: Image upload UI reset skipped, preview or input element missing from 'elements' object passed to clearChatAction."):e.imageUploadEnabledUI&&typeof window.chatImageUpload>"u"&&console.warn("AIPKit Clear Action: Image upload UI reset skipped, chatImageUpload script not loaded."),e.fileUploadEnabledUI&&window.aipkitChatFileUpload&&typeof window.aipkitChatFileUpload.resetUI=="function"?n.fileUploadInput&&n.inputArea?window.aipkitChatFileUpload.resetUI(n.fileUploadInput,n.inputArea):console.warn("AIPKit Clear Action: File upload UI reset skipped, file input or input area missing from 'elements' object."):e.fileUploadEnabledUI&&typeof window.aipkitChatFileUpload>"u"&&console.warn("AIPKit Clear Action: File upload UI reset skipped, aipkitChatFileUpload script not loaded."),typeof o.setButtonStateAction=="function"?i.buttonState=o.setButtonStateAction("send",!1):console.error("AIPKit Clear Action: actions.setButtonStateAction function not provided."),i.isSending=!1,i.currentStreamId=null,i.currentStreamMessageId=null,window.aipkit_current_conversation_uuid=null,window.aipkit_is_fresh_session=!0,sessionStorage.removeItem("aipkit_current_conversation_uuid"),window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id"),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),typeof window.aipkit_regenerateConversationUUID=="function"&&window.aipkit_regenerateConversationUUID(),typeof o.focusInputAction=="function"&&(!e.requireConsentCompliance||i.consentGiven)?o.focusInputAction():typeof o.focusInputAction!="function"&&console.error("AIPKit Clear Action: actions.focusInputAction function not provided.");let u=t.closest(".aipkit_chat_container")||t.closest(".aipkit_popup_wrapper");u&&u.dispatchEvent(new CustomEvent("aipkit:chatCleared"))}window.aipkit_chatUI_clearChatAction=c})();(function(){"use strict";async function c(n,e,i,o,t=null){let{inputField:r,messagesEl:a,container:s,inputArea:l}=n,p=e.botId,d=null;if(window.aipkit_active_file_context_data&&typeof window.aipkit_active_file_context_data=="object"&&window.aipkit_active_file_context_data!==null&&Object.keys(window.aipkit_active_file_context_data).length>0&&window.aipkit_active_file_context_data.provider){let I=!1,k=window.aipkit_active_file_context_data;(k.provider==="OpenAI"&&k.vector_store_id||k.provider==="Pinecone"&&k.index_name&&k.namespace||k.provider==="Qdrant"&&k.collection_name&&k.file_upload_context_id)&&(I=!0),I?d={...k}:(console.warn(`SendMessageAction (${p}): File context data found on window object, but missing required fields for provider: ${k.provider||"unknown"}. Context ignored. Data:`,k),d=null)}let u=null;if(e.imageUploadEnabledUI&&window.chatImageUpload&&typeof window.chatImageUpload.getImageData=="function"&&(u=window.chatImageUpload.getImageData(),u&&n.imagePreviewContainer&&n.imageUploadInput&&typeof window.chatImageUpload.reset=="function"&&window.chatImageUpload.reset(n.imagePreviewContainer,n.imageUploadInput)),window.aipkitChatFileUpload&&typeof window.aipkitChatFileUpload.resetUI=="function"&&n.fileUploadInput&&l){let I=window.aipkitFileUploadState;(d||I&&I.currentFile)&&window.aipkitChatFileUpload.resetUI(n.fileUploadInput,l)}let _=i.consentUIInstance;if(_&&typeof _.showConsentBoxIfNeeded=="function"&&_.showConsentBoxIfNeeded()){console.warn(`AIPKit SendMessage (${p}): Cannot send message, consent required and box shown.`);return}if(e.requireConsentCompliance&&!i.consentGiven){console.warn(`AIPKit SendMessage (${p}): Consent required but not given.`);return}let f=t!==null?t.trim():r.value.trim();if(i.isSending||!f&&!u&&!d||t===null&&(i.buttonState!=="send"||n.actionButton.disabled))return;let w=!1;(window.aipkit_is_fresh_session||!window.aipkit_current_conversation_uuid)&&(typeof window.aipkit_regenerateConversationUUID=="function"&&(window.aipkit_current_conversation_uuid||(window.aipkit_regenerateConversationUUID(),window.aipkit_active_file_context_data&&typeof window.aipkit_active_file_context_data=="object"&&window.aipkit_active_file_context_data!==null&&Object.keys(window.aipkit_active_file_context_data).length>0&&window.aipkit_active_file_context_data.provider&&(d={...window.aipkit_active_file_context_data}))),w=!0);let m=window.aipkit_generateClientMessageId(p),h=f;u&&(h={text:f,user_image:u}),window.aipkit_chatUI_appendMessage(a,h,"user",e,!1,!1,m,!0),t===null&&(r.value="",typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(r)),w&&(window.aipkit_is_fresh_session=!1);let g=(e.imageTriggers||"/image").toLowerCase().split(",").map(I=>I.trim()).filter(I=>I.length>0&&I.startsWith("/")),y=f.toLowerCase(),b=null;for(let I of g)if(y.startsWith(I+" ")||y===I){b=I;break}if(b){let I=f.substring(b.length).trim();if(!I&&y!==b){let k=(e.text.imageCommandEmptyPrompt||"Please provide description after /image.").replace("[trigger]",b);o.handleError(k,!1,!0),t===null&&(i.buttonState=o.setButtonStateAction("send",!1));return}typeof window.aipkit_chatUI_handleImageGeneration=="function"?window.aipkit_chatUI_handleImageGeneration(I,f,m,w,{state:i,elements:n,config:e,...o}):(console.error("AIPKit SendMessage: aipkit_chatUI_handleImageGeneration function not found."),o.handleError("Image generation feature unavailable.",!1,!0));return}if(typeof window.aipkit_checkMessageModeration=="function"){let I=window.aipkit_checkMessageModeration(f,e.userIp,e.bannedIpsConfig,e.bannedWordsConfig);if(I){let k=window.aipkit_generateClientMessageId(p);window.aipkit_chatUI_appendMessage(a,I.message,"bot",e,!0,!1,k),i.buttonState=o.setButtonStateAction("send",!1),o.focusInputAction(),s.dispatchEvent(new CustomEvent("aipkit:messageBlocked",{detail:{messageId:k,reason:I.type,content:f,...I.word&&{word:I.word},...I.ip&&{ip:I.ip}}}));return}}if(i.isSending=!0,r.disabled=!0,n.voiceInputButton&&(n.voiceInputButton.disabled=!0),n.inputActionButton&&(n.inputActionButton.disabled=!0),n.webSearchToggleButton&&(n.webSearchToggleButton.disabled=!0),n.googleSearchGroundingToggleButton&&(n.googleSearchGroundingToggleButton.disabled=!0),i.buttonState=o.setButtonStateAction(e.streamEnabled?"streaming":"sending",!0),s.dispatchEvent(new CustomEvent("aipkit:messageSent",{detail:{messageId:m}})),e.streamEnabled&&typeof window.aipkit_chatUI_streamMessage=="function")window.aipkit_chatUI_showTypingIndicator(a,e),window.aipkit_chatUI_streamMessage(f,p,e,a,o.handleError,()=>o.handleCompletion(i.currentStreamMessageId,w),i.webSearchToolActive,i.googleSearchGroundingActive,u,d,m);else if(!e.streamEnabled&&typeof window.aipkit_chatUI_sendMessage=="function")window.aipkit_chatUI_showTypingIndicator(a,e),window.aipkit_chatUI_sendMessage(f,p,e,n,(I,k,S,A)=>{window.aipkit_chatUI_removeTypingIndicator(a),window.aipkit_chatUI_appendMessage(a,I,"bot",e,!1,!1,k,!0,A),o.handleCompletion(k,w)},o.handleError,()=>{},i.webSearchToolActive,i.googleSearchGroundingActive,u,d,m);else{let I=e.streamEnabled?e.text.streamError||"Streaming function not loaded.":e.text.connError||"Send message function not loaded.";console.error(`AIPKit SendMessage (${p}): Required send function not available.`),o.handleError(I,!1)}}window.aipkit_chatUI_sendMessageAction=c})();(function(){"use strict";function c(n,e){if(!n||typeof e!="object"||Object.keys(e).length===0)return;let i=n.dataset.botId||"unknown",o=0;for(let t in e)if(Object.prototype.hasOwnProperty.call(e,t)&&e[t]!==""&&e[t]!==null){let r=`--aipkit-chat-${t.replace(/_/g,"-")}`,a=e[t];t==="container_max_height"||t==="popup_max_height"?a=e[t]+"vh":t==="container_max_width"||t==="popup_width"||t==="container_height"||t==="container_min_height"||t==="popup_height"||t==="popup_min_height"?a=e[t]+"px":(t==="bubble_border_radius"||t==="container_border_radius")&&typeof a=="number"?a=a===0?"0":`${a}px`:(t==="bubble_border_radius"||t==="container_border_radius")&&typeof a=="string"&&/^\d+$/.test(a)&&(a=a==="0"?"0":`${a}px`),n.style.setProperty(r,a),o++}}window.aipkit_chatUI_applyCustomThemeStyles=c})();(function(){"use strict";function c(n){let i=`aipkit_chatbot_consent_given_${n.botId||"default"}`;return{buttonState:"send",isPopupOpen:!1,isSending:!1,currentStreamId:null,isFullscreen:!1,isSidebarOpen:!1,currentStreamMessageId:null,isActionMenuOpen:!1,activeInputActionMenu:null,activeInputActionTrigger:null,closeActionMenuHandler:null,consentGiven:localStorage.getItem(i)==="true",isRecording:!1,webSearchToolActive:!1,googleSearchGroundingActive:!1}}window.aipkit_chatUI_initState=c})();(function(){"usegistrict";function c(n,e){if(!n||!e||!e.text){console.error("AIPKit InitialMessage: Missing messagesEl or config.");return}let i=e.botId||"default";if(n.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").forEach(t=>{try{n.removeChild(t)}catch{}}),!n.querySelector(".aipkit_initial_greeting")){let t=e.text.initialGreeting||"Hello!";if(typeof window.aipkit_chatUI_appendMessage=="function"&&typeof window.aipkit_generateClientMessageId=="function")window.aipkit_chatUI_appendMessage(n,t,"bot",e,!1,!0,window.aipkit_generateClientMessageId(i));else{console.error("AIPKit InitialMessage: appendMessage or generateClientMessageId function not found.");let r=document.createElement("div");r.className="aipkit_chat_message aipkit_chat_message-bot aipkit_initial_greeting",r.innerHTML=`<div class="aipkit_chat_bubble">${t.replace(/\n/g,"<br>")}</div>`,n.appendChild(r)}}}window.aipkit_chatUI_displayInitialMessage=c})();(function(){"use strict";function c(n,e,i,o){let{inputField:t,messagesEl:r,container:a}=n,s=e.botId;i.buttonState=o.setButtonStateAction("send",!1,i),typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(t),e.popupEnabled||typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(r,!0),t.disabled=e.requireConsentCompliance&&!i.consentGiven,n.voiceInputButton&&(n.voiceInputButton.disabled=e.requireConsentCompliance&&!i.consentGiven),n.inputActionButton&&(n.inputActionButton.disabled=e.requireConsentCompliance&&!i.consentGiven),n.webSearchToggleButton&&e.allowWebSearchTool&&e.provider==="OpenAI"&&(n.webSearchToggleButton.disabled=e.requireConsentCompliance&&!i.consentGiven),n.googleSearchGroundingToggleButton&&e.allowGoogleSearchGrounding&&e.provider==="Google"&&(n.googleSearchGroundingToggleButton.disabled=e.requireConsentCompliance&&!i.consentGiven),a.dispatchEvent(new CustomEvent("aipkit:chatLoaded",{detail:{botId:s}}))}window.aipkit_chatUI_finalizeSetup=c})();(function(){"use strict";function c(n,e,i,o){if(!n||!i||!o||o.isPopupOpen)return;try{n._aipkitHint&&(typeof n._aipkitHint.hideHint=="function"&&n._aipkitHint.hideHint(),typeof n._aipkitHint.markSeen=="function"&&n._aipkitHint.markSeen())}catch{}n.classList.add("aipkit-popup-open"),n.setAttribute("aria-hidden","false"),o.isPopupOpen=!0,typeof window.aipkit_chatUI_scrollToBottom=="function"?window.aipkit_chatUI_scrollToBottom(e):console.error("AIPKit Popup Open: scrollToBottom function not found.");let t=n.closest("#aipkit_admin_chat_preview_container");(!(window.innerWidth<=760)||t)&&setTimeout(()=>{i&&typeof i.focus=="function"&&i.focus()},50)}window.aipkit_chatUI_openPopup=c})();(function(){"use strict";function c(n,e){!n||!e||!e.isPopupOpen||(n.classList.remove("aipkit-popup-open"),n.setAttribute("aria-hidden","true"),e.isPopupOpen=!1)}window.aipkit_chatUI_closePopup=c})();(function(){"use strict";function c(n,e,i,o,t,r,a){if(!n||!e||!r||!a){console.warn("AIPKit Chat Popup Handlers: Missing elements for setup (container, trigger, stateRef, or config).");return}i||console.warn("AIPKit Chat Popup Handlers: Close button not found. Popup cannot be closed via button.");try{let s=n.closest(".aipkit_popup_wrapper"),l=s?s.querySelector(".aipkit_popup_hint"):null,p=window.innerWidth<=760,d=!!n.closest("#aipkit_admin_chat_preview_container"),u=a.popupLabelVersion&&String(a.popupLabelVersion).trim()||"v1",_=`aipkit_popup_hint_seen_${a.botId}_${u}`,f=`aipkit_popup_hint_dismissed_${a.botId}_${u}`,w=d?"always":a.popupLabelFrequency||"once_per_visitor",m=a.popupLabelMode||"on_delay",h=(a.popupLabelDelaySeconds>0?a.popupLabelDelaySeconds:0)*1e3,g=(a.popupLabelAutoHideSeconds>0?a.popupLabelAutoHideSeconds:0)*1e3,y=!!a.popupLabelDismissible,b=w==="once_per_session"?sessionStorage:localStorage,I=C=>{try{return b.getItem(C)}catch{return null}},k=()=>w==="always"?!0:m==="on_delay"||m==="until_open"?!I(_):m==="until_dismissed"?!I(f):!0,S=()=>{if(w!=="always")try{b.setItem(_,"1")}catch{}},A=()=>{if(w!=="always")try{b.setItem(f,"1")}catch{}},v=null,L=null,H=()=>{l&&(l.classList.add("aipkit-visible"),l.setAttribute("aria-hidden","false"))},F=()=>{l&&(l.classList.remove("aipkit-visible"),l.setAttribute("aria-hidden","true"),L&&(clearTimeout(L),L=null))},M=()=>{l&&(!a.popupLabelEnabled||!a.popupLabelText||p&&!a.popupLabelShowOnMobile||!p&&!a.popupLabelShowOnDesktop||k()&&(v&&(clearTimeout(v),v=null),v=setTimeout(()=>{H(),m==="on_delay"&&(S(),g>0&&(L=setTimeout(F,g)))},h)))};if(l&&y){let C=l.querySelector(".aipkit_popup_hint_close");C&&C.addEventListener("click",x=>{x.stopPropagation(),F(),m==="until_dismissed"?A():S()})}if(l)try{let C=window.getComputedStyle(n),x=n.querySelector(".aipkit_chat_header"),q=x?window.getComputedStyle(x):null,U="",E="";if(q){let P=q.getPropertyValue("background-color").trim(),B=q.getPropertyValue("color").trim();P&&(U=P),B&&(E=B)}U||(U=C.getPropertyValue("--aipkit-chat-header-bg-color").trim()),U||(U=C.getPropertyValue("--aipkit_brand-primary").trim()),U||(U="#4a6fa5"),E||(E=C.getPropertyValue("--aipkit-chat-header-text-color").trim()),E||(E="#ffffff");let $=s||n;U&&$.style.setProperty("--aipkit-chat-popup-hint-bg",U);let O=C.getPropertyValue("--aipkit-chat-bot-bubble-text-color").trim(),T="";if(O)T=O;else if(E)T=E;else if(U){let P=U.match(/rgba?\((\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})/i);if(P){let B=parseInt(P[1],10),D=parseInt(P[2],10),K=parseInt(P[3],10);T=(B*299+D*587+K*114)/1e3>200?"#2d3748":"#ffffff"}else T="#2d3748"}else T="#2d3748";T&&$.style.setProperty("--aipkit-chat-popup-hint-text-color",T)}catch{}M(),n._aipkitHint={scheduleShow:M,hideHint:F,markSeen:S}}catch(s){console.warn("AIPKit Popup Hint: setup error",s)}if(!a.directVoiceMode){if(typeof window.aipkit_chatUI_openPopup!="function"||typeof window.aipkit_chatUI_closePopup!="function"){console.error("AIPKit Chat Popup Handlers: Missing openPopup or closePopup helper functions.");return}e.addEventListener("click",s=>{s.stopPropagation(),r.isPopupOpen?(window.aipkit_chatUI_closePopup(n,r),typeof e.blur=="function"&&e.blur(),n._aipkitHint&&a.popupLabelEnabled&&a.popupLabelFrequency==="always"&&n._aipkitHint.scheduleShow()):(n._aipkitHint&&(n._aipkitHint.hideHint?.(),a.popupLabelMode==="until_open"&&n._aipkitHint.markSeen?.()),window.aipkit_chatUI_openPopup(n,o,t,r))}),i&&i.addEventListener("click",s=>{s.stopPropagation(),window.aipkit_chatUI_closePopup(n,r),typeof e.blur=="function"&&e.blur(),n._aipkitHint&&a.popupLabelEnabled&&a.popupLabelFrequency==="always"&&n._aipkitHint.scheduleShow()}),document.addEventListener("keydown",s=>{s.key==="Escape"&&r.isPopupOpen&&(window.aipkit_chatUI_closePopup(n,r),typeof e.blur=="function"&&e.blur(),n._aipkitHint&&a.popupLabelEnabled&&a.popupLabelFrequency==="always"&&n._aipkitHint.scheduleShow())})}}window.aipkit_chatUI_setupPopupHandlers=c})();(function(){"use strict";function c(n,e){let i=new Date,o=`${i.getFullYear()}${String(i.getMonth()+1).padStart(2,"0")}${String(i.getDate()).padStart(2,"0")}-${String(i.getHours()).padStart(2,"0")}${String(i.getMinutes()).padStart(2,"0")}`;return`chat-${n.botId||"transcript"}-${o}.${e}`}window.aipkit_chatUI_generateDownloadFilename=c})();(function(){"use strict";function c(n,e){let i=document.createElement("a");if(typeof i.download=="string")i.href=URL.createObjectURL(n),i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(i.href);else{console.warn("AIPKit Chat Download: Download attribute not supported, opening in new window.");let o=URL.createObjectURL(n);window.open(o,"_blank")}}window.aipkit_chatUI_triggerBlobDownload=c})();(function(){"use strict";function c(n,e){let{messagesEl:i}=n;if(!i||!e||!e.text){console.error("AIPKit Download TXT: Missing messages element or config.");return}let o="",t=i.querySelectorAll(".aipkit_chat_message"),r=e?.headerName||"Bot",a=e.text.userPrefix||"User",s=e.text.errorPrefix||"Error";if(t.forEach(d=>{let u=d.querySelector(".aipkit_chat_bubble");if(!u)return;if(typeof window.aipkit_chatUI_extractTextFromBubble!="function"){console.error("AIPKit Download TXT: extractTextFromBubble function not found."),o+=`Error: Could not extract text.
`;return}let _=window.aipkit_chatUI_extractTextFromBubble(u),f="";d.classList.contains("aipkit_chat_message-user")?f=`[${a}]:`:d.classList.contains("aipkit_chat_message-bot")?f=`[${r}]:`:d.classList.contains("aipkit_chat_message-error")&&(f=`[${s}]:`),f&&_&&(o+=`${f}
${_}

`)}),o=o.trim(),!o){console.warn("AIPKit Chat Download TXT: No transcript content found."),alert(e.text.downloadEmpty||"Nothing to download.");return}let l=new Blob([o],{type:"text/plain;charset=utf-8"});if(typeof window.aipkit_chatUI_generateDownloadFilename!="function"||typeof window.aipkit_chatUI_triggerBlobDownload!="function"){console.error("AIPKit Download TXT: generateDownloadFilename or triggerBlobDownload function not found."),alert("Error: Could not prepare download.");return}let p=window.aipkit_chatUI_generateDownloadFilename(e,"txt");window.aipkit_chatUI_triggerBlobDownload(l,p)}window.aipkit_chatUI_downloadTranscriptActionTxt=c})();(function(){"use strict";let c="aipkit_sidebar_state_";function n(e){return`${c}${e||"default"}`}window.aipkit_sidebar_getStorageKey=n})();(function(){"use strict";function c(n,e){if(!e||!n)return;let i=n.querySelector(".aipkit_chat_footer");if(!i){e.style.display="none";return}if(window.getComputedStyle(i).display!=="none"&&window.getComputedStyle(i).visibility!=="hidden"&&i.offsetHeight>0){let t=i.offsetHeight;t>0&&(e.style.height=`${t}px`),e.style.display="block"}else e.style.display="none"}window.aipkit_sidebar_syncFooterVisibility=c})();(function(){"use strict";function n(e,i,o,t,r){let a=window.innerWidth<=760;r.mobileOverlayHandler&&(document.removeEventListener("click",r.mobileOverlayHandler,!0),r.mobileOverlayHandler=null),e&&a&&(r.mobileOverlayHandler=t,setTimeout(()=>{document.addEventListener("click",r.mobileOverlayHandler,{capture:!0,once:!1})},50))}window.aipkit_sidebar_manageMobileOverlayListener=n})();(function(){"use strict";function c(n,e,i,o,t,r,a,s,l,p){!e||!i||(e.classList.toggle("aipkit-sidebar-state-open",n),e.classList.toggle("aipkit-sidebar-state-closed",!n),i.setAttribute("aria-expanded",n.toString()),localStorage.setItem(o,n?"open":"closed"),typeof t=="function"&&a&&t(e,a.querySelector(".aipkit_sidebar_footer")),typeof r=="function"&&a&&r(n,a,i,l,s))}window.aipkit_sidebar_applyCurrentState=c})();(function(){"use strict";function c(n,e,i){let o=n.isSidebarOpen;n.isSidebarOpen=!n.isSidebarOpen,!o&&n.isSidebarOpen&&typeof i=="function"&&i()}window.aipkit_sidebar_toggleSidebar=c})();(function(){"use strict";function n(e,i,o,t){let r=e.config?.botId||"unknown";if(typeof e.clearChatAction=="function"){e.clearChatAction();let a=i?i.querySelector(".aipkit_conversation_item.aipkit_active"):null;a&&a.classList.remove("aipkit_active"),window.innerWidth<=760&&o.isSidebarOpen&&typeof t=="function"&&t()}else console.error(`AIPKit Sidebar (${r}): clearChatAction is not a function in actions object.`)}window.aipkit_sidebar_handleNewChat=n})();(function(){"use strict";function c(n,e,i){let o=e.botId||"unknown";if(!n||!e||!i){console.error(`AIPKit Sidebar (${o}): Missing elements or functions for fetchConversationList.`),n&&(n.innerHTML='<p style="text-align:center; color:red;">Error: Cannot load list.</p>');return}if(!e.nonce){n.innerHTML=`<p style="text-align:center; padding:10px; font-style:italic; color: var(--aipkit_text-secondary); font-size:12px;">${e.text.historyGuests||"History unavailable."}</p>`;return}n.innerHTML='<p style="text-align:center; padding:10px;"><span class="aipkit_spinner" style="display:inline-block;width:16px;height:16px;"></span></p>',window.aipkit_frontendApiRequest("aipkit_get_conversations_list",{},e).then(t=>{typeof i=="function"?i(t.conversations||[]):(console.error(`AIPKit Sidebar (${o}): renderConversationListFunc is not a function.`),n.innerHTML='<p style="text-align:center; color:red;">Error: Cannot display list.</p>')}).catch(t=>{console.error(`AIPKit Sidebar (${o}): Error fetching conversation list:`,t),n.innerHTML=`<p style="text-align:center; color:red;">Error loading list: ${t.message||"Unknown error"}</p>`})}window.aipkit_sidebar_fetchConversationList=c})();(function(){"use strict";function n(e,i,o,t,r,a,s){let l=o.botId||"unknown",p='<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-x"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 6l-12 12" /><path d="M6 6l12 12" /></svg>';if(!i||!o||!t||typeof r!="function"||typeof a!="function"||typeof s!="function"){console.error(`AIPKit Sidebar (${l}): Missing elements or functions for renderConversationList.`),i&&(i.innerHTML='<p style="text-align:center; color:red;">Error: Cannot render list.</p>');return}if(!e||e.length===0){i.innerHTML=`<p style="text-align:center; padding:10px; font-style:italic; color: var(--aipkit_text-secondary); font-size:12px;">${o.text.historyEmpty||"No past conversations."}</p>`;return}i.innerHTML="";let d=window.aipkit_current_conversation_uuid||null;e.forEach(u=>{let _=document.createElement("div");_.className="aipkit_conversation_item",_.setAttribute("data-conversation-id",u.id);let f=document.createElement("span");f.textContent=u.title||u.id.substring(0,8),f.title=`${u.title||u.id.substring(0,8)} (ID: ${u.id})`,_.appendChild(f);let w=document.createElement("button");w.type="button",w.className="aipkit_conversation_item_delete_btn",w.setAttribute("aria-label",`Delete conversation: ${f.title}`),w.innerHTML=p,w.title="Delete Conversation",_.appendChild(w);let m=document.createElement("span");m.className="aipkit_conversation_item_spinner aipkit_spinner",_.appendChild(m),d&&u.id===d&&_.classList.add("aipkit_active"),_.addEventListener("click",h=>{h.target.closest(".aipkit_conversation_item_delete_btn")||t.isDeletingId===u.id||(r(u.id),window.innerWidth<=760&&t.isSidebarOpen&&s())}),w.addEventListener("click",h=>{h.stopPropagation(),!t.isDeletingId&&a(u.id,_)}),i.appendChild(_)})}window.aipkit_sidebar_renderConversationList=n})();(function(){"use strict";function c(n,e,i,o,t,r){let a=o.botId||"unknown";if(t.isDeletingId)return;t.isDeletingId=n;let s=e.querySelector(".aipkit_conversation_item_delete_btn"),l=e.querySelector(".aipkit_conversation_item_spinner");s&&(s.style.display="none"),l&&(l.style.display="inline-block"),e.style.opacity="0.6";let p={bot_id:a,conversation_uuid:n};window.aipkit_frontendApiRequest("aipkit_delete_single_conversation",p,o).then(d=>{e.style.transition="opacity 0.3s ease-out, max-height 0.3s ease-out",e.style.opacity="0",e.style.maxHeight="0",e.style.padding="0",e.style.marginBottom="0",e.style.overflow="hidden",setTimeout(()=>{e.parentNode&&e.remove(),i&&i.childElementCount===0&&(i.innerHTML=`<p style="text-align:center; padding:10px; font-style:italic; color: var(--aipkit_text-secondary); font-size:12px;">${o.text.historyEmpty||"No past conversations."}</p>`)},300),window.aipkit_current_conversation_uuid===n&&(typeof r.clearChatAction=="function"?r.clearChatAction():console.error(`AIPKit Sidebar (${a}): clearChatAction is not a function in actions object.`))}).catch(d=>{alert(`Error deleting conversation: ${d.message||"Unknown error"}`),s&&(s.style.display="inline-flex"),l&&(l.style.display="none"),e.style.opacity="1"}).finally(()=>{t.isDeletingId=null})}window.aipkit_sidebar_handleDeleteConversation=c})();(function(){"use strict";function n(e,i,o,t,r,a,s){let l=t.botId||"unknown";if(!e||r.isDeletingId===e)return;sessionStorage.setItem("aipkit_current_conversation_uuid",e),window.aipkit_current_conversation_uuid=e,window.aipkit_is_fresh_session=!1,window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id");try{let d=localStorage.getItem(`aipkit_file_context_${e}`);if(d){let u=JSON.parse(d),_=!1;u&&u.provider&&(u.provider==="OpenAI"&&u.vector_store_id||u.provider==="Pinecone"&&u.index_name&&u.namespace||u.provider==="Qdrant"&&u.collection_name&&u.file_upload_context_id)&&(_=!0),_?(window.aipkit_active_file_context_provider=u.provider,window.aipkit_active_file_context_data=u,sessionStorage.setItem("aipkit_active_file_context_provider",window.aipkit_active_file_context_provider),sessionStorage.setItem("aipkit_active_file_context_data",JSON.stringify(window.aipkit_active_file_context_data)),document.dispatchEvent(new CustomEvent("aipkit:fileContextRestored",{detail:u}))):(console.warn(`AIPKit Sidebar (${l}): Invalid file context data in localStorage for conv ${e}. Clearing. Data:`,u),localStorage.removeItem(`aipkit_file_context_${e}`),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")))}else window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"))}catch(d){console.error("AIPKit Sidebar: Error handling localStorage for file context:",d),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"))}(i?i.querySelectorAll(".aipkit_conversation_item"):[]).forEach(d=>{d.classList.remove("aipkit_active"),d.getAttribute("data-conversation-id")===e&&d.classList.add("aipkit_active")}),typeof window.aipkit_chatUI_clearMessages=="function"?(window.aipkit_chatUI_clearMessages(o),o.innerHTML='<div class="aipkit_detail_spinner" style="margin: 20px auto; display: block;"><span class="aipkit_spinner"></span></div>'):o.innerHTML="",window.aipkit_frontendApiRequest("aipkit_get_conversation_history",{},t).then(d=>{o.innerHTML="";let u=d.history||[];if(u.length===0)typeof window.aipkit_chatUI_appendMessage=="function"&&t.text.initialGreeting?typeof window.aipkit_generateClientMessageId=="function"&&window.aipkit_chatUI_appendMessage(o,t.text.initialGreeting,"bot",t,!1,!0,window.aipkit_generateClientMessageId(l)):o.innerHTML=`<p style="text-align:center; font-style: italic; padding: 20px;">${t.text.historyEmpty||"No past messages."}</p>`;else{let f=null;u.forEach(w=>{let m=w.role==="assistant"||w.role==="bot"?"bot":"user",h=w.content||"";w.response_data&&w.response_data.type==="image"&&w.response_data.images&&w.response_data.images.length>0&&(h={type:"image",images:w.response_data.images,prompt:w.request_payload?.prompt||w.content}),w.response_data&&w.response_data.type==="user_image_upload"&&w.response_data.images&&w.response_data.images.length>0&&(h={text:w.content||"",user_image:w.response_data.images[0]}),window.aipkit_chatUI_appendMessage(o,h,m,t,w.role==="bot"&&(w.content||"").startsWith("Error:"),!1,w.message_id||null,!1,w.grounding_metadata||null),(m==="bot"||m==="assistant")&&w.openai_response_id&&(f=w.openai_response_id)}),f&&(window.aipkit_current_openai_response_id=f,sessionStorage.setItem("aipkit_current_openai_response_id",f)),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(o,!0)}typeof a.setButtonStateAction=="function"&&a.setButtonStateAction("send",!1),typeof a.focusInputAction=="function"&&a.focusInputAction();let _=o.closest(".aipkit_chat_container");_&&_.dispatchEvent(new CustomEvent("aipkit:historyLoaded",{detail:{conversationUUID:e}}))}).catch(d=>{o.innerHTML=`<p style="color:red;text-align:center;">Error loading history: ${d.message||"Unknown error"}</p>`,typeof a.setButtonStateAction=="function"&&a.setButtonStateAction("send",!1)})}window.aipkit_sidebar_loadConversation=n})();(function(){"use strict";function n(e,i,o,t){let{sidebarToggleBtn:r,sidebarEl:a,newChatBtn:s}=i,l=e.querySelector(".aipkit_chat_messages"),p=e.querySelector(".aipkit_chat_main"),d=a?a.querySelector(".aipkit_sidebar_content"):null,u=a?a.querySelector(".aipkit_sidebar_footer"):null;if(!e||!r||!a||!d||!l||!p){console.warn("AIPKit Sidebar (Orchestrator): Missing required elements. Sidebar init aborted.",{container:e,sidebarToggleBtn:r,sidebarEl:a,sidebarContentEl:d,messagesEl:l,mainContentEl:p});return}let _=o.botId;if(!_){console.error("AIPKit Sidebar (Orchestrator): Bot ID missing, cannot initialize."),r.disabled=!0,s&&(s.disabled=!0),d.innerHTML='<p style="text-align:center; padding:10px; font-style:italic; color: var(--aipkit_text-secondary); font-size:12px;">Configuration Error</p>';return}let f={isSidebarOpen:!1,isDeletingId:null,mobileOverlayHandler:null},w=window.aipkit_sidebar_getStorageKey(_),m=localStorage.getItem(w);f.isSidebarOpen=m==="open";let h=A=>{f.isSidebarOpen&&window.innerWidth<=760&&!a.contains(A.target)&&!r.contains(A.target)&&k()},g=A=>window.aipkit_sidebar_applyCurrentState(f.isSidebarOpen,e,r,w,window.aipkit_sidebar_syncFooterVisibility,window.aipkit_sidebar_manageMobileOverlayListener,a,f,h,A),y=()=>window.aipkit_sidebar_fetchConversationList(d,o,A=>window.aipkit_sidebar_renderConversationList(A,d,o,f,b,I,k)),b=A=>window.aipkit_sidebar_loadConversation(A,d,l,o,f,t,k),I=(A,v)=>window.aipkit_sidebar_handleDeleteConversation(A,v,d,o,f,t),k=()=>{window.aipkit_sidebar_toggleSidebar(f,g,y),g(f.isSidebarOpen)};typeof window.aipkit_sidebar_syncFooterVisibility=="function"&&(window.aipkit_sidebar_syncFooterVisibility(e,u),new MutationObserver(()=>window.aipkit_sidebar_syncFooterVisibility(e,u)).observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]})),g(!1),r.addEventListener("click",k),s&&typeof window.aipkit_sidebar_handleNewChat=="function"&&typeof t.clearChatAction=="function"?(s.addEventListener("click",()=>window.aipkit_sidebar_handleNewChat(t,d,f,k)),s.disabled=!1):s&&(s.disabled=!0,console.warn(`AIPKit Sidebar (${_}): New Chat button disabled, clearChatAction or handleNewChat helper missing.`)),window.addEventListener("resize",()=>{f.isSidebarOpen&&typeof window.aipkit_sidebar_manageMobileOverlayListener=="function"&&window.aipkit_sidebar_manageMobileOverlayListener(f.isSidebarOpen,a,r,h,f)}),(f.isSidebarOpen||!o.nonce)&&y();let S=A=>{A.detail&&A.detail.newConversation&&f.isSidebarOpen&&y()};e.addEventListener("aipkit:messageReceived",S)}window.aipkit_initConversationSidebar=n})();(function(){"use strict";function c(n){if(!n)return"";let e="",i=n.childNodes;function o(t){if(t.nodeType===Node.TEXT_NODE)return t.textContent;if(t.nodeName==="BR")return`
`;if(t.nodeType===Node.ELEMENT_NODE){let r="";return["P","UL","OL","H1","H2","H3","H4","H5","H6","PRE","BLOCKQUOTE","HR","DIV"].includes(t.tagName)&&(r+=`
`),t.tagName==="LI"&&(r+="- "),t.childNodes.forEach(a=>{r+=o(a)}),["P","UL","OL","H1","H2","H3","H4","H5","H6","PRE","BLOCKQUOTE","HR","DIV","LI"].includes(t.tagName)&&(r+=`
`),r}return""}return i.forEach(t=>{e+=o(t)}),e.replace(/\n\s*\n/g,`

`).replace(/^\s+|\s+$/g,"")}window.aipkit_chatUI_extractTextFromBubble=c})();(function(){"use strict";function c(n,e=1500){let i=n;if(!i){console.warn("AIPKit showSuccessIcon: Button element not found:",n);return}i.dataset.originalIconHtml||(i.dataset.originalIconHtml=i.innerHTML);let o='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-check"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5l10 -10" /></svg>';if(n.dataset.successTimeoutId||n.disabled)return;i.innerHTML=o;let t=i.querySelector("svg");t&&(t.style.color="var(--aipkit_status-success, #38A169)"),n.dataset.successTimeoutId&&clearTimeout(parseInt(n.dataset.successTimeoutId,10));let r=setTimeout(()=>{let a=i.dataset.originalIconHtml;a&&(i.innerHTML=a),delete i.dataset.originalIconHtml,delete n.dataset.successTimeoutId},e);n.dataset.successTimeoutId=r.toString()}window.aipkit_chatUI_showSuccessIcon=c})();(function(){"use strict";function c(n,e){let i=n.target.closest(".aipkit_copy_btn");if(!i||i.disabled||i.dataset.successTimeoutId)return;let o=i.closest(".aipkit_chat_message"),t=o?o.querySelector(".aipkit_chat_bubble"):null;if(!o||!t){console.error("AIPKit Message Actions: Could not find parent message container or bubble for copy button.");return}if(typeof window.aipkit_chatUI_extractTextFromBubble!="function"||typeof window.aipkit_chatUI_showSuccessIcon!="function"){console.error("AIPKit Copy Action: Missing required helper functions (extractTextFromBubble or showSuccessIcon).");return}let r=window.aipkit_chatUI_extractTextFromBubble(t);if(!r){console.warn("AIPKit Copy Action: No text extracted from bubble to copy.");return}if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function")navigator.clipboard.writeText(r).then(()=>{window.aipkit_chatUI_showSuccessIcon(i)}).catch(a=>{console.error("AIPKit Message Actions: Clipboard API failed:",a)});else{console.warn("AIPKit Message Actions: Using fallback copy method.");try{let a=document.createElement("textarea");a.value=r,a.style.position="fixed",a.style.top="-9999px",a.style.left="-9999px",a.style.opacity="0",document.body.appendChild(a),a.focus(),a.select();let s=document.execCommand("copy");if(document.body.removeChild(a),s)window.aipkit_chatUI_showSuccessIcon(i);else throw new Error("execCommand failed")}catch(a){console.error("AIPKit Message Actions: Fallback copy method failed:",a)}}}window.aipkit_chatUI_handleCopyAction=c})();(function(){"use strict";function c(n,e){let i=n.target.closest(".aipkit_feedback_btn");if(!i||i.disabled||i.classList.contains("aipkit_feedback_selected"))return;let o=i.getAttribute("data-feedback"),t=i.closest(".aipkit_chat_message"),r=t?t.getAttribute("data-message-id"):null,a=i.closest(".aipkit_message_actions");if(!r||!o||!a){console.error("AIPKit Feedback: Missing message ID, feedback type, or actions container.");return}let s=a.querySelectorAll(".aipkit_feedback_btn");if(s.forEach(p=>{p.disabled=!0,p===i?p.classList.add("aipkit_feedback_selected"):(p.classList.remove("aipkit_feedback_selected"),p.style.opacity="0.4")}),typeof window.aipkit_frontendApiRequest!="function"){console.error("AIPKit Feedback Error: aipkit_frontendApiRequest function not found."),s.forEach(p=>{p.disabled=!1,p.classList.remove("aipkit_feedback_selected"),p.style.opacity="1"});return}let l={message_id:r,feedback_type:o};window.aipkit_frontendApiRequest("aipkit_store_feedback",l,e).then(p=>{console.log(`AIPKit Feedback (${e.botId}): Feedback stored successfully for ${r}.`,p)}).catch(p=>{console.error(`AIPKit Feedback (${e.botId}): Error storing feedback for ${r}:`,p),s.forEach(d=>{d.disabled=!1,d.classList.remove("aipkit_feedback_selected"),d.style.opacity="1"})})}window.aipkit_chatUI_handleFeedbackAction=c})();(function(){"use strict";function c(n){let e='<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-player-play"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 4v16l13 -8z" /></svg>',i='<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-copy"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg>',o='<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-thumb-up"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 11v8a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1v-7a1 1 0 0 1 1 -1h3a4 4 0 0 0 4 -4v-1a2 2 0 0 1 4 0v5h3a2 2 0 0 1 2 2l-1 5a2 3 0 0 1 -2 2h-7a3 3 0 0 1 -3 -3" /></svg>',t='<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-thumb-down"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 13v-8a1 1 0 0 0 -1 -1h-2a1 1 0 0 0 -1 1v7a1 1 0 0 0 1 1h3a4 4 0 0 1 4 4v1a2 2 0 0 0 4 0v-5h3a2 2 0 0 0 2 -2l-1 -5a2 3 0 0 0 -2 -2h-7a3 3 0 0 0 -3 3" /></svg>',r="",a=n.text||{};if(n.ttsEnabled){let s=a.playActionLabel||"Play audio";r+=`<button type="button" class="aipkit_action_btn aipkit_play_btn" title="${s}" aria-label="${s}">${e}</button>`}if(n.enableCopyButton){let s=a.copyActionLabel||"Copy response";r+=`<button type="button" class="aipkit_action_btn aipkit_copy_btn" title="${s}" aria-label="${s}">${i}</button>`}if(n.enableFeedback){let s=a.feedbackLikeLabel||"Like response",l=a.feedbackDislikeLabel||"Dislike response";r+=`<button type="button" class="aipkit_action_btn aipkit_feedback_btn aipkit_thumb_up_btn" title="${s}" aria-label="${s}" data-feedback="up">${o}</button>`,r+=`<button type="button" class="aipkit_action_btn aipkit_feedback_btn aipkit_thumb_down_btn" title="${l}" aria-label="${l}" data-feedback="down">${t}</button>`}return r?`<div class="aipkit_message_actions">${r}</div>`:""}window.aipkit_chatUI_createActionsContainerHTML=c})();(function(){"use strict";function c(n,e){if(!n){console.error("AIPKit Init Message Actions: Messages container element not provided.");return}n.dataset.aipkitMessageActionsListenerAttached!=="true"&&(n.dataset.aipkitMessageActionsListenerAttached="true",n.addEventListener("click",function(i){if(i.target.closest(".aipkit_copy_btn")){typeof window.aipkit_chatUI_handleCopyAction=="function"?window.aipkit_chatUI_handleCopyAction(i,e):console.error("AIPKit Init Message Actions: handleCopyAction function not found.");return}if(i.target.closest(".aipkit_feedback_btn")){typeof window.aipkit_chatUI_handleFeedbackAction=="function"?window.aipkit_chatUI_handleFeedbackAction(i,e):console.error("AIPKit Init Message Actions: handleFeedbackAction function not found.");return}}))}window.aipkit_chatUI_initMessageActions=c})();(function(){"use strict";window.aipkitTtsState={currentAudio:null,currentBlobUrl:null,currentlyPlayingButton:null}})();(function(){"use strict";function c(n=!0){let e=window.aipkitTtsState;if(!e){console.error("AIPKit TTS StopAudio: State object not found.");return}if(e.currentAudio&&(e.currentAudio.pause(),e.currentAudio.src="",typeof window.aipkit_tts_handleCanPlayThrough=="function"&&e.currentAudio.removeEventListener("canplaythrough",window.aipkit_tts_handleCanPlayThrough),typeof window.aipkit_tts_handleAudioEnded=="function"&&e.currentAudio.removeEventListener("ended",window.aipkit_tts_handleAudioEnded),typeof window.aipkit_tts_handleAudioPaused=="function"&&e.currentAudio.removeEventListener("pause",window.aipkit_tts_handleAudioPaused),typeof window.aipkit_tts_handleAudioError=="function"&&e.currentAudio.removeEventListener("error",window.aipkit_tts_handleAudioError),e.currentAudio=null),e.currentBlobUrl&&(URL.revokeObjectURL(e.currentBlobUrl),e.currentBlobUrl=null),n&&e.currentlyPlayingButton){e.currentlyPlayingButton.classList.remove("aipkit_loading","aipkit_playing","aipkit_error"),e.currentlyPlayingButton.disabled=!1;let i=e.currentlyPlayingButton.getAttribute("data-original-icon-html");i&&(e.currentlyPlayingButton.innerHTML=i),e.currentlyPlayingButton.removeAttribute("data-original-icon-html"),e.currentlyPlayingButton=null}}window.aipkit_tts_stopCurrentAudio=c})();(function(){"use strict";let c='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-player-pause"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 5m0 1a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1z" /><path d="M14 5m0 1a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1z" /></svg>';function n(){let t=window.aipkitTtsState;!t||!t.currentAudio||!t.currentlyPlayingButton||(t.currentlyPlayingButton.classList.remove("aipkit_loading"),t.currentlyPlayingButton.classList.add("aipkit_playing"),t.currentlyPlayingButton.disabled=!1,t.currentlyPlayingButton.hasAttribute("data-original-icon-html")||t.currentlyPlayingButton.setAttribute("data-original-icon-html",t.currentlyPlayingButton.innerHTML),t.currentlyPlayingButton.innerHTML=c,t.currentAudio.play().catch(r=>{console.error("AIPKit TTS Handler: Error starting playback:",r),typeof window.aipkit_tts_handleAudioError=="function"&&window.aipkit_tts_handleAudioError(r)}))}function e(){typeof window.aipkit_tts_stopCurrentAudio=="function"?window.aipkit_tts_stopCurrentAudio(!0):console.error("AIPKit TTS Handler: stopCurrentAudio function not found for ended event.")}function i(){let t=window.aipkitTtsState;!t||!t.currentAudio||(typeof window.aipkit_tts_stopCurrentAudio=="function"?window.aipkit_tts_stopCurrentAudio(!0):console.error("AIPKit TTS Handler: stopCurrentAudio function not found for paused event."))}function o(t){let r=window.aipkitTtsState;if(!r)return;console.error("AIPKit TTS Handler: Error playing audio.",t);let a=r.currentlyPlayingButton;if(typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(!1),a){a.classList.remove("aipkit_loading","aipkit_playing"),a.classList.add("aipkit_error"),a.disabled=!1;let s=a.getAttribute("data-original-icon-html");s&&(a.innerHTML=s),a.removeAttribute("data-original-icon-html")}r.currentlyPlayingButton=null}window.aipkit_tts_handleCanPlayThrough=n,window.aipkit_tts_handleAudioEnded=e,window.aipkit_tts_handleAudioPaused=i,window.aipkit_tts_handleAudioError=o})();(function(){"use strict";function c(n,e,i){let o=window.aipkitTtsState;if(!o){console.error("AIPKit TTS PlayFromBase64: State object not found."),typeof window.aipkit_tts_handleAudioError=="function"&&window.aipkit_tts_handleAudioError(new Error("TTS State missing"));return}try{let t=atob(n),r=new Array(t.length);for(let l=0;l<t.length;l++)r[l]=t.charCodeAt(l);let a=new Uint8Array(r),s=new Blob([a],{type:e});o.currentBlobUrl&&typeof URL.revokeObjectURL=="function"&&URL.revokeObjectURL(o.currentBlobUrl),o.currentBlobUrl=URL.createObjectURL(s),o.currentAudio&&typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(!0),o.currentAudio=new Audio(o.currentBlobUrl),o.currentlyPlayingButton=i,typeof window.aipkit_tts_handleCanPlayThrough=="function"&&o.currentAudio.addEventListener("canplaythrough",window.aipkit_tts_handleCanPlayThrough),typeof window.aipkit_tts_handleAudioEnded=="function"&&o.currentAudio.addEventListener("ended",window.aipkit_tts_handleAudioEnded),typeof window.aipkit_tts_handleAudioPaused=="function"&&o.currentAudio.addEventListener("pause",window.aipkit_tts_handleAudioPaused),typeof window.aipkit_tts_handleAudioError=="function"?o.currentAudio.addEventListener("error",window.aipkit_tts_handleAudioError):console.error("AIPKit TTS PlayFromBase64: Audio error handler is missing globally."),o.currentAudio.load()}catch(t){console.error("AIPKit TTS PlayFromBase64: Error processing base64 or creating Blob URL:",t),typeof window.aipkit_tts_handleAudioError=="function"&&window.aipkit_tts_handleAudioError(t)}}window.aipkit_tts_playAudioFromBase64=c})();(function(){"use strict";async function c(n){let e=window.aipkitTtsState;if(!e){console.error("AIPKit TTS PlayAction: State object not found."),n&&(n.classList.remove("aipkit_loading"),n.classList.add("aipkit_error"),n.disabled=!1);return}let i=n.closest(".aipkit_chat_message"),o=i?i.querySelector(".aipkit_chat_bubble"):null,t=n.closest(".aipkit_chat_container[data-config]");t||(t=n.closest(".aipkit_popup_wrapper[data-config]"));let r=t?t.getAttribute("data-config"):null,a=null;if(!o||!t||!r){console.error("AIPKit TTS PlayAction: Could not find message bubble, config holder, or config attribute."),n&&(n.classList.remove("aipkit_loading"),n.classList.add("aipkit_error"),n.disabled=!1);return}try{a=JSON.parse(r)}catch(p){console.error("AIPKit TTS PlayAction: Failed to parse config.",p);return}let s=o.getAttribute("data-raw-text")||"",l=a.botId;if(!s){console.warn("AIPKit TTS PlayAction: No text found to play.");return}if(!l){console.error("AIPKit TTS PlayAction: Missing botId in config.");return}if(n===e.currentlyPlayingButton){typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(!0);return}typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(!0),n.classList.remove("aipkit_error","aipkit_playing"),n.classList.add("aipkit_loading"),n.disabled=!0;try{let p={text:s};if(typeof window.aipkit_frontendApiRequest!="function")throw console.error("AIPKit TTS PlayAction Error: aipkit_frontendApiRequest function not found."),new Error("Internal script error (TTS API).");let d=await window.aipkit_frontendApiRequest("aipkit_generate_speech",p,a);if(d&&d.audio_data_base64&&d.mime_type)if(typeof window.aipkit_tts_playAudioFromBase64=="function")window.aipkit_tts_playAudioFromBase64(d.audio_data_base64,d.mime_type,n);else throw console.error("AIPKit TTS PlayAction Error: playAudioFromBase64 function not found."),new Error("Internal script error (TTS Playback).");else throw console.error("AIPKit TTS PlayAction: API response missing audio data or mime type. Response:",d),new Error("Invalid response received from speech generation.")}catch(p){if(console.error("AIPKit TTS PlayAction: Error generating speech:",p),n){n.classList.remove("aipkit_loading","aipkit_playing"),n.classList.add("aipkit_error"),n.disabled=!1;let d=n.getAttribute("data-original-icon-html");d&&(n.innerHTML=d),n.removeAttribute("data-original-icon-html")}e.currentlyPlayingButton=null}}window.aipkit_handlePlayAction=c})();(function(){"use strict";function c(n,e,i,o,t){return new Promise((r,a)=>{if(!e.ajaxUrl)return a(new Error("Missing ajaxUrl in config for SSE cache."));if(!e.nonce)return a(new Error("Missing nonce in config for SSE cache."));let s=new FormData;s.append("action","aipkit_cache_sse_message"),s.append("message",n),s.append("_ajax_nonce",e.nonce),e.botId&&s.append("bot_id",e.botId),i&&s.append("image_inputs",JSON.stringify([i])),t&&s.append("user_client_message_id",t);let l=o;if(!l&&window.aipkit_current_conversation_uuid)try{let u=localStorage.getItem(`aipkit_file_context_${window.aipkit_current_conversation_uuid}`);u&&(l=JSON.parse(u))}catch(u){console.error("CacheSSE: Error reading file context from localStorage:",u)}l&&(l.provider==="OpenAI"&&l.vector_store_id&&s.append("active_openai_vs_id",l.vector_store_id),l.provider==="Pinecone"&&l.index_name&&l.namespace&&(s.append("active_pinecone_index_name",l.index_name),s.append("active_pinecone_namespace",l.namespace)),l.provider==="Qdrant"&&l.collection_name&&l.file_upload_context_id&&(s.append("active_qdrant_collection_name",l.collection_name),s.append("active_qdrant_file_upload_context_id",l.file_upload_context_id)));let p=()=>fetch(e.ajaxUrl,{method:"POST",body:s}).then(u=>u.ok?u.json():u.text().then(_=>{try{let f=JSON.parse(_);if(f?.data?.code==="embed_not_available")throw new Error("The embed feature is not available with your current plan. Please upgrade to use embedded chatbots.");if(f?.data?.code==="cors_denied")throw new Error("This domain is not permitted to access the chatbot. Please check your embed settings.");if(f?.data?.code==="nonce_failure_cache_sse")return d(e).then(()=>(s.set&&s.set("_ajax_nonce",e.nonce),fetch(e.ajaxUrl,{method:"POST",body:s}))).then(w=>w.ok?w.json():w.text().then(m=>{throw new Error(m||`HTTP error ${w.status} caching message.`)}));throw new Error(f?.data?.message||`HTTP error ${u.status} caching message.`)}catch{if(u.status===403)return d(e).then(()=>(s.set&&s.set("_ajax_nonce",e.nonce),fetch(e.ajaxUrl,{method:"POST",body:s}))).then(w=>w.ok?w.json():w.text().then(m=>{throw new Error(m||`HTTP error ${w.status} caching message.`)}));throw new Error(`Failed to prepare message for streaming. Please check your internet connection and try again. (HTTP ${u.status})`)}})).then(u=>{u.success&&u.data?.cache_key?r(u.data.cache_key):a(new Error(u.data?.message||"Failed to cache message for streaming."))}).catch(u=>{console.error("AIPKit SSE Cache Request Error:",u),a(u)});function d(u){return new Promise((_,f)=>{try{if(!u||!u.ajaxUrl)return f(new Error("No ajaxUrl for nonce refresh"));let w=new FormData;w.append("action",typeof window.aipkit_getChatNonceAction=="string"&&window.aipkit_getChatNonceAction?window.aipkit_getChatNonceAction:"aipkit_get_frontend_chat_nonce"),u.botId&&w.append("bot_id",u.botId),fetch(u.ajaxUrl,{method:"POST",body:w,credentials:"same-origin"}).then(m=>m.json()).then(m=>{m&&m.success&&m.data&&m.data.nonce?(u.nonce=m.data.nonce,_(m.data.nonce)):f(new Error("Nonce refresh failed"))}).catch(()=>f(new Error("Nonce refresh network error")))}catch(w){f(w)}})}p()})}window.aipkit_chatUI_cacheSseMessage=c})();(function(){"use strict";function c(n,e,i,o,t,r,a,s,l,p){if(!i.ajaxUrl||!i.nonce)return new Error("Missing ajaxUrl or nonce in config for EventSource.");let d=new URL(i.ajaxUrl);d.searchParams.append("action","aipkit_frontend_chat_stream"),d.searchParams.append("cache_key",n),d.searchParams.append("bot_id",e),d.searchParams.append("session_id",o||""),d.searchParams.append("conversation_uuid",t),r>0&&d.searchParams.append("post_id",r);try{d.searchParams.append("_ts",Date.now().toString())}catch{}i.provider==="OpenAI"&&i.enableOpenAIConversationState&&a&&d.searchParams.append("previous_openai_response_id",a),s&&i.provider==="OpenAI"&&i.allowWebSearchTool&&d.searchParams.append("frontend_web_search_active","true"),l&&i.provider==="Google"&&i.allowGoogleSearchGrounding&&d.searchParams.append("frontend_google_search_grounding_active","true"),p&&(p.provider==="OpenAI"&&p.vector_store_id&&d.searchParams.append("active_openai_vs_id",p.vector_store_id),p.provider==="Pinecone"&&p.index_name&&p.namespace&&(d.searchParams.append("active_pinecone_index_name",p.index_name),d.searchParams.append("active_pinecone_namespace",p.namespace)),p.provider==="Qdrant"&&p.collection_name&&p.file_upload_context_id&&(d.searchParams.append("active_qdrant_collection_name",p.collection_name),d.searchParams.append("active_qdrant_file_upload_context_id",p.file_upload_context_id))),d.searchParams.append("_ajax_nonce",i.nonce);try{return new EventSource(d.toString())}catch(u){return console.error(`[AIPKit Stream CreateEventSource (${e})] Failed to create EventSource instance:`,u),u}}window.aipkit_chatUI_createEventSource=c})();(function(){"use strict";function c(n,e,i,o){try{let t=JSON.parse(n.data),r=t.message_id;if(r){if(i.currentStreamMessageId&&i.currentStreamMessageId!==r&&o){let a=o.querySelector(`#${CSS.escape(i.currentStreamMessageId)}`);if(a){let s=a.querySelector(".aipkit_chat_bubble");if(s){let l=s.querySelector(".aipkit_stream_indicator");l&&l.parentNode&&l.parentNode.removeChild(l)}a.classList.remove("aipkit_message_streaming"),a.classList.add("aipkit_message_complete")}}i.currentStreamMessageId=r}e.provider==="OpenAI"&&e.enableOpenAIConversationState&&t.openai_response_id&&(window.aipkit_current_openai_response_id=t.openai_response_id,sessionStorage.setItem("aipkit_current_openai_response_id",t.openai_response_id))}catch(t){console.error("[AIPKit Stream HandleMessageStart] Error parsing message_start data:",n.data,t)}}window.aipkit_chatUI_handleMessageStartEvent=c})();(function(){"use strict";function c(n,e){try{let i=JSON.parse(n.data);e.provider==="OpenAI"&&e.enableOpenAIConversationState&&i.id&&(window.aipkit_current_openai_response_id=i.id,sessionStorage.setItem("aipkit_current_openai_response_id",i.id))}catch(i){console.error("[AIPKit Stream HandleOpenAIResponseId] Error parsing data:",n.data,i)}}window.aipkit_chatUI_handleOpenAIResponseIdEvent=c})();(function(){"use strict";function c(n,e){try{let i=JSON.parse(n.data);e.accumulatedGroundingMetadata=i}catch(i){console.error("[AIPKit Stream HandleGroundingMetadata] Error parsing data:",n.data,i)}}window.aipkit_chatUI_handleGroundingMetadataEvent=c})();(function(){"use strict";function c(n,e,i,o,t){try{let r=JSON.parse(n.data),a=r.delta;if(a!==void 0&&t.currentStreamMessageId)if(t.dataReceived)window.aipkit_chatUI_appendOrUpdateMessage(o,t.currentStreamMessageId,a,"bot",i,!1,!1,null),window.aipkit_chatUI_scrollToBottom(o,!0);else{t.dataReceived=!0;let s=`aipkit-typing-indicator-${e}`,l=o.querySelector(`#${CSS.escape(s)}`);if(l){let p=l.querySelector(".aipkit_chat_bubble");if(p){l.id=t.currentStreamMessageId,l.setAttribute("data-message-id",t.currentStreamMessageId),l.classList.remove("aipkit_typing-indicator"),p.dataset.aipkitFullContent=a,p.innerHTML=window.aipkit_md?window.aipkit_md.render(a):a.replace(/\n/g,"<br>"),typeof window.positionStreamingIndicator=="function"&&window.positionStreamingIndicator(p,"aipkit_stream_indicator");let d=typeof window.createActionsContainerHTML=="function"?window.createActionsContainerHTML(i):"";d&&!l.querySelector(".aipkit_message_actions")&&l.insertAdjacentHTML("beforeend",d),window.aipkit_chatUI_scrollToBottom(o,!0)}else window.aipkit_chatUI_removeTypingIndicator(o,l),window.aipkit_chatUI_appendOrUpdateMessage(o,t.currentStreamMessageId,a,"bot",i,!1,!1,null),window.aipkit_chatUI_scrollToBottom(o,!0)}else window.aipkit_chatUI_appendOrUpdateMessage(o,t.currentStreamMessageId,a,"bot",i,!1,!1,null),window.aipkit_chatUI_scrollToBottom(o,!0)}else console.warn(`[AIPKit Stream OnMessage (${e})] Received message without delta or missing message ID:`,r)}catch(r){console.error(`[AIPKit Stream OnMessage (${e})] Error parsing message data:`,n.data,r)}}window.aipkit_chatUI_handleOnMessageEvent=c})();(function(){"use strict";function c(n,e,i,o,t,r,a){typeof window.aipkit_chatUI_appendOrUpdateMessage=="function"&&a.currentStreamMessageId&&window.aipkit_chatUI_appendOrUpdateMessage(o,a.currentStreamMessageId,"","bot",i,!0,!1,a.accumulatedGroundingMetadata),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(o,!0),typeof t=="function"&&t(),r.current&&(r.current.close(),r.current=null)}window.aipkit_chatUI_handleDoneEvent=c})();(function(){"use strict";function c(n,e,i,o,t){console.warn(`[AIPKit Stream HandleWarning (${e})] Received 'warning' event:`,n.data),t.dataReceived||(t.dataReceived=!0);try{let r=JSON.parse(n.data);r.error&&t.currentStreamMessageId&&typeof window.aipkit_chatUI_appendOrUpdateMessage=="function"&&(window.aipkit_chatUI_appendOrUpdateMessage(o,t.currentStreamMessageId,`

*${r.error}*`,"bot",i,!1,!0,null),window.aipkit_chatUI_scrollToBottom(o,!0))}catch(r){console.error(`[AIPKit Stream HandleWarning (${e})] Error parsing warning data:`,n.data,r)}}window.aipkit_chatUI_handleWarningEvent=c})();(function(){"use strict";function c(n,e,i,o,t,r,a){window.aipkit_chatUI_removeTypingIndicator(o);let s=i.text||{};console.error(`[AIPKit Stream HandleError (${e})] EventSource error.`,n);let l=null;if(n.data)try{let d=JSON.parse(n.data);d.error&&(l=d.error)}catch{typeof n.data=="string"&&n.data.length>0&&n.data.length<200&&(l=n.data)}else n.target&&n.target.readyState===EventSource.CLOSED?l="Connection was closed.":n.message&&(l=n.message);let p="";l?p=`${s.errorPrefix||"Error:"} ${l}`:p=a.dataReceived?s.streamError||"Stream error. Please try again.":s.connError||"Connection error. Please check setup or try again.",typeof t=="function"&&t(p,!1,!0),a.currentStreamMessageId=null,r.current&&(r.current.close(),r.current=null)}window.aipkit_chatUI_handleErrorEvent=c})();(function(){"use strict";function c(n,e,i,o,t){typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(o);try{let a=JSON.parse(n.data).form_definition;if(typeof a!="object"||a===null){console.error(`[AIPKit Stream HandleDisplayForm (${e})] Invalid or missing form_definition in event data.`);return}if(typeof window.aipkit_chatUI_renderChatForm!="function"){console.error(`[AIPKit Stream HandleDisplayForm (${e})] renderChatForm function not found.`);return}if(typeof window.aipkit_generateClientMessageId!="function"){console.error(`[AIPKit Stream HandleDisplayForm (${e})] generateClientMessageId function not found.`);return}let s=window.aipkit_generateClientMessageId(e);window.aipkit_chatUI_renderChatForm(o,a,i,s);let l=o.closest(".aipkit_chat_container");l&&l.dispatchEvent(new CustomEvent("aipkit:formDisplayed",{detail:{formId:a.form_id,messageId:s}}))}catch(r){console.error(`[AIPKit Stream HandleDisplayForm (${e})] Error parsing event data or rendering form:`,r,"Raw event data:",n.data)}}window.aipkit_chatUI_handleDisplayFormEvent=c})();(function(){"use strict";async function c(n,e,i,o,t,r,a,s,l,p,d){let u=i.text||{},_={dataReceived:!1,currentStreamMessageId:null,accumulatedGroundingMetadata:null},f={current:null},w=["aipkit_chatUI_cacheSseMessage","aipkit_chatUI_createEventSource","aipkit_chatUI_handleMessageStartEvent","aipkit_chatUI_handleOpenAIResponseIdEvent","aipkit_chatUI_handleGroundingMetadataEvent","aipkit_chatUI_handleOnMessageEvent","aipkit_chatUI_handleDoneEvent","aipkit_chatUI_handleWarningEvent","aipkit_chatUI_handleErrorEvent","aipkit_chatUI_removeTypingIndicator","aipkit_chatUI_handleDisplayFormEvent"];for(let k of w)if(typeof window[k]!="function"){console.error(`[AIPKit Stream Orchestrator (${e})] Missing required helper function: ${k}`),typeof t=="function"&&t(`${u.errorPrefix||"Error:"} Critical script component missing.`,!1,!0),typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(o);return}let m=window.aipkit_current_conversation_uuid,h=window.aipkit_guest_uuid,g=window.aipkit_current_post_id,y=window.aipkit_current_openai_response_id;if(!m){console.error(`[AIPKit Stream Orchestrator (${e})] Missing currentConversationUUID.`),typeof t=="function"&&t(u.errorPrefix+" "+(u.connError||"Configuration error (Conv ID)."),!1);return}let b=null;try{b=await window.aipkit_chatUI_cacheSseMessage(n,i,l,p,d)}catch(k){if(console.error(`[AIPKit Stream Orchestrator (${e})] Failed to cache message (see details below):`,k.message||"Unknown error during cache attempt."),console.error(`[AIPKit Stream Orchestrator (${e})] Full error object from cache failure:`,k),typeof t=="function"){let S=`${u.errorPrefix||"Error:"} Failed to prepare message for streaming.`;k&&typeof k=="object"&&k.code?S+=` (Code: ${k.code})`:k&&k.message?S+=` (${k.message})`:S+=" (Unknown error)",t(S)}typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(o);return}let I=window.aipkit_chatUI_createEventSource(b,e,i,h,m,g,y,a,s,p);if(I instanceof Error){console.error(`[AIPKit Stream Orchestrator (${e})] Error creating EventSource:`,I),typeof t=="function"&&t(u.connError||"Connection error. Please try again.",!1,!0),window.aipkit_chatUI_removeTypingIndicator(o);return}f.current=I,f.current.addEventListener("message_start",k=>window.aipkit_chatUI_handleMessageStartEvent(k,i,_,o)),f.current.addEventListener("openai_response_id",k=>window.aipkit_chatUI_handleOpenAIResponseIdEvent(k,i)),f.current.addEventListener("grounding_metadata",k=>window.aipkit_chatUI_handleGroundingMetadataEvent(k,_)),f.current.addEventListener("display_form_event",k=>window.aipkit_chatUI_handleDisplayFormEvent(k,e,i,o,_)),f.current.onmessage=k=>window.aipkit_chatUI_handleOnMessageEvent(k,e,i,o,_),f.current.addEventListener("done",k=>window.aipkit_chatUI_handleDoneEvent(k,e,i,o,r,f,_)),f.current.addEventListener("warning",k=>window.aipkit_chatUI_handleWarningEvent(k,e,i,o,_)),f.current.onerror=k=>window.aipkit_chatUI_handleErrorEvent(k,e,i,o,t,f,_)}window.aipkit_chatUI_streamMessage=c})();(function(){"use strict";async function c(n,e,i,o){n.preventDefault();let t=n.target;if(!t)return;let r=t.dataset.formId;if(!r){console.error("AIPKit Chat Form: Form ID missing from submitted form.");return}let a=new FormData(t),s={};for(let[u,_]of a.entries())if(u.endsWith("[]")){let f=u.slice(0,-2);s[f]||(s[f]=[]),s[f].push(_)}else s[u]=_;let l=t.querySelector('button[type="submit"]');l&&(l.disabled=!0);let p=t.closest(".aipkit_chat_form_wrapper"),d={form_id:r,submitted_data:JSON.stringify(s)};try{if(typeof window.aipkit_frontendApiRequest!="function")throw new Error("Frontend API request function not found.");let u=await window.aipkit_frontendApiRequest("aipkit_handle_form_submission",d,e);if(l&&(l.disabled=!1),u.message_to_user?typeof window.aipkit_chatUI_appendMessage=="function"&&typeof window.aipkit_generateClientMessageId=="function"?window.aipkit_chatUI_appendMessage(i.messagesEl,u.message_to_user,"bot",e,!1,!1,u.message_id||window.aipkit_generateClientMessageId(e.botId),!0):console.error("AIPKit Chat Form: appendMessage or generateClientMessageId function not found."):u.message&&typeof window.aipkit_chatUI_appendMessage=="function"&&typeof window.aipkit_generateClientMessageId=="function"&&window.aipkit_chatUI_appendMessage(i.messagesEl,u.message,"bot",e,!1,!1,window.aipkit_generateClientMessageId(e.botId),!0),p){let _=p.closest(".aipkit_chat_message");_&&(_.remove(),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(i.messagesEl,!0))}}catch(u){console.error(`AIPKit Chat Form (${e.botId}): Error submitting form "${r}":`,u),l&&(l.disabled=!1),typeof o.handleError=="function"?o.handleError(u.message||"Failed to submit form.",!1,!0):alert(u.message||"Failed to submit form.")}}window.aipkit_chatUI_handleChatFormSubmission=c})();(function(){"use strict";let c=!1,n=null,e=null;function i(){n&&(n.classList.remove("aipkit_active"),n=null,c=!1,e&&(document.removeEventListener("click",e),e=null))}window.aipkit_chatUI_closeActiveDownloadMenu=i,window.aipkit_chatUI_setActiveDownloadMenu=function(o,t,r){n=o,c=t,e=r},window.aipkit_chatUI_getDownloadMenuState=function(){return{isOpen:c,activeMenu:n,handler:e}}})();(function(){"use strict";function c(n,e){if(!n||!e)return;let{inputActionButton:i,inputActionMenu:o}=n;e.activeInputActionMenu&&e.activeInputActionTrigger&&(o&&(o.classList.remove("aipkit-action-menu-open"),o.setAttribute("aria-hidden","true"),setTimeout(()=>{o&&!o.classList.contains("aipkit-action-menu-open")&&(o.style.display="none")},200)),i&&(i.classList.remove("aipkit_active"),i.setAttribute("aria-expanded","false")),e.activeInputActionMenu=null,e.activeInputActionTrigger=null,e.isActionMenuOpen=!1,e.closeActionMenuHandler&&(document.removeEventListener("click",e.closeActionMenuHandler,!0),document.removeEventListener("keydown",e.closeActionMenuHandler,!0),e.closeActionMenuHandler=null))}window.aipkit_chatUI_closeActiveInputActionMenu=c})();(function(){"use strict";function c(n,e,i){let{inputActionButton:o,inputActionMenu:t,imageUploadInput:r,fileUploadInput:a}=n,{fileUploadEnabledUI:s,imageUploadEnabledUI:l}=e;if(!o){t&&(t.style.display="none");return}let p='<svg xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-paperclip"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 7l-6.5 6.5a1.5 1.5 0 0 0 3 3l6.5 -6.5a3 3 0 0 0 -6 -6l-6.5 6.5a4.5 4.5 0 0 0 9 9l6.5 -6.5" /></svg>',d='<svg xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-photo-up"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 8h.01" /><path d="M12.5 21h-6.5a3 3 0 0 1 -3 -3v-12a3 3 0 0 1 3 -3h12a3 3 0 0 1 3 3v6.5" /><path d="M3 16l5 -5c.928 -.893 2.072 -.893 3 0l3.5 3.5" /><path d="M14 14l1 -1c.679 -.653 1.473 -.829 2.214 -.526" /><path d="M19 22v-6" /><path d="M22 19l-3 -3l-3 3" /></svg>',u='<svg xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-file-upload"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 3v4a1 1 0 0 0 1 1h4" /><path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" /><path d="M12 11v6" /><path d="M9.5 13.5l2.5 -2.5l2.5 2.5" /></svg>';o.onclick=null;let _=window.aipkit_chatUI_closeActiveDownloadMenu,f=window.aipkit_chatUI_closeActiveInputActionMenu;if(typeof _!="function"||typeof f!="function"){console.error("AIPKit SetupInputActionButton: Missing global menu utility functions (closeDownloadMenu or closeInputActionMenu).");return}let w=p,m=e.text?.attachTools||"Attach or use tools",h="true";if(s&&!l)w=u,m=e.text?.uploadFile||"Upload File (TXT, PDF)",h="false";else if(!s&&l)w=d,m=e.text?.uploadImage||"Upload Image",h="false";else if(!s&&!l){o.style.display="none",t&&(t.style.display="none");return}o.innerHTML=w,o.setAttribute("aria-label",m),h==="true"?(o.setAttribute("aria-haspopup","true"),o.setAttribute("aria-expanded","false")):(o.removeAttribute("aria-haspopup"),o.removeAttribute("aria-expanded")),s&&l?(t&&(t.style.display="none"),o.onclick=g=>{g.stopPropagation(),_(),!i.isActionMenuOpen?(t&&(t.style.display="flex",requestAnimationFrame(()=>{t&&t.classList.add("aipkit-action-menu-open")}),t.setAttribute("aria-hidden","false")),o.classList.add("aipkit_active"),o.setAttribute("aria-expanded","true"),i.isActionMenuOpen=!0,i.activeInputActionMenu=t,i.activeInputActionTrigger=o,setTimeout(()=>{i.closeActionMenuHandler=b=>{b.type==="click"&&(!i.activeInputActionMenu||!i.activeInputActionTrigger||i.activeInputActionMenu.contains(b.target)||i.activeInputActionTrigger.contains(b.target))||b.type==="keydown"&&b.key!=="Escape"||f(n,i)},document.addEventListener("click",i.closeActionMenuHandler,{capture:!0,once:!1}),document.addEventListener("keydown",i.closeActionMenuHandler,{capture:!0,once:!1})},0)):f(n,i)}):s?(t&&(t.style.display="none"),o.onclick=g=>{g.stopPropagation(),_(),a?a.click():(console.warn("AIPKit InputActionButton: File upload input not found in elements."),alert("File upload feature not properly initialized."))}):l?(t&&(t.style.display="none"),o.onclick=g=>{g.stopPropagation(),_(),r?r.click():(console.warn("AIPKit InputActionButton: Image upload input not found in elements."),alert("Image upload feature not properly initialized."))}):(o.style.display="none",t&&(t.style.display="none"))}window.aipkit_chatUI_setupInputActionButton=c})();(function(){"use strict";function c(n,e,i,o){let{actionButton:t}=n;t&&t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",()=>{i.buttonState==="send"&&!t.disabled?o.sendMessageAction():i.buttonState==="clear"&&o.clearChatAction()}),t.dataset.listenerAttached="true")}window.aipkit_chatUI_attachActionButtonListener=c})();(function(){"use strict";function c(n,e,i,o){let{inputField:t,messagesEl:r,actionButton:a}=n;t&&t.dataset.listenerAttached!=="true"&&(t.addEventListener("keydown",s=>{s.key==="Enter"&&!i.isActionMenuOpen&&(s.shiftKey?setTimeout(()=>{typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(t)},0):(s.preventDefault(),i.buttonState==="send"&&!a.disabled&&o.sendMessageAction()))}),t.addEventListener("input",()=>{let s=t.value.trim()==="",l=r.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").length>0;s?l&&i.buttonState!=="sending"&&i.buttonState!=="streaming"?i.buttonState=o.setButtonStateAction("clear",!1,i):i.buttonState!=="sending"&&i.buttonState!=="streaming"&&(i.buttonState=o.setButtonStateAction("send",!1,i)):i.buttonState=o.setButtonStateAction("send",!1,i),typeof window.aipkit_autoResizeTextarea=="function"&&window.aipkit_autoResizeTextarea(t)}),t.dataset.listenerAttached="true")}window.aipkit_chatUI_attachInputFieldListeners=c})();(function(){"use strict";function c(n,e,i,o){let{fullscreenButton:t}=n;t&&typeof o.toggleFullscreenAction=="function"?t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",o.toggleFullscreenAction),t.dataset.listenerAttached="true"):t&&console.warn("AIPKit Chat Events: Fullscreen button exists, but toggleFullscreenAction action is missing.")}window.aipkit_chatUI_attachFullscreenButtonListener=c})();(function(){"use strict";function c(n,e,i,o){let{closeButton:t,container:r}=n;t?t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",a=>{a.stopPropagation(),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(n,i),i.isFullscreen?typeof o.toggleFullscreenAction=="function"?(o.toggleFullscreenAction(),e.popupEnabled&&typeof window.aipkit_chatUI_openPopup=="function"&&!i.isPopupOpen&&setTimeout(()=>window.aipkit_chatUI_openPopup(r,n.messagesEl,n.inputField,i),50)):console.warn("AIPKit Chat Events: toggleFullscreen action missing for close button while in fullscreen."):e.popupEnabled&&typeof window.aipkit_chatUI_closePopup=="function"&&window.aipkit_chatUI_closePopup(r,i)}),t.dataset.listenerAttached="true"):e.popupEnabled}window.aipkit_chatUI_attachCloseButtonListener=c})();(function(){"use strict";function c(n,e,i,o){let{webSearchToggleButton:t}=n,r=e.allowWebSearchTool&&e.provider==="OpenAI";t&&r?t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",a=>{a.stopPropagation(),typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu(),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(n,i),typeof window.aipkit_toggleWebSearchAction=="function"?window.aipkit_toggleWebSearchAction(n,e,i):console.error("AIPKit Chat Events: aipkit_toggleWebSearchAction function not provided.")}),t.dataset.listenerAttached="true"):t&&(t.style.display="none")}window.aipkit_chatUI_attachWebSearchToggleListener=c})();(function(){"use strict";function c(n,e,i,o){let{googleSearchGroundingToggleButton:t}=n,r=e.allowGoogleSearchGrounding&&e.provider==="Google";t&&r?t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",a=>{a.stopPropagation(),typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu(),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(n,i),typeof window.aipkit_toggleGoogleSearchGroundingAction=="function"?window.aipkit_toggleGoogleSearchGroundingAction(n,e,i):console.error("AIPKit Chat Events: aipkit_toggleGoogleSearchGroundingAction function not provided.")}),t.dataset.listenerAttached="true"):t&&(t.style.display="none")}window.aipkit_chatUI_attachGoogleGroundingToggleListener=c})();(function(){"use strict";function c(n,e,i,o){let{downloadButton:t}=n;if(t&&e.enableDownload){let r=t.closest(".aipkit_download_wrapper"),a=r?r.querySelector(".aipkit_download_menu"):null,s=e.pdfDownloadActive===!0;t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",l=>{if(l.stopPropagation(),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(n,i),s&&a){let p=window.aipkit_chatUI_getDownloadMenuState?window.aipkit_chatUI_getDownloadMenuState():{isOpen:!1,activeMenu:null};if(p.isOpen&&p.activeMenu===a)typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu();else if(typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu(),a.classList.add("aipkit_active"),typeof window.aipkit_chatUI_setActiveDownloadMenu=="function"){let d=u=>{r.contains(u.target)||typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu()};window.aipkit_chatUI_setActiveDownloadMenu(a,!0,d),setTimeout(()=>{document.addEventListener("click",d,{once:!0})},0)}}else typeof o.downloadTranscriptTxtAction=="function"?o.downloadTranscriptTxtAction():console.error("AIPKit Chat Events: downloadTranscriptTxtAction action not provided.")}),t.dataset.listenerAttached="true"),a&&a.dataset.listenerAttached!=="true"&&(a.addEventListener("click",l=>{let p=l.target.closest(".aipkit_download_menu_item");if(p){let d=p.getAttribute("data-format");d==="txt"?typeof o.downloadTranscriptTxtAction=="function"?o.downloadTranscriptTxtAction():console.error("AIPKit Chat Events: downloadTranscriptTxtAction action not provided."):d==="pdf"&&(typeof o.downloadTranscriptPdfAction=="function"?o.downloadTranscriptPdfAction():console.error("AIPKit Chat Events: downloadTranscriptPdfAction action not provided.")),typeof window.aipkit_chatUI_closeActiveDownloadMenu=="function"&&window.aipkit_chatUI_closeActiveDownloadMenu()}}),a.dataset.listenerAttached="true")}}window.aipkit_chatUI_attachDownloadMenuListeners=c})();(function(){"use strict";function c(n,e,i,o){let{inputActionMenu:t}=n;t&&typeof window.aipkit_chatUI_setupInputActionButton=="function"&&t.dataset.itemClickListenerAttached!=="true"&&(t.addEventListener("click",r=>{let a=r.target.closest(".aipkit_input_action_menu_item");if(!a)return;r.preventDefault();let s=a.getAttribute("aria-label");s&&s.toLowerCase().includes("image")?n.imageUploadInput?n.imageUploadInput.click():(console.warn("AIPKit Chat Events: Image upload input not found for menu item."),alert("Image upload feature not properly initialized.")):s&&(s.toLowerCase().includes("pdf")||s.toLowerCase().includes("file"))&&(n.fileUploadInput?n.fileUploadInput.click():(console.warn("AIPKit Chat Events: File upload input not found for menu item."),alert("File upload feature not properly initialized."))),typeof window.aipkit_chatUI_closeActiveInputActionMenu=="function"&&window.aipkit_chatUI_closeActiveInputActionMenu(n,i)}),t.dataset.itemClickListenerAttached="true")}window.aipkit_chatUI_attachInputActionMenuListener=c})();(function(){"use strict";function c(n,e,i,o){let{voiceInputButton:t}=n;t&&e.enableVoiceInputUI&&t.dataset.listenerAttached!=="true"&&(t.addEventListener("click",()=>{typeof window.aipkit_chatUI_handleVoiceInputAction=="function"?window.aipkit_chatUI_handleVoiceInputAction(n,e,i,i.consentUIInstance,o):(console.error("AIPKit Chat Events: aipkit_chatUI_handleVoiceInputAction function not found."),alert("Voice input unavailable (script error)."))}),t.dataset.listenerAttached="true")}window.aipkit_chatUI_attachVoiceInputButtonListener=c})();(function(){"use strict";function c(n,e,i,o){let{fileUploadInput:t}=n;t&&e.fileUploadEnabledUI&&t.dataset.listenerAttached!=="true"&&(t.addEventListener("change",async r=>{let a=r.target.files[0];if(a&&window.aipkitChatFileUpload&&typeof window.aipkitChatFileUpload.processFile=="function"){let s=n.inputArea||t.closest(".aipkit_chat_input");await window.aipkitChatFileUpload.processFile(a,t,s,e)}else a&&(console.error("AIPKit Chat Events: aipkitChatFileUpload.processFile not found."),typeof window.aipkit_displayChatFileUploadStatus=="function"&&window.aipkit_displayChatFileUploadStatus("File processing system error.","error",n.inputArea))}),t.dataset.listenerAttached="true")}window.aipkit_chatUI_attachFileUploadInputListener=c})();(function(){"use strict";function c(n,e,i,o){let{messagesEl:t}=n;t&&typeof o.handlePlayAction=="function"?t.dataset.playListenerAttached!=="true"&&(t.addEventListener("click",function(r){let a=r.target.closest(".aipkit_play_btn");a&&!a.disabled&&o.handlePlayAction(a)}),t.dataset.playListenerAttached="true"):t&&console.warn("AIPKit Chat Events: handlePlayAction function not provided or invalid during listener attachment.")}window.aipkit_chatUI_attachPlayButtonListener=c})();(function(){"use strict";function c(n,e,i,o){typeof i.isActionMenuOpen>"u"&&(i.isActionMenuOpen=!1,i.activeInputActionMenu=null,i.activeInputActionTrigger=null,i.closeActionMenuHandler=null);let t=["aipkit_chatUI_attachActionButtonListener","aipkit_chatUI_attachInputFieldListeners","aipkit_chatUI_attachFullscreenButtonListener","aipkit_chatUI_attachCloseButtonListener","aipkit_chatUI_attachWebSearchToggleListener","aipkit_chatUI_attachGoogleGroundingToggleListener","aipkit_chatUI_attachDownloadMenuListeners","aipkit_chatUI_attachInputActionMenuListener","aipkit_chatUI_attachVoiceInputButtonListener","aipkit_chatUI_attachFileUploadInputListener","aipkit_chatUI_attachPlayButtonListener"],r=!0;if(t.forEach(a=>{typeof window[a]!="function"&&(console.error(`AIPKit AttachEventListeners Orchestrator: Missing dependency function -> ${a}.`),r=!1)}),!r){console.error("AIPKit AttachEventListeners Orchestrator: Halting due to missing dependencies. Some UI features may not work.");return}window.aipkit_chatUI_attachActionButtonListener(n,e,i,o),window.aipkit_chatUI_attachInputFieldListeners(n,e,i,o),window.aipkit_chatUI_attachFullscreenButtonListener(n,e,i,o),window.aipkit_chatUI_attachCloseButtonListener(n,e,i,o),window.aipkit_chatUI_attachWebSearchToggleListener(n,e,i,o),window.aipkit_chatUI_attachGoogleGroundingToggleListener(n,e,i,o),window.aipkit_chatUI_attachDownloadMenuListeners(n,e,i,o),window.aipkit_chatUI_attachInputActionMenuListener(n,e,i,o),window.aipkit_chatUI_attachVoiceInputButtonListener(n,e,i,o),window.aipkit_chatUI_attachFileUploadInputListener(n,e,i,o),window.aipkit_chatUI_attachPlayButtonListener(n,e,i,o)}window.aipkit_chatUI_attachEventListeners=c})();(function(){"use strict";function c(n,e,i,o,t,r,a,s,l,p,d,u){let{messagesEl:_}=o,f=i.text||{};if(!i.ajaxUrl||!e||!i.nonce){console.error(`AIPKit Chat AJAX (${e}): Missing essential config for API request.`),typeof r=="function"&&r(f.errorPrefix+" "+(f.connError||"Configuration error (API)."),!1),typeof a=="function"&&a();return}let w={message:n};s&&i.provider==="OpenAI"&&i.allowWebSearchTool&&(w.frontend_web_search_active=!0),l&&i.provider==="Google"&&i.allowGoogleSearchGrounding&&(w.frontend_google_search_grounding_active=!0),p&&(w.image_inputs=JSON.stringify([p]));let m={...i};if(d&&(m.activeFileContext=d,d.provider==="OpenAI"&&d.vector_store_id?console.log(`AIPKit Chat AJAX (sender): Adding OpenAI active_openai_vs_id to request config: ${d.vector_store_id}`):d.provider==="Pinecone"&&d.index_name&&d.namespace?console.log(`AIPKit Chat AJAX (sender): Adding Pinecone context to request config: Index: ${d.index_name}, Namespace: ${d.namespace}`):d.provider==="Qdrant"&&d.collection_name&&d.file_upload_context_id&&console.log(`AIPKit Chat AJAX (sender): Adding Qdrant context to request config: Collection: ${d.collection_name}, Context ID: ${d.file_upload_context_id}`)),window.aipkit_chatUI_showTypingIndicator(_,i),typeof window.aipkit_frontendApiRequest!="function"){console.error("AIPKit Chat AJAX Error: aipkit_frontendApiRequest function not found."),typeof r=="function"&&r("Internal script error.",!1),typeof a=="function"&&a();return}window.aipkit_frontendApiRequest("aipkit_frontend_chat_message",w,m).then(h=>{if(window.aipkit_chatUI_removeTypingIndicator(_),h?.reply)i.provider==="OpenAI"&&i.enableOpenAIConversationState&&h.openai_response_id&&(window.aipkit_current_openai_response_id=h.openai_response_id,sessionStorage.setItem("aipkit_current_openai_response_id",h.openai_response_id),console.log(`AIPKit Chat AJAX: Stored new OpenAI Response ID: ${h.openai_response_id}`)),typeof t=="function"&&(t(h.reply,h.message_id||null,h.openai_response_id||null,h.grounding_metadata||null),typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(_,!0));else{let g=h?.message||"Unknown error processing message (no reply).";console.error(`AIPKit Chat AJAX (${e}): AJAX Error -`,g,h),typeof r=="function"&&r(`${f.errorPrefix||"Error:"} ${g}`,!1)}}).catch(h=>{window.aipkit_chatUI_removeTypingIndicator(_);let g=`${f.errorPrefix||"Error:"} ${f.connError||"Could not connect."}`;console.error(`AIPKit Chat AJAX (${e}): Network/Fetch Error -`,h),typeof r=="function"&&r(g+(h.message?` (${h.message})`:""),!0)}).finally(()=>{typeof a=="function"&&a()})}window.aipkit_chatUI_sendMessage=c})();(function(){"use strict";function c(n,e,i){let{container:o,fullscreenButton:t,messagesEl:r,inputField:a}=n,s=i.text||{};if(!o||!t){console.error("AIPKit Fullscreen: Container or fullscreen button element not found.");return}if(e.isFullscreen=!e.isFullscreen,e.isFullscreen){if(!e.fullscreenPlaceholder){let u=document.createElement("div");u.id=`aipkit_fs_placeholder_${o.id}`,u.style.display="none",o.parentNode.insertBefore(u,o),e.fullscreenPlaceholder=u}document.body.appendChild(o),o.classList.add("aipkit-fullscreen")}else o.classList.remove("aipkit-fullscreen"),e.fullscreenPlaceholder&&e.fullscreenPlaceholder.parentNode?(e.fullscreenPlaceholder.parentNode.insertBefore(o,e.fullscreenPlaceholder),e.fullscreenPlaceholder.remove(),e.fullscreenPlaceholder=null):console.warn("AIPKit Fullscreen: Could not find placeholder to return chat container to its original position.");let l=o.closest(".aipkit_popup_wrapper");l&&l.classList.toggle("aipkit-fullscreen-wrapper",e.isFullscreen);let p='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-arrows-maximize"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M16 4l4 0l0 4" /><path d="M14 10l6 -6" /><path d="M8 20l-4 0l0 -4" /><path d="M4 20l6 -6" /><path d="M16 20l4 0l0 -4" /><path d="M14 14l6 6" /><path d="M8 4l-4 0l0 4" /><path d="M4 4l6 6" /></svg>',d='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-arrows-minimize"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9l4 0l0 -4" /><path d="M3 3l6 6" /><path d="M5 15l4 0l0 4" /><path d="M3 21l6 -6" /><path d="M19 9l-4 0l0 -4" /><path d="M15 9l6 -6" /><path d="M19 15l-4 0l0 4" /><path d="M15 15l6 6" /></svg>';t.innerHTML=e.isFullscreen?d:p,t.title=e.isFullscreen?s.exitFullscreen||"Exit Fullscreen":s.fullscreen||"Fullscreen",t.setAttribute("aria-label",t.title),t.setAttribute("aria-expanded",e.isFullscreen.toString()),e.isFullscreen&&typeof window.aipkit_chatUI_scrollToBottom=="function"&&window.aipkit_chatUI_scrollToBottom(r,!0),a&&setTimeout(()=>a.focus(),50)}window.aipkit_chatUI_toggleFullscreen=c})();(function(){"use strict";function c(n,e,i,o,t){let{state:r,elements:a,config:s,setButtonStateAction:l,handleError:p,generateClientMessageId:d,focusInputAction:u}=t,{inputField:_,voiceInputButton:f,messagesEl:w,container:m}=a;r.isSending=!0,_.disabled=!0,f&&(f.disabled=!0),l("sending",!0,r);let h=null;typeof window.aipkit_chatUI_showImageLoadingIndicator=="function"?h=window.aipkit_chatUI_showImageLoadingIndicator(w,s):(console.error("AIPKit Image Gen: aipkit_chatUI_showImageLoadingIndicator function not found."),typeof window.aipkit_chatUI_showTypingIndicator=="function"&&window.aipkit_chatUI_showTypingIndicator(w,s));let g={prompt:n,original_user_text:e,user_message_id:i};if(typeof window.aipkit_frontendApiRequest!="function"){console.error("AIPKit Chat Image Gen Error: aipkit_frontendApiRequest function not found."),p("Internal script error (image gen).",!1,!0),typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"&&window.aipkit_chatUI_removeImageLoadingIndicator(w,h),r.isSending=!1,_.disabled=s.requireConsentCompliance&&!r.consentGiven,f&&(f.disabled=s.requireConsentCompliance&&!r.consentGiven),l("send",!1,r),(!s.requireConsentCompliance||r.consentGiven)&&u();return}window.aipkit_frontendApiRequest("aipkit_chat_generate_image",g,s).then(y=>{if(typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"?window.aipkit_chatUI_removeImageLoadingIndicator(w,h):typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(w),y?.type==="image"&&y.images&&y.images.length>0){let b={type:"image",images:y.images,prompt:n};window.aipkit_chatUI_appendMessage(w,b,"bot",s,!1,!1,y.message_id,!0),m?m.dispatchEvent(new CustomEvent("aipkit:messageReceived",{detail:{messageId:y.message_id,conversationUUID:window.aipkit_current_conversation_uuid,newConversation:o}})):console.error("AIPKit Image Gen: Container element not found for dispatching event.")}else{let b=y?.message||"Invalid response for image generation (no images).";console.error(`AIPKit Chat Image Gen: ${b}`,y),p(`Image generation failed: ${b}`,!1,!0)}}).catch(y=>{typeof window.aipkit_chatUI_removeImageLoadingIndicator=="function"?window.aipkit_chatUI_removeImageLoadingIndicator(w,h):typeof window.aipkit_chatUI_removeTypingIndicator=="function"&&window.aipkit_chatUI_removeTypingIndicator(w),p("Image generation failed: "+(y.message||"Unknown error"),!1,!0)}).finally(()=>{r.isSending=!1,_.disabled=s.requireConsentCompliance&&!r.consentGiven,f&&(f.disabled=s.requireConsentCompliance&&!r.consentGiven),l("send",!1,r),(!s.requireConsentCompliance||r.consentGiven)&&u()})}window.aipkit_chatUI_handleImageGeneration=c})();(function(){"use strict";function c(n,e,i,o){let t=n.toLowerCase(),r=i&&i.ipsList?i.ipsList.split(",").map(s=>s.trim()).filter(s=>s!==""):[];if(e&&r.length>0&&r.includes(e))return console.warn(`AIPKit Moderation: Banned IP detected: "${e}"`),{type:"banned_ip",message:i.message||"Access from your IP address has been blocked."};let a=o&&o.wordsList?o.wordsList.toLowerCase().split(",").map(s=>s.trim()).filter(s=>s!==""):[];if(a.length>0){let s=a.find(l=>t.includes(l));if(s)return console.warn(`AIPKit Moderation: Banned word detected: "${s}"`),{type:"banned_word",message:o.message||"Sorry, your message could not be sent as it contains prohibited words.",word:s}}return null}window.aipkit_checkMessageModeration=c})();(function(){"use strict";function c(o){return o?o.querySelectorAll(".aipkit_chat_message:not(.aipkit_initial_greeting)").length===0:!0}function n(o){o&&o.classList.add("aipkit_hidden")}function e(o){o&&o.classList.remove("aipkit_hidden")}function i(o,t,r,a,s,l){let{startersContainer:p,messagesEl:d,inputField:u}=r,_=t.botId,f=t.starters||[];if(!o||!t||!p||!d||!u){console.error(`AIPKit Starters (${_}): Missing container, config, startersContainer, messagesEl, or inputField.`);return}if(typeof a!="function"){console.error(`AIPKit Starters (${_}): sendMessageActionCallback is not a function.`),n(p);return}if(typeof l!="function"){console.error(`AIPKit Starters (${_}): isConsentGivenFunc is not a function.`),n(p);return}if(f.length===0){n(p);return}p.innerHTML="",f.forEach(h=>{if(typeof h=="string"&&h.trim()!==""){let g=document.createElement("button");g.type="button",g.className="aipkit_starter_btn",g.textContent=h.trim(),g.addEventListener("click",y=>{if(y.preventDefault(),s&&!l()){console.warn(`AIPKit Starters (${_}): Starter clicked, but consent not given.`);return}let b=g.textContent;a(b),n(p)}),p.appendChild(g)}});let w=()=>{if(s&&!l()){n(p);return}c(d)?e(p):n(p)},m=()=>n(p);o.addEventListener("aipkit:messageSent",m),o.addEventListener("aipkit:messageReceived",m),o.addEventListener("aipkit:messageError",m),o.addEventListener("aipkit:chatCleared",w),o.addEventListener("aipkit:chatLoaded",w),o.addEventListener("aipkit:consentGiven",()=>{w()}),w()}window.aipkit_initConversationStarters=i})();function N(c,n){let e=window.aipkit_chatUI_findElements(c,n);if(!e){let a=c.querySelector(".aipkit_chat_container")||c;return a&&(a.innerHTML='<p style="color: red; text-align: center; padding: 20px;">Chatbot UI error (DOM elements missing).</p>'),null}let i=n.botId,o=window.aipkit_chatUI_initState(n);o.consentUIInstance=null;let t={setButtonStateAction:(a,s=!1)=>window.aipkit_chatUI_setButtonStateAction(a,e,n,o,s),focusInputAction:()=>window.aipkit_chatUI_focusInputAction(e.inputField,n,o),sendMessageAction:(a=null)=>window.aipkit_chatUI_sendMessageAction(e,n,o,t,a),clearChatAction:()=>window.aipkit_chatUI_clearChatAction(e,n,o,t),handleError:(a,s,l=!0)=>window.aipkit_chatUI_handleError(a,s,l,e,n,o,t),handleCompletion:(a,s=!1)=>window.aipkit_chatUI_handleCompletion(a,s,e,n,o,t),toggleFullscreenAction:()=>window.aipkit_chatUI_toggleFullscreen(e,o,n),downloadTranscriptTxtAction:()=>window.aipkit_chatUI_downloadTranscriptActionTxt(e,n),downloadTranscriptPdfAction:()=>window.aipkit_chatUI_downloadTranscriptActionPdf(e,n),handlePlayAction:a=>window.aipkit_handlePlayAction(a)};if(n.requireConsentCompliance&&typeof window.aipkit_initConsentUI=="function"?o.consentUIInstance=window.aipkit_initConsentUI(e.mainContentEl,n,o,()=>{e.inputField.disabled=!1,t.setButtonStateAction("send",!1),t.focusInputAction(),e.voiceInputButton&&(e.voiceInputButton.disabled=!1),e.inputActionButton&&(e.inputActionButton.disabled=!1),e.webSearchToggleButton&&(e.webSearchToggleButton.disabled=!1),e.googleSearchGroundingToggleButton&&(e.googleSearchGroundingToggleButton.disabled=!1)}):n.requireConsentCompliance&&console.error(`AIPKit Chat Main (${i}): Consent required, but aipkit_initConsentUI function not found.`),n.imageUploadEnabledUI&&window.chatImageUpload&&typeof window.chatImageUpload.init=="function"?e.imageUploadInput&&e.imagePreviewContainer?(window.chatImageUpload.init(e.imageUploadInput,e.imagePreviewContainer),e.container&&e.container.classList.add("aipkit-image-upload-enabled")):console.warn(`AIPKit Chat UI Main (${i}): Image Upload UI enabled, but input or preview elements were not found/created by findElements.`):n.imageUploadEnabledUI&&console.warn(`AIPKit Chat UI Main (${i}): Image Upload UI enabled, but chatImageUpload script not found or init function missing.`),typeof window.aipkit_chatUI_setupInputActionButton=="function"?window.aipkit_chatUI_setupInputActionButton(e,n,o):(console.error(`AIPKit Chat Main (${i}): setupInputActionButton function not found.`),e.inputActionButton&&(e.inputActionButton.style.display="none"),e.inputActionMenu&&(e.inputActionMenu.style.display="none")),typeof window.aipkit_chatUI_attachEventListeners=="function"?window.aipkit_chatUI_attachEventListeners(e,n,o,t):console.error(`AIPKit Chat Main (${i}): attachEventListeners not defined.`),typeof window.aipkit_chatUI_initMessageActions=="function"?window.aipkit_chatUI_initMessageActions(e.messagesEl,n):console.warn(`AIPKit Chat Main (${i}): aipkit_chatUI_initMessageActions missing; message actions might not work.`),n.enableStarters&&e.startersContainer&&typeof window.aipkit_initConversationStarters=="function"){let a=o.consentUIInstance?o.consentUIInstance.isConsentGiven:()=>!n.requireConsentCompliance||o.consentGiven;window.aipkit_initConversationStarters(c,n,e,t.sendMessageAction,n.requireConsentCompliance,a)}else n.enableStarters&&console.warn(`AIPKit Chat Main (${i}): Starters enabled but container or init function missing.`);n.enableSidebar&&e.sidebarEl&&e.sidebarToggleBtn&&typeof window.aipkit_initConversationSidebar=="function"?window.aipkit_initConversationSidebar(c,e,n,t):n.enableSidebar&&console.warn(`AIPKit Chat Main (${i}): Sidebar enabled but elements or init function missing.`);let r={openPopup:n.popupEnabled&&typeof window.aipkit_chatUI_openPopup=="function"?()=>window.aipkit_chatUI_openPopup(c,e.messagesEl,e.inputField,o):()=>{},closePopup:n.popupEnabled&&typeof window.aipkit_chatUI_closePopup=="function"?()=>window.aipkit_chatUI_closePopup(c,o):()=>{},setupPopupHandlers:n.popupEnabled&&typeof window.aipkit_chatUI_setupPopupHandlers=="function"?(a,s)=>window.aipkit_chatUI_setupPopupHandlers(c,a,s,e.messagesEl,e.inputField,o,n):()=>{},isPopupOpen:()=>o.isPopupOpen,scrollToBottom:()=>window.aipkit_chatUI_scrollToBottom(e.messagesEl,!0),sendMessage:t.sendMessageAction,clearChat:t.clearChatAction,toggleFullscreen:t.toggleFullscreenAction};return n.enableRealtimeVoiceUI&&typeof window.aipkit_initRealtimeVoiceAgent=="function"?window.aipkit_initRealtimeVoiceAgent(e,n,o,t,r):n.enableRealtimeVoiceUI&&console.error(`AIPKit Chat Main (${i}): Realtime Voice enabled but aipkit_initRealtimeVoiceAgent function not found.`),typeof window.aipkit_chatUI_displayInitialMessage=="function"?window.aipkit_chatUI_displayInitialMessage(e.messagesEl,n):console.error(`AIPKit Chat Main (${i}): displayInitialMessage function not found.`),typeof window.aipkit_chatUI_finalizeSetup=="function"?window.aipkit_chatUI_finalizeSetup(e,n,o,t):console.error(`AIPKit Chat Main (${i}): finalizeSetup function not found.`),{publicApi:r,internalElements:e,internalActions:t}}window.aipkit_setupChatInstanceUI=N;(function(){"use strict";window.aipkit_current_conversation_uuid=null,window.aipkit_is_fresh_session=!0,window.aipkit_current_post_id=0,window.aipkit_current_openai_response_id=null,window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null;let c=localStorage.getItem("aipkit_guest_uuid");c||(c=("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,i=>(i^crypto.getRandomValues(new Uint8Array(1))[0]&15>>i/4).toString(16)),localStorage.setItem("aipkit_guest_uuid",c)),window.aipkit_guest_uuid=c,window.aipkit_regenerateConversationUUID=function(){let i=("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,o=>(o^crypto.getRandomValues(new Uint8Array(1))[0]&15>>o/4).toString(16));return sessionStorage.setItem("aipkit_current_conversation_uuid",i),window.aipkit_current_conversation_uuid=i,window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id"),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")),i},typeof window.aipkit_initializeMarkdownParser=="function"?window.aipkit_initializeMarkdownParser():(console.error("AIPKit Chat Init: markdown-it initializer (aipkit_initializeMarkdownParser) not found. Markdown parsing will be basic."),window.aipkit_md={render:function(i){return console.warn("AIPKit Chat Init: Using fallback markdown renderer because initializer was missing."),(window.aipkit_escapeHtml||function(t){return typeof t!="string"?"":t.replace(/&/g,"&").replace(/</g,"<").replace(/>/g,">").replace(/"/g,'\\"').replace(/'/g,"'")})(i).replace(/\n/g,"<br>")}});function n(i){if(!i||i.classList.contains("aipkit-initializing")||i.classList.contains("aipkit-initialized"))return;i.classList.add("aipkit-initializing");let o=i.getAttribute("data-bot-id"),t=i.getAttribute("data-config"),r=null;try{t&&(r=JSON.parse(t),o&&(r.botId=o))}catch(p){console.error(`AIPKit Chat Init (${o||"Unknown"}): Failed to parse configuration.`,p,t);let d=i.querySelector(".aipkit_chat_container")||i;d.innerHTML='<p style="color: red; text-align: center; padding: 20px;">Chatbot configuration error.</p>',i.classList.remove("aipkit-initializing");return}if(!r){console.error(`AIPKit Chat Init (${o||"Unknown"}): Config object is null after parse attempt.`,i);let p=i.querySelector(".aipkit_chat_container")||i;p.innerHTML='<p style="color: red; text-align: center; padding: 20px;">Chatbot config load error.</p>',i.classList.remove("aipkit-initializing");return}if(!r.botId&&o&&(r.botId=o),window.aipkit_current_post_id=r.postId||0,r.enableSidebar)window.aipkit_current_conversation_uuid=null,window.aipkit_is_fresh_session=!0,window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id"),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"));else{let p=sessionStorage.getItem("aipkit_current_conversation_uuid"),d=sessionStorage.getItem("aipkit_current_openai_response_id");if(p){if(window.aipkit_current_conversation_uuid=p,window.aipkit_is_fresh_session=!1,window.aipkit_current_openai_response_id=d||null,window.aipkit_current_openai_response_id)try{let u=localStorage.getItem(`aipkit_file_context_${p}`);if(u){let _=JSON.parse(u),f=!1;_&&_.provider&&(_.provider==="OpenAI"&&_.vector_store_id||_.provider==="Pinecone"&&_.index_name&&_.namespace||_.provider==="Qdrant"&&_.collection_name&&_.file_upload_context_id)&&(f=!0),f?(window.aipkit_active_file_context_provider=_.provider,window.aipkit_active_file_context_data=_,sessionStorage.setItem("aipkit_active_file_context_provider",window.aipkit_active_file_context_provider),sessionStorage.setItem("aipkit_active_file_context_data",JSON.stringify(window.aipkit_active_file_context_data)),document.dispatchEvent(new CustomEvent("aipkit:fileContextRestored",{detail:_}))):(console.warn(`AIPKit Chat Init (${r.botId}): Invalid file context data in localStorage for conv ${p}. Clearing. Data:`,_),localStorage.removeItem(`aipkit_file_context_${p}`),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared")))}else window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"))}catch(u){console.error("AIPKit Chat Init: Error loading file context from localStorage:",u),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"))}}else window.aipkit_current_conversation_uuid=null,window.aipkit_is_fresh_session=!0,window.aipkit_current_openai_response_id=null,sessionStorage.removeItem("aipkit_current_openai_response_id"),window.aipkit_active_file_context_provider=null,window.aipkit_active_file_context_data=null,sessionStorage.removeItem("aipkit_active_file_context_provider"),sessionStorage.removeItem("aipkit_active_file_context_data"),document.dispatchEvent(new CustomEvent("aipkit:fileContextCleared"))}if(typeof aipkit_setupChatInstanceUI!="function"){console.error(`AIPKit Chat Init (${r.botId}): UI setup function (aipkit_setupChatInstanceUI) not found.`);let p=i.querySelector(".aipkit_chat_container")||i;p.innerHTML='<p style="color: red; text-align: center; padding: 20px;">Chatbot script error.</p>',i.classList.remove("aipkit-initializing");return}let a=i.classList.contains("aipkit_chat_container")?i:i.querySelector(".aipkit_chat_container");if(!a){console.error(`AIPKit Chat Init (${r.botId}): Chat container element not found within wrapper.`,i),i.innerHTML='<p style="color: red; text-align: center; padding: 20px;">Chatbot structure error.</p>',i.classList.remove("aipkit-initializing");return}if(r.guestUUID=window.aipkit_guest_uuid,r.conversationUUID=window.aipkit_current_conversation_uuid,r.previousOpenAIResponseId=window.aipkit_current_openai_response_id,r.activeFileContextProvider=window.aipkit_active_file_context_provider,r.activeFileContextData=window.aipkit_active_file_context_data,!r.botId||!r.ajaxUrl||!r.text||!r.guestUUID){console.error(`AIPKit Chat Init (${r.botId||"Unknown"}): Missing essential configuration.`,r,i);let p=i.querySelector(".aipkit_chat_container")||i;p.innerHTML='<p style="color: red; text-align: center; padding: 20px;">Chatbot configuration error.</p>',i.classList.remove("aipkit-initializing");return}typeof window.aipkit_chatUI_applyCustomThemeStyles=="function"&&r.theme==="custom"&&r.customThemeSettings&&Object.keys(r.customThemeSettings).length>0?window.aipkit_chatUI_applyCustomThemeStyles(a,r.customThemeSettings):r.theme==="custom"&&console.warn(`AIPKit Chat Init (${r.botId}): Custom theme selected but aipkit_chatUI_applyCustomThemeStyles not found or no settings provided.`);let s=aipkit_setupChatInstanceUI(a,r);if(!s||!s.publicApi||!s.internalElements||!s.internalActions){console.error(`AIPKit Chat Init (${r.botId}): Failed to set up UI instance or get all necessary parts.`),i.classList.remove("aipkit-initializing");return}let l=s.publicApi;if(window.aipkitChatInstances||(window.aipkitChatInstances={}),window.aipkitChatInstances[a.id]={instance:l,elements:s.internalElements,actions:s.internalActions},r.popupEnabled){let p=i.querySelector(".aipkit_popup_trigger"),d=a.querySelector(".aipkit_chat_header"),u=d?d.querySelector(".aipkit_close_btn"):null;if(!p){console.error(`AIPKit Chat Init (${r.botId}): Popup trigger button not found.`),i.classList.remove("aipkit-initializing");return}if(l.setupPopupHandlers){l.setupPopupHandlers(p,u,r);let _=r.popupDelay;_>0&&!r.directVoiceMode&&!i.dataset.aipkitAutoOpened&&(i.dataset.aipkitAutoOpened="true",setTimeout(()=>{l&&l.isPopupOpen&&!l.isPopupOpen()&&l.openPopup()},_*1e3))}else console.error(`AIPKit Chat Init (${r.botId}): setupPopupHandlers method missing in UI instance.`)}i.classList.remove("aipkit-initializing"),i.classList.add("aipkit-initialized")}function e(){document.querySelectorAll(".aipkit_chat_container:not(.aipkit-initializing):not(.aipkit-initialized)").forEach(t=>{t.closest(".aipkit_popup_wrapper")||n(t)}),document.querySelectorAll(".aipkit_popup_wrapper:not(.aipkit-initializing):not(.aipkit-initialized)").forEach(n)}if(document.addEventListener("DOMContentLoaded",e),typeof MutationObserver=="function"){let i=new MutationObserver(o=>{let t=!1;o.forEach(r=>{r.addedNodes&&r.addedNodes.forEach(a=>{a.nodeType===1&&(a.matches&&(a.matches(".aipkit_chat_container:not(.aipkit_popup_content)")||a.matches(".aipkit_popup_wrapper")||a.matches('[id^="aipkit-chatbot-container-"]'))||a.querySelector&&a.querySelector(".aipkit_chat_container:not(.aipkit_popup_content), .aipkit_popup_wrapper, [id^='aipkit-chatbot-container-']"))&&(t=!0)})}),t&&(i.scanTimeout&&clearTimeout(i.scanTimeout),i.scanTimeout=setTimeout(e,50))});i.observe(document.body,{childList:!0,subtree:!0,attributes:!0})}else console.warn("AIPKit Chat Init: MutationObserver not supported; dynamically added chatbots might not initialize automatically.");window.aipkit_initializeChatInstance=n})();(function(){"use strict";window.aipkitAIFormsPublicState={currentAIFormEventSource:null,mdInstanceAIForms:null}})();(function(){"use strict";async function c(n,e,i){let o=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:l=>l,t=new FormData;t.append("action","aipkit_cache_sse_message"),t.append("_ajax_nonce",i);let r={stream_context:"ai_forms",form_id:n,user_input_values:e};t.append("message",JSON.stringify(r));let a=await fetch(aipkit_ai_forms_public_config.ajaxUrl,{method:"POST",body:t,credentials:"same-origin"});if(!a.ok){let l=await a.json().catch(()=>({}));throw new Error(l?.data?.message||`HTTP error ${a.status}`)}let s=await a.json();if(s.success&&s.data?.cache_key)return s.data.cache_key;throw new Error(s.data?.message||o("Failed to cache form data for streaming.","gpt3-ai-content-generator"))}window.aipkit_cacheAIFormMessage=c})();(function(){"use strict";function c(n,e){let i=window.aipkitAIFormsPublicState,o=n?n.closest(".aipkit-ai-form-wrapper"):null,t=n?n.querySelector(".aipkit_btn-text"):null,r=n?n.querySelector(".aipkit_spinner"):null,a=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:d=>d,s=null,l=()=>{n&&(n.disabled=!1,n.classList.remove("aipkit_btn-danger"),n.classList.add("aipkit_btn-primary"),t&&(t.textContent=e),s&&(n.removeEventListener("click",s),s=null)),r&&(r.style.display="none")};return{restoreGenerateButton:l,setupStopButton:()=>{n&&(n.disabled=!1,n.classList.remove("aipkit_btn-primary"),n.classList.add("aipkit_btn-danger"),t&&(t.textContent=o.dataset.labelStopButton||a("Stop","gpt3-ai-content-generator")),s=d=>{d.preventDefault(),d.stopPropagation(),i.currentAIFormEventSource&&(i.currentAIFormEventSource.close(),i.currentAIFormEventSource=null),l()},n.addEventListener("click",s,{once:!0}))}}}window.aipkitForms_createSseUiManager=c})();(function(){"use strict";function c(n){let e=n.elements,i=!1,o=null,t={},r={};for(let a of e){if(!a.name)continue;let s=a.name.match(/aipkit_form_field\[(.+?)\](\[\])?$/);if(!s||!s[1])continue;let l=s[1];s[2]==="[]"?(t[l]||(t[l]=[]),a.checked&&t[l].push(a.value)):a.type==="radio"?a.checked&&(t[l]=a.value):t[l]=a.value}for(let a of e){let s=a.closest("fieldset");if(s){let u=s.querySelector("legend");u&&(u.style.color="")}else a.style.borderColor="";if(!a.required)continue;let l=!1,p=a.name.match(/aipkit_form_field\[(.+?)\](\[\])?$/);if(!p||!p[1])continue;let d=p[1];if(!r[d]&&(a.type==="checkbox"?(l=!t[d]||t[d].length===0,r[d]=!0):a.type==="radio"?(l=!t[d],r[d]=!0):(a.classList.contains("aipkit-file-hidden-content")||a.type!=="file"&&a.type!=="submit"&&a.type!=="button")&&(l=a.value.trim()===""),l)){i=!0;let u=a;if(a.type==="radio"||a.type==="checkbox"?u=a.closest("fieldset"):a.classList.contains("aipkit-file-hidden-content")&&(u=n.querySelector(`.aipkit-file-upload-input[data-field-id="${d}"]`)),o||(o=u),u?.type!=="checkbox"&&u?.type!=="radio"&&u)u.style.borderColor="red";else if(u){let _=u.querySelector("legend");_&&(_.style.color="red")}}}return{isValid:!i,userInputs:t,firstInvalidField:o}}window.aipkitForms_validateSseInputs=c})();(function(){"use strict";let c=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:e=>e;function n(e,i){let o=window.aipkitAIFormsPublicState,t="",r=!0,a='<div class="aipkit-ai-form-results-top-actions"></div>',s='<div class="aipkit-ai-form-results-footer-actions"></div>',l=_=>`<div class="aipkit-ai-form-results-content">${_}</div>`;return{onMessageHandler:_=>{r&&(e.style.display="block",e.innerHTML=a+l("")+s,r=!1);let f=JSON.parse(_.data),w=e.querySelector(".aipkit-ai-form-results-content");f.delta&&w&&(t+=f.delta,o.mdInstanceAIForms?w.innerHTML=o.mdInstanceAIForms.render(t):w.innerHTML=t.replace(/\n/g,"<br />"),e.scrollTop=e.scrollHeight)},onDoneHandler:_=>{o.currentAIFormEventSource&&(o.currentAIFormEventSource.close(),o.currentAIFormEventSource=null),i();let f=e.querySelector(".aipkit-ai-form-results-content");o.mdInstanceAIForms&&f?f.innerHTML=o.mdInstanceAIForms.render(t):f&&(f.innerHTML=t.replace(/\n/g,"<br />"));let w=e.querySelector(".aipkit-ai-form-results-top-actions"),m=e.querySelector(".aipkit-ai-form-results-footer-actions");if(t.trim()!==""&&w&&m){let h=e.closest(".aipkit-ai-form-wrapper"),g=h.dataset.showSaveButton==="true",y=h.dataset.pdfDownloadEnabled==="true",b=h.dataset.showCopyButton==="true",I=window.aipkit_ai_forms_public_config||{},k=I.is_user_logged_in,S=document.createElement("button");if(S.type="button",S.className="aipkit-copy-results-btn",S.title=c("Copy Results","gpt3-ai-content-generator"),S.innerHTML='<span class="dashicons dashicons-admin-page"></span>',typeof window.aipkitForms_handleCopyAction=="function"&&S.addEventListener("click",window.aipkitForms_handleCopyAction),w.appendChild(S),S.style.display="inline-flex",g&&k){let A=h.dataset.labelSaveButton||I.text?.saveAsPost||c("Save","gpt3-ai-content-generator"),v=document.createElement("button");v.type="button",v.className="aipkit_btn aipkit_btn-secondary aipkit-save-as-post-btn",v.innerHTML=`<span class="aipkit_btn-text">${A}</span><span class="aipkit_spinner" style="display:none;"></span>`,typeof window.aipkitForms_handleSaveAsPost=="function"&&v.addEventListener("click",window.aipkitForms_handleSaveAsPost),m.appendChild(v),v.style.display="inline-flex"}if(y&&typeof window.aipkitForms_handleDownloadPdf=="function"){let A=h.dataset.labelDownloadButton||c("Download","gpt3-ai-content-generator"),v=document.createElement("button");v.type="button",v.className="aipkit_btn aipkit_btn-secondary aipkit-download-pdf-btn",v.innerHTML=`<span class="aipkit_btn-text">${A}</span>`,v.addEventListener("click",window.aipkitForms_handleDownloadPdf),m.appendChild(v),v.style.display="inline-flex"}if(b){let A=h.dataset.labelCopyButton||c("Copy","gpt3-ai-content-generator"),v=document.createElement("button");v.type="button",v.className="aipkit_btn aipkit_btn-secondary aipkit-copy-results-footer-btn",v.innerHTML=`<span class="aipkit_btn-text">${A}</span>`,typeof window.aipkitForms_handleCopyAction=="function"&&v.addEventListener("click",window.aipkitForms_handleCopyAction),m.appendChild(v),v.style.display="inline-flex"}}},onErrorHandler:_=>{if(o.currentAIFormEventSource===null)return;console.error("AI Form SSE Error:",_);let f=c(aipkit_ai_forms_public_config.text.error||"An error occurred.","gpt3-ai-content-generator");if(_.data)try{let w=JSON.parse(_.data);w.error&&(f=w.error)}catch{}e.style.display="block",e.innerHTML=`<p style="color:red;">${f}</p>`,o.currentAIFormEventSource&&(o.currentAIFormEventSource.close(),o.currentAIFormEventSource=null),i()}}}window.aipkitForms_createSseEventHandlers=n})();(function(){"use strict";async function c(n,e,i,o,t){let r=window.aipkitAIFormsPublicState,a=await window.aipkit_cacheAIFormMessage(n,e,i),s=new URL(aipkit_ai_forms_public_config.ajaxUrl);s.searchParams.append("action","aipkit_frontend_chat_stream"),s.searchParams.append("cache_key",a),s.searchParams.append("_ajax_nonce",i),window.aipkit_guest_uuid&&s.searchParams.append("session_id",window.aipkit_guest_uuid),r.currentAIFormEventSource=new EventSource(s.toString());let{onMessageHandler:l,onDoneHandler:p,onErrorHandler:d}=window.aipkitForms_createSseEventHandlers(o,t);r.currentAIFormEventSource.onmessage=l,r.currentAIFormEventSource.addEventListener("done",p),r.currentAIFormEventSource.onerror=d}window.aipkitForms_setupAndStartEventSource=c})();(function(){"use strict";function c(i,o,t="info"){if(!i)return;let r=window.aipkit_escapeHtml||function(a){return a};i.innerHTML=r(o),i.className=`aipkit-file-upload-status aipkit-status-${t}`}function n(i){if(!i)return;let o=i.querySelector(".aipkit-file-upload-input"),t=i.querySelector(".aipkit-file-upload-status"),r=i.querySelector(".aipkit-file-remove-btn"),a=i.querySelector(".aipkit-file-hidden-content"),s=i.querySelector(".aipkit-file-status-wrapper");o&&(o.value="",o.style.display="block"),t&&(t.innerHTML="",t.className="aipkit-file-upload-status"),r&&(r.style.display="none"),s&&(s.style.display="none"),a&&(a.value="",a.dispatchEvent(new Event("change",{bubbles:!0})))}async function e(i){let o=i.target,t=o.closest(".aipkit_form_group-file-upload");if(!t)return;let r=o.files[0],a=t.querySelector(".aipkit-file-status-wrapper"),s=t.querySelector(".aipkit-file-upload-status"),l=t.querySelector(".aipkit-file-remove-btn"),p=t.querySelector(".aipkit-file-hidden-content"),d=o.closest("form").querySelector('button[type="submit"]'),u=t.dataset.nonce,_=window.aipkit_ai_forms_public_config.ajaxUrl,f=window.wp?.i18n?.__||(g=>g),w=window.aipkit_escapeHtml||function(g){return g};if(!r){n(t);return}if(!["text/plain","application/pdf"].includes(r.type)){c(s,f("Invalid file type. Please use .txt or .pdf.","gpt3-ai-content-generator"),"error"),n(t);return}if(r.size>20*1024*1024){c(s,f("File is too large (max 20MB).","gpt3-ai-content-generator"),"error"),n(t);return}c(s,f("Uploading & processing...","gpt3-ai-content-generator"),"info"),a&&(a.style.display="flex"),d&&(d.disabled=!0);let h=new FormData;h.append("action","aipkit_ai_form_upload_and_parse_file"),h.append("_ajax_nonce",u),h.append("file",r);try{let g=await fetch(_,{method:"POST",body:h,credentials:"same-origin"}),y=await g.json();if(!g.ok||!y.success)throw new Error(y.data?.message||f("Failed to process file.","gpt3-ai-content-generator"));if(typeof y.data.text=="string")p.value=y.data.text,p.dispatchEvent(new Event("change",{bubbles:!0})),c(s,`\u2705 ${w(r.name)}`,"success"),o.style.display="none",l&&(l.style.display="inline-flex"),a&&(a.style.display="flex"),d&&(d.disabled=!1);else throw new Error(f("No text content was extracted from the file.","gpt3-ai-content-generator"))}catch(g){c(s,g.message,"error"),n(t),d&&(d.disabled=!1)}}window.aipkitForms_handleFileUpload=e,window.aipkitForms_resetFileUploadUI=n})();(function(){"use strict";function c(i){let o=i.innerHTML;i.innerHTML='<span class="dashicons dashicons-yes-alt aipkit-copy-success-icon"></span>',i.disabled=!0,setTimeout(()=>{i.innerHTML=o,i.disabled=!1},1500)}function n(i){let o=i.currentTarget,t=o.closest(".aipkit-ai-form-results");if(!t)return;let r=t.cloneNode(!0),a=r.querySelector(".aipkit-copy-results-btn");a&&a.remove();let s=r.innerText||r.textContent;navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(s).then(()=>{c(o)}).catch(l=>{console.error("Failed to copy text using Clipboard API: ",l),e(s,o)}):e(s,o)}function e(i,o){let t=document.createElement("textarea");t.value=i,t.style.position="fixed",t.style.top="-9999px",t.style.left="-9999px",document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("copy"),c(o)}catch(r){console.error("Fallback copy failed: ",r),alert("Failed to copy content.")}document.body.removeChild(t)}window.aipkitForms_handleCopyAction=n})();(function(){"use strict";async function c(n){let e=n.currentTarget,i=e.closest(".aipkit-ai-form-wrapper");if(!i)return;let o=i.querySelector(".aipkit-ai-form-results"),t=i.querySelector("h5.aipkit-ai-form-title"),r=i.dataset.saveAsPostNonce,a=o?o.querySelector(".aipkit-ai-form-results-content"):null;if(!a||!t){console.error("AI Forms Save: Missing results content container or title element.");return}let s=window.aipkit_ai_forms_public_config||{},l=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:f=>f,p=t.textContent.trim(),d=a.innerHTML,u=e.innerHTML;e.disabled=!0,e.innerHTML='<span class="aipkit_spinner" style="display:inline-block;"></span>';let _={action:"aipkit_ai_form_save_as_post",_ajax_nonce:r,post_title:p,post_content:d};try{let f=new FormData;for(let g in _)f.append(g,_[g]);let w=await fetch(s.ajaxUrl,{method:"POST",body:f,credentials:"same-origin"}),m=await w.json();if(!w.ok||!m.success)throw new Error(m.data?.message||l("Failed to save post.","gpt3-ai-content-generator"));e.innerHTML='<span class="dashicons dashicons-yes-alt" style="color: #38a569;"></span>',e.disabled=!0;let h=null;m.data.edit_link&&(h=document.createElement("a"),h.href=m.data.edit_link,h.innerHTML='<span class="dashicons dashicons-external"></span>',h.title=l("Edit Post","gpt3-ai-content-generator"),h.target="_blank",h.rel="noopener noreferrer",h.classList.add("aipkit_btn","aipkit_btn-icon","aipkit_btn-small","aipkit_btn-secondary"),h.style.marginLeft="10px",e.parentNode.insertBefore(h,e.nextSibling)),setTimeout(()=>{e.innerHTML=u,e.disabled=!1,h&&h.parentNode&&h.remove()},5e3)}catch(f){console.error("Failed to save post:",f),alert(`${l("Error saving post:","gpt3-ai-content-generator")} ${f.message}`),e.innerHTML=u,e.disabled=!1}}window.aipkitForms_handleSaveAsPost=c})();(function(){"use strict";async function c(n){n.preventDefault(),n.stopPropagation();let e=window.aipkitAIFormsPublicState,i=n.target,o=i.closest(".aipkit-ai-form-wrapper");if(!o)return;let t=o.dataset.formId,r=aipkit_ai_forms_public_config.ajaxNonce,a=o.querySelector(".aipkit-ai-form-results"),s=i.querySelector('button[type="submit"]'),l=s?s.querySelector(".aipkit_spinner"):null,p=s?s.querySelector(".aipkit_btn-text"):null,d=o.dataset.labelGenerateButton||"Generate",u=window.wp&&window.wp.i18n&&window.wp.i18n.__?window.wp.i18n.__:m=>m;if(!t||!r||!a||!s){console.error("AI Form SSE: Missing essential elements (formId, nonce, resultsDiv, submitButton)."),a&&(a.innerHTML='<p style="color:red;">Configuration error.</p>');return}let{restoreGenerateButton:_,setupStopButton:f}=window.aipkitForms_createSseUiManager(s,d);e.currentAIFormEventSource&&(e.currentAIFormEventSource.close(),e.currentAIFormEventSource=null),a.innerHTML="",a.style.display="none",s&&(s.disabled=!0),l&&(l.style.display="inline-block");let w=window.aipkitForms_validateSseInputs(i);if(!w.isValid){if(w.firstInvalidField)if(w.firstInvalidField.type!=="checkbox")w.firstInvalidField.style.borderColor="red";else{let m=w.firstInvalidField.closest(".aipkit_form-group")?.querySelector("label");m&&(m.style.color="red")}a.style.display="block",a.innerHTML=`<p style="color:orange;">${u("Please fill in all required fields.","gpt3-ai-content-generator")}</p>`,s&&(s.disabled=!1),l&&(l.style.display="none");return}f();try{await window.aipkitForms_setupAndStartEventSource(t,w.userInputs,r,a,_)}catch(m){console.error("AI Form Submission Error (SSE Setup):",m),a.innerHTML=`<p style="color:red;">${m.message||u(aipkit_ai_forms_public_config.text.error||"An error occurred.","gpt3-ai-content-generator")}</p>`,_()}}window.aipkit_handleFormSubmitSSE=c})();(function(){"use strict";function c(i,o){let t=window.aipkit_ai_forms_models||{},r=window.aipkit_ai_forms_public_config||{},a=i.toLowerCase(),s=t[a]||[],l=o.dataset.currentValue||"";if(r.allowed_models&&r.allowed_models.trim()!==""){let d=new Set(r.allowed_models.split(",").map(u=>u.trim()));if(Array.isArray(s))s=s.filter(u=>d.has(u.id));else{let u={};for(let _ in s){let f=s[_].filter(w=>d.has(w.id));f.length>0&&(u[_]=f)}s=u}}if(o.innerHTML="",!s||Array.isArray(s)&&s.length===0||!Array.isArray(s)&&Object.keys(s).length===0){let d=new Option("No models available for this provider.","");o.appendChild(d);return}let p=!1;if(Array.isArray(s))s.forEach(d=>{let u=new Option(d.name,d.id);d.id===l&&(u.selected=!0,p=!0),o.appendChild(u)});else{let d=["o1 models","o3 models","o4 models","gpt-3.5 models","gpt-4 models","gpt-5 models","fine-tuned models","others"],u=Object.keys(s);d.filter(f=>u.includes(f)).concat(u.filter(f=>!d.includes(f)).sort()).forEach(f=>{let w=document.createElement("optgroup");w.label=f,s[f].forEach(m=>{let h=new Option(m.name,m.id);m.id===l&&(h.selected=!0,p=!0),w.appendChild(h)}),o.appendChild(w)})}if(!p&&l){let d=new Option(`${l} (Manual)`,l,!1,!0);o.insertBefore(d,o.firstChild)}if(o.selectedIndex===-1&&o.options.length>0){let d=o.querySelector("optgroup");d&&d.options.length>0?o.value=d.options[0].value:o.options[0].value&&(o.selectedIndex=0)}}function n(i){let o=i.querySelector(".aipkit_aiform_provider_select"),t=i.querySelector(".aipkit_aiform_model_select");if(t)if(o)c(o.value,t),o.addEventListener("change",function(){c(this.value,t)});else{let r=t.dataset.provider;r?c(r,t):console.warn("AI Forms: Model select is present, but no provider information was found (missing data-provider attribute).")}}function e(){let i=window.aipkitAIFormsPublicState;if(typeof window.aipkit_handleFormSubmitSSE!="function"){console.error("AIPKit AI Forms Init: handleFormSubmitSSE is not defined.");return}document.querySelectorAll(".aipkit-ai-form-wrapper").forEach(t=>{n(t);let r=t.querySelector("form.aipkit-ai-form-main");r&&!r.dataset.sseInitialized&&(r.addEventListener("submit",window.aipkit_handleFormSubmitSSE),r.dataset.sseInitialized="true"),r&&!r.dataset.fileUploadInitialized&&(r.addEventListener("change",a=>{a.target.matches(".aipkit-file-upload-input")&&typeof window.aipkitForms_handleFileUpload=="function"&&window.aipkitForms_handleFileUpload(a)}),r.addEventListener("click",a=>{if(a.target.matches(".aipkit-file-remove-btn, .aipkit-file-remove-btn *")){let s=a.target.closest(".aipkit_form_group-file-upload");s&&typeof window.aipkitForms_resetFileUploadUI=="function"&&window.aipkitForms_resetFileUploadUI(s)}}),r.dataset.fileUploadInitialized="true")}),typeof window.markdownit=="function"?i.mdInstanceAIForms=window.markdownit({html:!1,xhtmlOut:!1,breaks:!0,linkify:!0,typographer:!0,quotes:"\u201C\u201D\u2018\u2019"}):(console.warn("AI Forms Public: markdown-it library not found."),i.mdInstanceAIForms={render:function(t){return(window.aipkit_escapeHtml||function(a){return a})(t).replace(/\n/g,"<br />")}})}window.aipkit_initAIFormsPublic=e})();(function(){"use strict";document.readyState==="loading"?document.addEventListener("DOMContentLoaded",window.aipkit_initAIFormsPublic):window.aipkit_initAIFormsPublic()})();(function(){"use strict";function c(n,e,i){let o=n.querySelector(`#${e}`);if(o&&o.offsetParent!==null)return o.value;{let t=n.querySelector(`input[type="hidden"][name="${i}"]`);return t?t.value:null}}window.aipkit_getSettingValue=c})();(function(){"use strict";function c(n,e,i){if(!e)return;e.innerHTML="";let o=[],t=window.aipkit_image_generator_config_public||{},r=n.toLowerCase(),a=i?new Set(i.split(",").map(l=>l.trim().toLowerCase())):null;if(r==="openai"&&t.openai_models?o=t.openai_models||[]:r==="google"&&t.google_models?o=t.google_models||{}:r==="azure"&&t.azure_models?o=t.azure_models||[]:r==="replicate"&&t.replicate_models&&(o=t.replicate_models||[]),a&&!a.has(r))if(o.image||o.video){let l={};o.image&&Array.isArray(o.image)&&(l.image=o.image.filter(p=>a.has(p.id))),o.video&&Array.isArray(o.video)&&(l.video=o.video.filter(p=>a.has(p.id))),o=l}else Array.isArray(o)&&(o=o.filter(l=>a.has(l.id)));else a&&a.has(r);if(!(o.image&&o.image.length>0||o.video&&o.video.length>0||Array.isArray(o)&&o.length>0))e.appendChild(new Option("(No models available)","")),e.disabled=!0;else{if(r==="openai")o.sort((l,p)=>{let d={"gpt-image-1":1,"dall-e-3":2,"dall-e-2":3};return(d[l.id]||99)-(d[p.id]||99)}),o.forEach(l=>{e.appendChild(new Option(l.name,l.id))});else if(r==="azure")o.forEach(l=>{let p=l.name||l.id;e.appendChild(new Option(p,l.id))});else if(r==="google"){if(o.image&&o.image.length>0){let l=document.createElement("optgroup");l.label="Image Models",o.image.sort((p,d)=>{let u=(p.name||p.id||"").toString().toLowerCase(),_=(d.name||d.id||"").toString().toLowerCase();return u.localeCompare(_)}),o.image.forEach(p=>{l.appendChild(new Option(p.name,p.id))}),e.appendChild(l)}if(o.video&&o.video.length>0){let l=document.createElement("optgroup");l.label="Video Models",o.video.forEach(p=>{l.appendChild(new Option(p.name,p.id))}),e.appendChild(l)}}else if(r==="replicate"){let l={};o.forEach(d=>{if(d&&d.name){let u=d.name.split("/"),_=u.length>1?u[0]:"other";l[_]||(l[_]=[]),l[_].push(d)}}),Object.keys(l).sort().forEach(d=>{let u=document.createElement("optgroup");u.label=d,l[d].sort((_,f)=>(_.name||"").localeCompare(f.name||"")),l[d].forEach(_=>{let f=_.name.replace(d+"/",""),w=new Option(f,_.id);u.appendChild(w)}),e.appendChild(u)})}e.disabled=!1,e.selectedIndex===-1&&(e.selectedIndex=0)}}window.aipkit_populatePublicModelsForProvider=c})();(function(){"use strict";function c(n){let e=n.target.closest(".aipkit-image-history-delete-btn");if(!e)return;n.preventDefault(),n.stopPropagation();let i=e.dataset.attachmentId;if(!i)return;let t=(window.aipkit_image_generator_config_public||{}).ajaxUrl||window.aipkit_dashboard?.ajaxurl,r=document.getElementById("aipkit_image_generator_public_nonce")?.value;if(!t||!r){alert("Error: Cannot delete image. Configuration missing.");return}let a=e.innerHTML;e.innerHTML='<span class="aipkit_spinner" style="display:inline-block;"></span>',e.disabled=!0;let s=new FormData;s.append("action","aipkit_delete_generated_image"),s.append("_ajax_nonce",r),s.append("attachment_id",i),fetch(t,{method:"POST",body:s,credentials:"same-origin"}).then(l=>l.json()).then(l=>{if(!l.success)throw new Error(l.data?.message||"Deletion failed.");let p=e.closest(".aipkit-image-history-item");p&&(p.style.transition="opacity 0.3s",p.style.opacity="0",setTimeout(()=>{p.remove();let d=document.querySelector(".aipkit-image-history-grid"),u=document.querySelector(".aipkit_image_history_section");if(d&&u&&d.children.length===0){let _=document.createElement("p");_.className="aipkit-image-history-empty",_.textContent="You have not generated any images yet.",u.appendChild(_),d.remove()}},300))}).catch(l=>{alert("Error deleting image: "+l.message),e.innerHTML=a,e.disabled=!1})}window.aipkit_handleDeleteImage=c})();(function(){"use strict";function c(){let i=document.getElementById("aipkit_public_image_generator");if(!i)return;let o=i.querySelector("#aipkit_public_image_prompt"),t=i.querySelector("#aipkit_public_image_results"),r=i.querySelector("#aipkit_public_generate_image_btn"),a=i.querySelector("#aipkit_image_generator_public_nonce"),s=window.aipkit_image_generator_config_public||{},l=s.text||{},p=s.ajaxUrl||window.aipkit_dashboard?.ajaxurl,d=a?a.value:null,u=window.aipkit_escapeHtml||function(k){return k};if(!o||!t||!r||!p||!d){console.error("AIPKit Image Gen (Public): Missing required elements or config for AJAX."),t.innerHTML='<p class="aipkit_image_results_message aipkit_message-error">Error: Configuration missing.</p>',t.style.display="grid";return}let _=window.aipkit_getSettingValue(i,"aipkit_public_image_provider","image_provider"),f=window.aipkit_getSettingValue(i,"aipkit_public_image_model","image_model"),w=o.value.trim(),m=!1,h=s.google_models&&typeof s.google_models=="object"?s.google_models:{};if(_.toLowerCase()==="google"&&h.video&&Array.isArray(h.video)?m=h.video.some(k=>k&&k.id===f):m=f.includes("veo"),!w)return;if(!_||!f){console.error("AIPKit Image Gen (Public): Missing required settings values (provider or model).",{provider:_,model:f}),t.innerHTML='<p class="aipkit_image_results_message aipkit_message-error">Error: Missing required image generation settings.</p>',t.style.display="grid";return}r.disabled=!0;let g=r.querySelector(".aipkit_btn-text"),y=r.querySelector(".aipkit_spinner"),b=g?g.textContent:l.generateButton||(m?"Generate Video":"Generate Image");g&&(g.textContent=l.generating||(m?"Generating Video...":"Generating...")),y&&(y.style.display="inline-block"),t.style.display="grid",t.innerHTML='<p class="aipkit_image_results_placeholder" style="text-align:center;"><span class="aipkit_spinner" style="display:inline-block;"></span></p>';let I=new FormData;I.append("action","aipkit_generate_image"),I.append("_ajax_nonce",d),I.append("prompt",w),I.append("provider",_),I.append("model",f),_.toLowerCase()==="openai"?(f==="dall-e-3"?(I.append("quality","standard"),I.append("style","vivid")):f==="gpt-image-1"&&I.append("output_format","png"),f!=="gpt-image-1"&&I.append("response_format","url")):_.toLowerCase()==="google"&&m&&(I.append("aspect_ratio","16:9"),I.append("person_generation","allow_all")),fetch(p,{method:"POST",body:I,credentials:"same-origin"}).then(k=>k.json()).then(k=>{if(!k.success){let S=k.data&&k.data.message?k.data.message:"Unknown generation error";throw new Error(S)}if(k.data.status==="processing"&&k.data.operation_name){n(k.data.operation_name,f,d,r,t,g,y,b,m,w,l,u);return}e(k.data,r,t,g,y,b,m,w,l,u)}).catch(k=>{console.error("AIPKit Image Generation Error (Public):",k),t.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">${l.error||"Error generating image:"} ${u(k.message||"Unknown error")}</p>`,r.disabled=!1,g&&(g.textContent=b),y&&(y.style.display="none")})}function n(i,o,t,r,a,s,l,p,d,u,_,f){let h=0;s&&(s.textContent=_.generatingVideo||"Generating Video..."),a.innerHTML='<p class="aipkit_image_results_placeholder" style="text-align:center;"><span class="aipkit_spinner" style="display:inline-block;"></span> Video generation in progress...</p>';function g(){if(h>=60){a.innerHTML='<p class="aipkit_image_results_message aipkit_message-error">Video generation timed out. Please try again.</p>',r.disabled=!1,s&&(s.textContent=p),l&&(l.style.display="none");return}h++;let y=Math.min(h/60*100,95);a.innerHTML=`<p class="aipkit_image_results_placeholder" style="text-align:center;">
        <span class="aipkit_spinner" style="display:inline-block;"></span> 
        Generating video... (${Math.round(y)}%)
      </p>`;let b=new FormData;b.append("action","aipkit_check_video_status"),b.append("_ajax_nonce",t),b.append("operation_name",i),b.append("model_id",o),b.append("prompt",u),fetch(window.aipkit_image_generator_config_public.ajaxUrl,{method:"POST",body:b,credentials:"same-origin"}).then(I=>I.json()).then(I=>{if(I.success)if(I.data.status==="completed")e(I.data,r,a,s,l,p,d,u,_,f);else if(I.data.status==="processing")setTimeout(g,5e3);else throw new Error(`Unknown status: ${I.data.status}`);else throw new Error(I.data?.message||"Status check failed")}).catch(I=>{console.error("AIPKit Video Status Check Error:",I),a.innerHTML=`<p class="aipkit_image_results_message aipkit_message-error">Video generation failed: ${f(I.message||"Unknown error")}</p>`,r.disabled=!1,s&&(s.textContent=p),l&&(l.style.display="none")})}setTimeout(g,5e3)}function e(i,o,t,r,a,s,l,p,d,u){let _=i.images||i.videos||[];if(_.length>0)t.innerHTML="",_.forEach(f=>{let w=document.createElement("div");w.className=l?"aipkit_video_result":"aipkit_image_result";let m="",h=f.media_library_url||f.url||null,g=l?d.viewFullVideo||"Click to view full video":d.viewFullImage||"Click to view full image";if(l)if(f.url){let y=`<video controls preload="metadata" style="max-width: 100%; height: auto;">
              <source src="${u(f.url)}" type="video/mp4">
              Your browser does not support the video tag.
            </video>`;h&&h!==f.url?m=`<a href="${u(h)}" target="_blank" rel="noopener noreferrer" title="${u(g)}">${y}</a>`:m=y}else m='<p class="aipkit_video_results_message aipkit_message-error">Error: No video data found.</p>';else{let y=f.url||(f.b64_json?`data:image/png;base64,${f.b64_json}`:null);if(y){let b=`<img src="${u(y)}" alt="${u(p)}">`;h?m=`<a href="${u(h)}" target="_blank" rel="noopener noreferrer" title="${u(g)}">${b}</a>`:m=b}else m='<p class="aipkit_image_results_message aipkit_message-error">Error: No image data found.</p>'}if(w.innerHTML=m,f.revised_prompt){let y=document.createElement("p");y.style.fontSize="11px",y.style.fontStyle="italic",y.style.marginTop="5px",y.textContent=`Revised: ${f.revised_prompt}`,w.appendChild(y)}t.appendChild(w)});else{let f=l?"videos":"images";t.innerHTML=`<p class="aipkit_image_results_message aipkit_message-info">${d.initialPlaceholder||`No ${f} returned. Try a different prompt.`}</p>`}o.disabled=!1,r&&(r.textContent=s),a&&(a.style.display="none")}window.aipkit_handlePublicImageGeneration=c})();(function(){"use strict";function c(n){let e=n.currentTarget;if(e.disabled)return;let i=e.closest("#aipkit_public_image_generator");if(!i)return;let t=(window.aipkit_image_generator_config_public||{}).ajaxUrl||window.aipkit_dashboard?.ajaxurl,r=i.querySelector("#aipkit_image_generator_public_nonce")?.value,a=i.querySelector(".aipkit-image-history-grid");if(!t||!r||!a){console.error("Image History Load More: Missing required elements or config.");return}let s=parseInt(e.dataset.currentPage,10)||1,l=parseInt(e.dataset.maxPages,10)||1,p=s+1;if(p>l)return;let d=e.querySelector(".aipkit_btn-icon-content"),u=e.querySelector(".aipkit_spinner");d&&(d.style.display="none"),u&&(u.style.display="inline-block"),e.disabled=!0;let _=new FormData;_.append("action","aipkit_load_more_image_history"),_.append("_ajax_nonce",r),_.append("page",p),fetch(t,{method:"POST",body:_,credentials:"same-origin"}).then(f=>f.json()).then(f=>{if(!f.success)throw new Error(f.data?.message||"Failed to load more images.");f.data.html&&a.insertAdjacentHTML("beforeend",f.data.html),e.dataset.currentPage=p,f.data.has_more||(e.style.display="none")}).catch(f=>{console.error("Image History Load More Error:",f)}).finally(()=>{d&&(d.style.display="inline-block"),u&&(u.style.display="none"),p<l?e.disabled=!1:e.style.display="none"})}window.aipkit_handleLoadMoreHistory=c})();(function(){"use strict";function c(){let n=document.getElementById("aipkit_public_image_generator");if(!n)return;let e=n.querySelector("#aipkit_public_generate_image_btn"),i=n.querySelector("#aipkit_public_image_results"),o=n.querySelector("#aipkit_public_image_provider"),t=n.querySelector("#aipkit_public_image_model"),r=n.dataset.allowedModels||"",a=n.querySelector(".aipkit-image-history-grid"),s=n.querySelector(".aipkit-image-history-load-more-btn");if(!e||!i){console.error("AIPKit Image Generator (Public): Could not find essential UI elements (button, results)."),i&&(i.innerHTML='<p class="aipkit_image_results_message aipkit_message-error">Error: Core UI elements missing.</p>'),i.style.display="grid";return}o&&t&&typeof window.aipkit_populatePublicModelsForProvider=="function"&&(window.aipkit_populatePublicModelsForProvider(o.value,t,r),o.addEventListener("change",()=>{window.aipkit_populatePublicModelsForProvider(o.value,t,r)})),e.dataset.listenerAttached!=="true"&&(e.addEventListener("click",window.aipkit_handlePublicImageGeneration),e.dataset.listenerAttached="true"),a&&a.addEventListener("click",window.aipkit_handleDeleteImage),s&&s.addEventListener("click",window.aipkit_handleLoadMoreHistory),i&&(i.style.display="none",i.innerHTML="")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",c):c(),window.aipkit_initPublicImageGenerator=c})();(function(){"use strict";function c(i,o,t,r){let a=window.aipkit_token_usage_config||{},s=a.text||{},l=document.createElement("div");l.className="aipkit-usage-details-table-container";let p=document.createElement("div");p.className="aipkit-usage-details-pagination-container",r.appendChild(l),r.appendChild(p),l.innerHTML=`<p style="text-align:center;"><span class="aipkit_spinner" style="display:inline-block;width:20px;height:20px;"></span> ${s.loadingDetails||"Loading details..."}</p>`;let d={action:"aipkit_get_token_usage_details",nonce:a.nonce,module:i,context_id:o,page:t},u=new FormData;for(let _ in d)u.append(_,d[_]);fetch(a.ajaxUrl,{method:"POST",body:u,credentials:"same-origin"}).then(_=>_.json()).then(_=>{if(!_.success)throw new Error(_.data?.message||"Failed to load data.");n(_.data.items,l),e(_.data.pagination,p,i,o,r)}).catch(_=>{console.error("Error fetching token usage details:",_),l.innerHTML=`<p style="color:red;text-align:center;">${s.errorLoading||"Error loading details."} (${_.message})</p>`})}function n(i,o){if(!i||i.length===0){o.innerHTML='<p style="text-align:center;">No detailed usage records found for this period.</p>';return}let t='<table class="aipkit_usage_details_table"><thead><tr><th>Date & Time</th><th>Tokens Used</th></tr></thead><tbody>';i.forEach(r=>{let s=new Date(r.timestamp*1e3).toLocaleString(void 0,{dateStyle:"medium",timeStyle:"short"});t+=`<tr><td>${s}</td><td>${r.tokens.toLocaleString()}</td></tr>`}),t+="</tbody></table>",o.innerHTML=t}function e(i,o,t,r,a){let{currentPage:s,totalPages:l}=i,p=window.aipkit_token_usage_config?.text||{};if(o.innerHTML="",l<=1)return;let d=document.createElement("button");d.className="aipkit_btn aipkit_btn-secondary aipkit_btn-small",d.textContent=p.previous||"Previous",d.disabled=s<=1,d.addEventListener("click",()=>c(t,r,s-1,a)),o.appendChild(d);let u=document.createElement("span");u.className="aipkit_pagination-current",u.textContent=`${p.pageLabel||"Page"} ${s} ${p.ofLabel||"of"} ${l}`,o.appendChild(u);let _=document.createElement("button");_.className="aipkit_btn aipkit_btn-secondary aipkit_btn-small",_.textContent=p.next||"Next",_.disabled=s>=l,_.addEventListener("click",()=>c(t,r,s+1,a)),o.appendChild(_)}document.addEventListener("click",function(i){let o=i.target.closest(".aipkit-usage-details-btn");if(!o||o.disabled)return;let t=o.closest("tr.aipkit-usage-main-row");if(!t)return;let r=t.nextElementSibling,a=r&&r.classList.contains("aipkit-usage-details-row");if(document.querySelectorAll(".aipkit-usage-details-row").forEach(s=>{if(s!==r){let l=s.previousElementSibling.querySelector(".aipkit-usage-details-btn");l&&l.classList.remove("aipkit-active"),s.remove()}}),a)r.remove(),o.classList.remove("aipkit-active");else{o.classList.add("aipkit-active");let s=document.createElement("tr");s.className="aipkit-usage-details-row";let l=document.createElement("td");l.colSpan=t.cells.length,l.className="aipkit-usage-details-cell";let p=document.createElement("div");p.className="aipkit-usage-details-content",l.appendChild(p),s.appendChild(l),t.parentNode.insertBefore(s,t.nextSibling);let d=o.dataset.module,u=o.dataset.contextId;c(d,u,1,p)}}),document.addEventListener("click",function(i){let o=i.target.closest(".aipkit_toggle_purchase_history");if(!o)return;i.preventDefault();let t=document.getElementById("aipkit_purchase_history_details");if(!t)return;o.getAttribute("aria-expanded")==="true"?(t.style.display="none",o.setAttribute("aria-expanded","false")):(t.style.display="block",o.setAttribute("aria-expanded","true"))})})();(function(){"use strict";function c(e){e.preventDefault();let i=e.target,o=i.querySelector(".aipkit_semantic_search_input"),t=i.querySelector(".aipkit_semantic_search_button"),r=i.closest(".aipkit_semantic_search_wrapper"),a=r.querySelector(".aipkit_semantic_search_results");if(!o||!t||!r||!a){console.error("Semantic Search: Missing required form elements.");return}let s=o.value.trim();if(!s)return;let l=window.aipkit_semantic_search_config||{},p=l.text||{};t.disabled=!0;let d=t.querySelector(".aipkit_spinner");d&&(d.style.display="inline-block"),a.innerHTML='<div class="aipkit-search-loading"><span class="aipkit_spinner"></span></div>';let u={query:s};window.aipkit_frontendApiRequest("aipkit_perform_semantic_search",u,l).then(_=>{a.innerHTML=_.html||`<p>${l.settings.no_results_text||"No results found."}</p>`}).catch(_=>{console.error("Semantic Search Error:",_),a.innerHTML=`<p class="aipkit-search-error">${p.error||"An error occurred while searching."}</p>`}).finally(()=>{t.disabled=!1,d&&(d.style.display="none")})}function n(){document.querySelectorAll(".aipkit_semantic_search_form").forEach(i=>{i.dataset.listenerAttached!=="true"&&(i.addEventListener("submit",c),i.dataset.listenerAttached="true")})}document.addEventListener("DOMContentLoaded",n),document.addEventListener("aipkit:contentLoaded",n)})();(function(){"use strict";function c(n,e,i){if(!n)return console.error("AIPKit ShowConsentBox: mainChatEl not found."),null;let o=n.querySelector(".aipkit_consent_overlay");if(!o){o=document.createElement("div"),o.className="aipkit_consent_overlay",o.innerHTML=`
                <h5 class="aipkit_consent_title">${e.text.consentTitle||"Consent Required"}</h5>
                <p class="aipkit_consent_message">${e.text.consentMessage||"Please agree to continue."}</p>
                <button type="button" class="aipkit_btn aipkit_btn-primary aipkit_consent_agree_btn">
                    ${e.text.consentButton||"I Agree"}
                </button>
            `;let t=n.querySelector(".aipkit_chat_input");t?n.insertBefore(o,t):n.appendChild(o);let r=o.querySelector(".aipkit_consent_agree_btn");r&&typeof i=="function"&&r.addEventListener("click",i)}return o.classList.remove("aipkit_hidden"),o}window.aipkit_chatUI_showConsentBox=c})();(function(){"use strict";function c(n){n&&n.classList.add("aipkit_hidden")}window.aipkit_chatUI_hideConsentBox=c})();(function(){"use strict";function c(n,e,i,o,t,r){n.consentGiven=!0,localStorage.setItem(e,"true"),typeof t=="function"&&r&&t(r);let a=o.closest("[data-bot-id]")?.dataset.botId||"unknown";typeof i=="function"&&i();let s=o.closest(".aipkit_chat_container");s&&s.dispatchEvent(new CustomEvent("aipkit:consentGiven"))}window.aipkit_chatUI_handleConsentAgree=c})();(function(){"use strict";function c(n,e,i,o){let t=e.botId,r=`aipkit_chatbot_consent_given_${t}`;i.consentGiven=localStorage.getItem(r)==="true";let a=null;function s(){typeof window.aipkit_chatUI_handleConsentAgree=="function"?window.aipkit_chatUI_handleConsentAgree(i,r,o,n,p,a):console.error(`AIPKit Consent UI Init (${t}): aipkit_chatUI_handleConsentAgree helper function not found.`)}function l(){typeof window.aipkit_chatUI_showConsentBox=="function"?a=window.aipkit_chatUI_showConsentBox(n,e,s):console.error(`AIPKit Consent UI Init (${t}): aipkit_chatUI_showConsentBox helper function not found.`)}function p(){a&&typeof window.aipkit_chatUI_hideConsentBox=="function"?window.aipkit_chatUI_hideConsentBox(a):a&&console.error(`AIPKit Consent UI Init (${t}): aipkit_chatUI_hideConsentBox helper function not found.`)}return e.requireConsentCompliance&&!i.consentGiven&&l(),{showConsentBoxIfNeeded:()=>e.requireConsentCompliance&&!i.consentGiven?(l(),!0):!1,isConsentGiven:()=>i.consentGiven}}window.aipkit_initConsentUI=c})();(function(){"use strict";function c(n,e){let{messagesEl:i}=n;if(!i||!e||!e.text){console.error("AIPKit Download PDF: Missing messages element or config.");return}if(typeof window.aipkit_chatUI_extractTextFromBubble!="function"||typeof window.aipkit_chatUI_generateDownloadFilename!="function"||typeof window.aipkit_chatUI_triggerBlobDownload!="function"){console.error("AIPKit Download PDF: One or more helper functions (extractText, generateFilename, triggerBlobDownload) not found."),alert("Error: Could not prepare PDF download.");return}if(typeof window.jspdf>"u"||typeof window.jspdf.jsPDF>"u"){console.error("AIPKit Download PDF: jsPDF library is not loaded."),alert(e.text.pdfError||"Could not generate PDF. jsPDF library might be missing.");return}let{jsPDF:o}=window.jspdf,t=new o,r=i.querySelectorAll(".aipkit_chat_message"),a=e?.headerName||"Bot",s=e.text.userPrefix||"User",l=e.text.errorPrefix||"Error",p=10,d=t.internal.pageSize.height,u=10,_=6,f=d-u*2,w=!1;if(t.setFontSize(16),t.text(`Chat Transcript - ${a}`,u,p),p+=_*2,t.setFontSize(12),r.forEach(h=>{let g=h.querySelector(".aipkit_chat_bubble");if(!g)return;let y=window.aipkit_chatUI_extractTextFromBubble(g),b="";if(h.classList.contains("aipkit_chat_message-user")?(b=`${s}:`,t.setFont(void 0,"bold")):h.classList.contains("aipkit_chat_message-bot")?(b=`${a}:`,t.setFont(void 0,"normal")):h.classList.contains("aipkit_chat_message-error")?(b=`${l}:`,t.setFont(void 0,"italic")):t.setFont(void 0,"normal"),b&&y){w=!0;let I=b,k=`${y}`;p+_>f+u&&(t.addPage(),p=u),t.text(I,u,p),p+=_,t.splitTextToSize(k,t.internal.pageSize.width-u*2).forEach(A=>{p+_>f+u&&(t.addPage(),p=u),t.text(A,u,p),p+=_}),p+=_/2,t.setFont(void 0,"normal")}}),!w){console.warn("AIPKit Chat Download PDF: No transcript content found."),alert(e.text.downloadEmpty||"Nothing to download.");return}let m=window.aipkit_chatUI_generateDownloadFilename(e,"pdf");try{t.save(m)}catch(h){console.error("AIPKit Download PDF: Error calling doc.save()",h),alert("An error occurred while generating the PDF.")}}window.aipkit_chatUI_downloadTranscriptActionPdf=c})();(function(){"use strict";function c(n){let i=n.currentTarget.closest(".aipkit-ai-form-wrapper"),o=i?i.querySelector(".aipkit-ai-form-results-content"):null,t=i?i.dataset.formId:"unknown";if(!o){console.error("AI Forms PDF: Results content div (.aipkit-ai-form-results-content) not found.");return}if(typeof window.jspdf>"u"||typeof window.jspdf.jsPDF>"u"){console.error("AI Forms PDF: jsPDF library is not loaded."),alert("Could not generate PDF. Required library is missing.");return}let{jsPDF:r}=window.jspdf,a=new r,s=o.innerText||o.textContent||"";if(!s.trim()){alert("Nothing to export.");return}let l=a.internal.pageSize.height,p=10,d=6,u=l-p*2,_=p;a.setFontSize(12),a.splitTextToSize(s,a.internal.pageSize.width-p*2).forEach(g=>{_+d>u+p&&(a.addPage(),_=p),a.text(g,p,_),_+=d});let w=new Date,m=`${w.getFullYear()}${String(w.getMonth()+1).padStart(2,"0")}${String(w.getDate()).padStart(2,"0")}`,h=`aiform-${t}-result-${m}.pdf`;a.save(h)}window.aipkitForms_handleDownloadPdf=c})();(function(){"use strict";let c='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-volume"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 8a5 5 0 0 1 0 8" /><path d="M17.7 5a9 9 0 0 1 0 14" /><path d="M6 15h-2a1 1 0 0 1 -1 -1v-4a1 1 0 0 1 1 -1h2l3.5 -4.5a.8 .8 0 0 1 1.5 .5v14a.8 .8 0 0 1 -1.5 .5l-3.5 -4.5" /></svg>',n='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-player-pause"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 5m0 1a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1z" /><path d="M14 5m0 1a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1z" /></svg>',e='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-alert-square-rounded"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c7.2 0 9 1.8 9 9s-1.8 9 -9 9s-9 -1.8 -9 -9s1.8 -9 9 -9z" /><path d="M12 8v4" /><path d="M12 16h.01" /></svg>';function i(t,r,a=null){if(t)switch(t.classList.remove("is-connecting","is-listening","is-speaking","is-error"),t.innerHTML="",r){case"connecting":t.classList.add("is-connecting");let s=document.createElement("span");s.className="aipkit_spinner",s.style.display="inline-block",t.appendChild(s),t.title=a||"Connecting...",t.disabled=!0;break;case"listening":t.classList.add("is-listening"),t.innerHTML=n,t.title=a||"Listening... (Click to stop)",t.disabled=!1;break;case"speaking":t.classList.add("is-speaking"),t.innerHTML=c,t.title=a||"AI is speaking... (Click to stop)",t.disabled=!1;break;case"error":t.classList.add("is-error"),t.innerHTML=e,t.title=a||"Error. Click to retry.",t.disabled=!1;break;case"idle":default:t.innerHTML=c,t.title=a||"Start Voice Conversation",t.disabled=!1;break}}function o(t,r){t.inputField&&(t.inputField.disabled=r),t.actionButton&&(t.actionButton.disabled=r),t.inputActionButton&&(t.inputActionButton.disabled=r),t.voiceInputButton&&(t.voiceInputButton.disabled=r)}window.aipkit_realtimeUIHandler={setButtonState:i,toggleMainInputs:o}})();(function(){"use strict";async function c(i){try{let o=await navigator.mediaDevices.getUserMedia({audio:!0});return o.getTracks().forEach(t=>i.addTrack(t,o)),o}catch(o){throw console.error("Error getting user media:",o),o}}function n(i){let o=document.createElement("audio");return o.autoplay=!0,i.ontrack=t=>{t.streams&&t.streams[0]&&(o.srcObject=t.streams[0])},o}function e(i){i&&i.getTracks().forEach(o=>o.stop())}window.aipkit_realtimeAudioHandler={startLocalStream:c,setupRemoteStream:n,stopLocalStream:e}})();(function(){"use strict";async function c(n,e,i){let o=i.createDataChannel("aipkit-events"),t={userTranscript:"",botTranscript:""},r=async a=>{let s=a?.usage||null;if(!t.userTranscript&&!t.botTranscript)return;let l={user_transcript:t.userTranscript,bot_transcript:t.botTranscript,usage_data:s?JSON.stringify(s):null};try{await window.aipkit_frontendApiRequest("aipkit_log_realtime_session_turn",l,e)}catch(p){console.error("AIPKit Realtime: Failed to log session turn.",p)}finally{t={userTranscript:"",botTranscript:""}}};o.onopen=()=>console.log("AIPKit Realtime: Data channel opened."),o.onmessage=a=>{try{let s=JSON.parse(a.data);s.type==="input.transcription"&&s.transcription&&(t.userTranscript+=s.transcription.trim()+" "),s.type==="response.done"&&s.response&&(s.response.output&&s.response.output[0]&&s.response.output[0].content&&s.response.output[0].content[0]&&s.response.output[0].content[0].transcript&&(t.botTranscript=s.response.output[0].content[0].transcript),r(s.response))}catch(s){console.error("AIPKit Realtime: Error processing message from server:",a.data,s)}},o.onclose=()=>console.log("AIPKit Realtime: Data channel closed."),o.onerror=a=>console.error("AIPKit Realtime: Data channel error:",a);try{let a=await i.createOffer();await i.setLocalDescription(a);let s=e.realtimeModel||"gpt-4o-realtime-preview",l=await fetch(`https://api.openai.com/v1/realtime?model=${s}`,{method:"POST",body:a.sdp,headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/sdp"}});if(!l.ok){let d=await l.text();throw new Error(`SDP exchange failed with status ${l.status}: ${d}`)}let p={type:"answer",sdp:await l.text()};return await i.setRemoteDescription(p),o}catch(a){throw console.error("AIPKit Realtime: WebRTC connection failed.",a),i&&i.connectionState!=="closed"&&i.close(),a}}window.aipkit_realtimeConnector={connect:c}})();(function(){"use strict";let c={peerConnection:null,localStream:null,remoteAudioElement:null,dataChannel:null,isSessionActive:!1,currentBotId:null,elements:null,config:null,mainUIState:null,uiInstance:null};async function n(t){t&&(t.preventDefault(),t.stopPropagation()),c.isSessionActive?i():await e()}async function e(){if(c.config.requireConsentCompliance&&!c.mainUIState.consentGiven&&!c.config.directVoiceMode){console.warn(`AIPKit Realtime (${c.config.botId}): Cannot start session, consent required. Opening popup.`),c.uiInstance&&typeof c.uiInstance.openPopup=="function"&&c.uiInstance.openPopup();return}if(!window.aipkit_current_conversation_uuid)if(typeof window.aipkit_regenerateConversationUUID=="function")window.aipkit_regenerateConversationUUID();else{console.error("AIPKit Realtime: Cannot start session, aipkit_regenerateConversationUUID function is missing.");let l=c.elements.triggerButton,p=c.elements.container.querySelector(".aipkit_realtime_voice_agent_btn"),d=c.config.directVoiceMode?l:p;window.aipkit_realtimeUIHandler.setButtonState(d,"error","Error: Cannot create session ID.");return}window.aipkit_is_fresh_session=!1;let t=c.elements.triggerButton,r=c.elements.container.querySelector(".aipkit_realtime_voice_agent_btn"),a=c.config.directVoiceMode?t:r,{...s}=c.elements;window.aipkit_realtimeUIHandler.setButtonState(a,"connecting"),c.config.directVoiceMode||window.aipkit_realtimeUIHandler.toggleMainInputs(s,!0);try{let p=(await window.aipkit_frontendApiRequest("aipkit_create_realtime_session",{bot_id:c.currentBotId},c.config))?.client_secret?.value;if(!p)throw new Error("Could not retrieve a session key from the server.");let d=new RTCPeerConnection;c.peerConnection=d,c.remoteAudioElement=window.aipkit_realtimeAudioHandler.setupRemoteStream(d),c.localStream=await window.aipkit_realtimeAudioHandler.startLocalStream(d);let u=await window.aipkit_realtimeConnector.connect(p,c.config,d);c.dataChannel=u,d.onconnectionstatechange=()=>{(d.connectionState==="disconnected"||d.connectionState==="closed"||d.connectionState==="failed")&&i("Connection lost.")},c.isSessionActive=!0,window.aipkit_realtimeUIHandler.setButtonState(a,"listening");let _=c.config.text?.initialGreeting;if(_&&typeof window.aipkit_handlePlayAction=="function"&&c.config.ttsEnabled){let f=document.createElement("button"),w='<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-player-play"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 4v16l13 -8z" /></svg>';f.className="aipkit_action_btn aipkit_play_btn",f.innerHTML=w;let m=document.createElement("div");m.setAttribute("data-raw-text",_);let h=document.createElement("div");h.appendChild(m),h.appendChild(f),window.aipkit_handlePlayAction(f)}}catch(l){console.error("AIPKit Realtime: Failed to start session.",l),i(`Error: ${l.message||"Could not connect."}`,!0)}}function i(t=null,r=!1){c.peerConnection&&(c.peerConnection.close(),c.peerConnection=null),c.localStream&&(window.aipkit_realtimeAudioHandler.stopLocalStream(c.localStream),c.localStream=null),c.remoteAudioElement&&(c.remoteAudioElement.srcObject=null,c.remoteAudioElement=null),c.currentAudio&&typeof window.aipkit_tts_stopCurrentAudio=="function"&&window.aipkit_tts_stopCurrentAudio(),c.isSessionActive=!1;let a=c.elements.triggerButton,s=c.elements.container.querySelector(".aipkit_realtime_voice_agent_btn"),l=c.config.directVoiceMode?a:s,{...p}=c.elements;window.aipkit_realtimeUIHandler.setButtonState(l,r?"error":"idle",t),c.config.directVoiceMode||window.aipkit_realtimeUIHandler.toggleMainInputs(p,!1)}function o(t,r,a,s,l){let p=t.container.querySelector(".aipkit_realtime_voice_agent_btn"),d=t.container.closest(".aipkit_popup_wrapper"),u=d?d.querySelector(".aipkit_popup_trigger"):null;!p||!u&&r.popupEnabled||(c.uiInstance=l,c.mainUIState=a,c.config=r,c.elements={...t,triggerButton:u},c.currentBotId=r.botId,r.directVoiceMode&&u?(u.addEventListener("click",n),p.style.display="none"):p.addEventListener("click",n))}window.aipkit_initRealtimeVoiceAgent=o})();})();
