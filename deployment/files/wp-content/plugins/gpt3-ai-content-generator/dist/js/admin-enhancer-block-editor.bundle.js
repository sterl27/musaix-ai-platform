(()=>{(function(){"use strict";let e=window.wp;if(!e||!e.richText||!e.components||!e.element||!e.i18n||!e.blockEditor||!e.blocks||!e.data){console.error("AIPKit Block Editor Enhancer: One or more required WordPress script dependencies are missing.");return}let{registerFormatType:le,insert:ae,getTextContent:q,slice:G,applyFormat:de}=e.richText,{ToolbarGroup:pe,ToolbarDropdownMenu:ue}=e.components,{BlockControls:fe}=e.blockEditor,{__:c}=e.i18n,{createElement:A,Fragment:ke}=e.element,D=!1;function J(){try{return e.data.select("core/editor").getCurrentPostType()||"post"}catch{return"post"}}function Y(s){return`aipkit_enhancer_recent_${s}`}function j(s){try{let r=localStorage.getItem(Y(s));return r?JSON.parse(r):[]}catch{return[]}}function ge(s,r){try{localStorage.setItem(Y(s),JSON.stringify(r))}catch{}}function z(s){let r=J(),_=j(r).filter(y=>y!==s);_.unshift(s),ge(r,_.slice(0,5))}let Q="aipkit-assistant-notice";function a(s,r,_={}){try{e.data.dispatch("core/notices").removeNotice(Q)}catch{}e.data.dispatch("core/notices").createNotice(s,r,{id:Q,isDismissible:!0,type:"snackbar",..._})}async function W(s,r,_,y,w){let C=q(G(s));if(!C){a("warning",c("Please select some text to process.","gpt3-ai-content-generator"));return}let B=s,d=null,S=null,R=null;try{let p=e.data.select("core/block-editor");d=p.getSelectedBlockClientId(),S=d?p.getBlockRootClientId(d):void 0,R=d!=null?p.getBlockIndex(d,S):void 0}catch{}D=!0,a("info",c("Processing...","gpt3-ai-content-generator"),{isDismissible:!1});let M=window.aipkit_post_enhancer?.nonce_process_text;if(!M){a("error",c("An error occurred: Security token missing.","gpt3-ai-content-generator"));return}let P=_.replace("%s",C);try{let $=function(){let t=0;for(let n=f.length-1;n>=0&&f[n]===`
`;n--)t++;t===0?f+=`
`:t>1&&(f=f.slice(0,f.length-(t-1)))},Z=function(t){if(t.nodeType===Node.TEXT_NODE){f+=t.nodeValue;return}if(t.nodeType===Node.ELEMENT_NODE){let n=t.tagName;if(n==="BR"){f+=`
`;return}let m=f.length;for(let g of Array.from(t.childNodes))Z(g);let u=f.length,i=he[n];i&&m!==u&&v.push({type:i,start:m,end:u}),(n==="LI"||me.has(n))&&$();return}},p=await window.aipkit_apiRequest("aipkit_process_enhancer_text",{_ajax_nonce:M,text_to_process:C,final_prompt:P});if(!p.text)throw new Error("AI did not return any text.");let o=window.aipkit_post_enhancer?.parse_html_formats!==void 0?!!window.aipkit_post_enhancer.parse_html_formats:!0,N=p.text;if(/(^\s{0,3}#{1,6}\s)|(^\s{0,3}[-*+]\s)|(```[\s\S]*?```)|(__|\*\*)|(_|\*)/m.test(N)&&typeof window.aipkit_getMarkdownRenderer=="function")try{let t=window.aipkit_getMarkdownRenderer();t&&(N=t.render(N))}catch(t){console.warn("AIPKit: markdown render failed",t)}let X=document.createElement("div");if(X.innerHTML=N,/<\s*(h1|h2|h3|h4|h5|h6|p|ul|ol|li|blockquote|pre)\b/i.test(N))try{let t=typeof e.blocks.rawHandler=="function"?e.blocks.rawHandler({HTML:N}):e.blocks.parse(N),n=e.data.select("core/block-editor"),m=e.data.dispatch("core/block-editor"),u=n.getSelectedBlockClientId(),i=u?n.getBlockRootClientId(u):void 0,g=u!=null?n.getBlockIndex(u,i):void 0,ne=g!=null?g+1:void 0,oe=g??void 0,O=u?n.getBlock(u):null,_e=O&&O.name==="core/freeform",H=(n.getBlocks(i)||[]).map(l=>l.clientId),U=(y&&["replace","after","before"].includes(y)?y:null)||window.aipkit_post_enhancer&&window.aipkit_post_enhancer.default_insert_position||"replace",ce=l=>{let T=!0;(()=>{let k=[];T&&k.push({label:c("Undo","gpt3-ai-content-generator"),url:"#",className:"is-link is-small",onClick:h=>{h&&h.preventDefault&&h.preventDefault();try{l.length&&e.data.dispatch("core/block-editor").removeBlocks(l,i);try{d&&e.data.dispatch("core/block-editor").selectBlock(d)}catch{}setTimeout(()=>r(B),0),T=!1,a("success",c("Changes reverted.","gpt3-ai-content-generator"))}catch{}}}),a("success",c("Text updated successfully!","gpt3-ai-content-generator"),{actions:k})})()};if(_e){if(U==="replace"){let k=O,h=g??0;m.replaceBlocks(u,t);let b=(n.getBlocks(i)||[]).map(I=>I.clientId).filter(I=>!H.includes(I)),x=!0;(()=>{let I=[];x&&I.push({label:c("Undo","gpt3-ai-content-generator"),url:"#",className:"is-link is-small",onClick:E=>{E&&E.preventDefault&&E.preventDefault();try{b.length&&e.data.dispatch("core/block-editor").removeBlocks(b,i),e.data.dispatch("core/block-editor").insertBlocks(k,h,i);try{let re=e.data.select("core/block-editor").getBlockOrder(i),ie=re&&typeof h=="number"?re[h]:null;ie&&e.data.dispatch("core/block-editor").selectBlock(ie)}catch{}setTimeout(()=>r(B),0),x=!1,a("success",c("Changes reverted.","gpt3-ai-content-generator"))}catch{}}}),a("success",c("Text updated successfully!","gpt3-ai-content-generator"),{actions:I})})();return}let l=U==="before"?oe:ne;m.insertBlocks(t,l,i);let L=(n.getBlocks(i)||[]).map(k=>k.clientId).filter(k=>!H.includes(k));ce(L);return}if(U==="replace"&&u){let l=O,T=g??0;m.replaceBlocks(u,t);let k=(n.getBlocks(i)||[]).map(b=>b.clientId).filter(b=>!H.includes(b)),h=!0;(()=>{let b=[];h&&b.push({label:c("Undo","gpt3-ai-content-generator"),url:"#",className:"is-link is-small",onClick:x=>{x&&x.preventDefault&&x.preventDefault();try{k.length&&e.data.dispatch("core/block-editor").removeBlocks(k,i),e.data.dispatch("core/block-editor").insertBlocks(l,T,i);try{let I=e.data.select("core/block-editor").getBlockOrder(i),E=I&&typeof T=="number"?I[T]:null;E&&e.data.dispatch("core/block-editor").selectBlock(E)}catch{}setTimeout(()=>r(B),0),h=!1,a("success",c("Changes reverted.","gpt3-ai-content-generator"))}catch{}}}),a("success",c("Text updated successfully!","gpt3-ai-content-generator"),{actions:b})})();return}let ye=U==="before"?oe:ne;m.insertBlocks(t,ye,i);let we=(n.getBlocks(i)||[]).map(l=>l.clientId).filter(l=>!H.includes(l));ce(we);try{w&&z(w)}catch{}return}catch(t){console.warn("AIPKit: Failed to insert blocks, falling back to inline text.",t)}let he={STRONG:"core/bold",B:"core/bold",EM:"core/italic",I:"core/italic",U:"core/text-highlight"},me=new Set(["P","H1","H2","H3","H4","H5","H6","BLOCKQUOTE","PRE"]),f="",v=[];for(let t of Array.from(X.childNodes))Z(t);let ee=s.start,F=ae(s,f);o&&v.length&&v.forEach(t=>{try{F=de(F,{type:t.type},ee+t.start,ee+t.end)}catch(n){console.warn("AIPKit formatting apply failed",n)}}),r(F);let be=B,te=!0,Ie=()=>{let t=[];te&&t.push({label:c("Undo","gpt3-ai-content-generator"),url:"#",className:"is-link is-small",onClick:n=>{n&&n.preventDefault&&n.preventDefault();try{try{d&&e.data.dispatch("core/block-editor").selectBlock(d)}catch{}setTimeout(()=>r(be),0),te=!1,a("success",c("Changes reverted.","gpt3-ai-content-generator"))}catch{}}}),a("success",c("Text updated successfully!","gpt3-ai-content-generator"),{actions:t})};try{w&&z(w)}catch{}Ie()}catch(p){console.error("AIPKit Block Editor Enhancer Error:",p),a("error",c("An error occurred:","gpt3-ai-content-generator")+" "+p.message)}finally{D=!1}}le("aipkit/assistant-format",{title:c("Content Assistant","gpt3-ai-content-generator"),tagName:"span",className:"aipkit-assistant-placeholder-format",edit:({value:s,onChange:r,isActive:_})=>{let w=(window.aipkit_post_enhancer||{}).actions||[],C=J(),B=j(C),d={};(w||[]).forEach(o=>{o&&o.id&&(d[o.id]=o)});let S=B.map(o=>d[o]).filter(Boolean),R=S.length?[{title:c("Recent","gpt3-ai-content-generator"),isDisabled:!0,className:"aipkit-menu-header"},...S.map(o=>({title:c(o.label,"gpt3-ai-content-generator"),onClick:()=>W(s,r,o.prompt,o.insert_position||null,o.id)}))]:[],M=(w||[]).filter(o=>o&&o.label&&o.prompt&&!B.includes(o.id)),P=[{title:c("All Actions","gpt3-ai-content-generator"),isDisabled:!0,className:"aipkit-menu-header"},...M.map(o=>({title:c(o.label,"gpt3-ai-content-generator"),onClick:()=>W(s,r,o.prompt,o.insert_position||null,o.id)}))],p=R.length?[R,P]:[P];return A(ke,null,A(fe,null,A(pe,null,A(ue,{icon:()=>A("span",{style:{fontSize:"16px",display:"inline-block",lineHeight:"1"}},D?"\u23F3":"\u270D\uFE0F"),label:c("AIP Content Assistant","gpt3-ai-content-generator"),controls:p,isDisabled:!q(G(s))||D,className:"aipkit-content-assistant-menu"}))))}})})();})();
